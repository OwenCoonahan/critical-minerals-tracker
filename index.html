<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Critical Minerals Tracker | U.S. Dependency & Global Supply Chain Analysis</title>
<meta name="description" content="Interactive dashboard tracking U.S. critical mineral dependencies, global supply chains, and geopolitical risk factors.">
<meta property="og:title" content="Critical Minerals Tracker">
<meta property="og:description" content="U.S. Dependency & Global Supply Chain Analysis — 14 critical minerals, real data from USGS 2024/2025">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3.1.0/dist/topojson-client.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --font-sans: 'Geist', -apple-system, sans-serif;
  --font-mono: 'Geist Mono', ui-monospace, monospace;
  --radius: 10px;
  --radius-lg: 14px;
}

[data-theme="dark"]{
  --bg: #09090b;
  --bg-elevated: #0f0f12;
  --surface: #131316;
  --surface-hover: #1a1a1f;
  --border: #27272a;
  --border-hover: #3f3f46;
  --text: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --accent: #3b82f6;
  --red: #ef4444;
  --red-muted: rgba(239,68,68,.12);
  --orange: #f59e0b;
  --orange-muted: rgba(245,158,11,.12);
  --green: #22c55e;
  --green-muted: rgba(34,197,94,.12);
  --chart-grid: #1e1e22;
  --backdrop: rgba(0,0,0,.5);
}

[data-theme="light"]{
  --bg: #ffffff;
  --bg-elevated: #fafafa;
  --surface: #ffffff;
  --surface-hover: #f4f4f5;
  --border: #e4e4e7;
  --border-hover: #d4d4d8;
  --text: #09090b;
  --text-secondary: #52525b;
  --text-muted: #a1a1aa;
  --accent: #2563eb;
  --red: #dc2626;
  --red-muted: rgba(220,38,38,.08);
  --orange: #d97706;
  --orange-muted: rgba(217,119,6,.08);
  --green: #16a34a;
  --green-muted: rgba(22,163,74,.08);
  --chart-grid: #f0f0f2;
  --backdrop: rgba(0,0,0,.3);
}

body{
  font-family:var(--font-sans);
  background:var(--bg);
  color:var(--text);
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background .2s, color .2s;
}

/* Header */
.header{
  border-bottom:1px solid var(--border);
  padding:1.5rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1400px;
  margin:0 auto;
}
.header-left h1{
  font-size:1.25rem;
  font-weight:600;
  letter-spacing:-.02em;
  color:var(--text);
}
.header-left p{
  color:var(--text-muted);
  font-size:.8125rem;
  margin-top:.125rem;
  font-weight:400;
}
.header-right{display:flex;align-items:center;gap:.75rem}
.last-updated{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
  padding:.25rem .625rem;
  border:1px solid var(--border);
  border-radius:var(--radius);
  white-space:nowrap;
}
.theme-toggle{
  width:36px;height:36px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
  flex-shrink:0;
}
.theme-toggle:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.theme-toggle svg{width:16px;height:16px}

/* Pills */
.pills-wrap{
  padding:.75rem 2rem;
  display:flex;
  flex-wrap:wrap;
  gap:.375rem;
  border-bottom:1px solid var(--border);
  max-width:1400px;
  margin:0 auto;
  align-items:center;
}
.pill{
  padding:.375rem .75rem;
  border-radius:999px;
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid transparent;
  background:transparent;
  color:var(--text-muted);
  transition:all .15s;
  white-space:nowrap;
}
.pill:hover{color:var(--text);background:var(--surface-hover)}
.pill.active{
  background:var(--text);
  color:var(--bg);
  border-color:var(--text);
}
.pill.section-pill{font-weight:600}
.pill-separator{
  width:1px;height:20px;background:var(--border);margin:0 .25rem;align-self:center;
}

/* Container */
.container{max-width:1400px;margin:0 auto;padding:2rem}

/* Overview */
.overview-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.overview-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.legend{display:flex;gap:1rem;font-size:.75rem;color:var(--text-muted)}
.legend span{display:flex;align-items:center;gap:.375rem}
.legend-dot{width:8px;height:8px;border-radius:50%}
.legend-dot.red{background:var(--red)}
.legend-dot.yellow{background:var(--orange)}
.legend-dot.green{background:var(--green)}

/* Overview Grid */
.overview-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:.75rem;
}
.mineral-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  cursor:pointer;
  transition:all .15s;
  position:relative;
}
.mineral-card:hover{
  border-color:var(--border-hover);
  background:var(--surface-hover);
}
.mc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
.mc-name{font-size:.875rem;font-weight:600;letter-spacing:-.01em}
.mc-badge{
  font-family:var(--font-mono);
  font-size:.6875rem;
  font-weight:500;
  padding:.2rem .5rem;
  border-radius:999px;
  letter-spacing:.01em;
}
.mc-badge.high{background:var(--red-muted);color:var(--red)}
.mc-badge.med{background:var(--orange-muted);color:var(--orange)}
.mc-badge.low{background:var(--green-muted);color:var(--green)}

.mc-import{
  font-family:var(--font-mono);
  font-size:2rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
  margin-bottom:.25rem;
}
.mc-import.high{color:var(--red)}
.mc-import.med{color:var(--orange)}
.mc-import.low{color:var(--green)}

.mc-sublabel{font-size:.75rem;color:var(--text-muted);margin-bottom:1rem}

.mc-row{display:flex;justify-content:space-between;font-size:.8125rem;padding:.25rem 0}
.mc-row+.mc-row{border-top:1px solid var(--border)}
.mc-label{color:var(--text-muted)}
.mc-val{font-family:var(--font-mono);font-weight:500;font-size:.8125rem}

/* Detail View */
.detail{display:none}
.detail.active{display:block}
.detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2rem;
}
.detail-header h2{font-size:1.25rem;font-weight:600;letter-spacing:-.02em}
.back-btn{
  padding:.5rem .875rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  font-family:var(--font-sans);
  transition:all .15s;
}
.back-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}

/* Stat Cards */
.stats-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:.75rem;
  margin-bottom:2rem;
}
.stat-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.stat-label{
  font-size:.75rem;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:.05em;
  font-weight:500;
  margin-bottom:.75rem;
}
.stat-value{
  font-family:var(--font-mono);
  font-size:1.75rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
}
.stat-sub{font-size:.75rem;color:var(--text-muted);margin-top:.375rem}

/* Gauge */
.gauge-wrap{display:flex;align-items:center;gap:1rem}
.gauge-bar-track{
  flex:1;height:8px;border-radius:99px;
  background:var(--border);
  overflow:hidden;
}
.gauge-bar-fill{height:100%;border-radius:99px;transition:width .4s ease}

/* Charts */
.charts-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:.75rem;
  margin-bottom:.75rem;
}
.chart-box{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.chart-box h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}
.chart-box canvas{max-height:280px}

/* Companies */
.company-list{display:flex;flex-wrap:wrap;gap:.375rem}
.company-tag{
  padding:.375rem .625rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  background:var(--surface-hover);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:400;
  cursor:pointer;
  transition:all .15s;
}
.company-tag:hover{border-color:var(--accent);background:var(--surface);color:var(--accent)}
.company-tag .co-country{color:var(--text-muted);margin-left:.25rem;font-size:.75rem}

/* ── Side Panel (Company) ── */
.side-panel-backdrop{
  position:fixed;inset:0;
  background:var(--backdrop);
  z-index:999;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s;
}
.side-panel-backdrop.open{opacity:1;pointer-events:auto}
.side-panel{
  position:fixed;top:0;right:0;bottom:0;
  width:480px;max-width:92vw;
  background:var(--surface);
  border-left:1px solid var(--border);
  z-index:1000;
  transform:translateX(100%);
  transition:transform .25s cubic-bezier(.4,0,.2,1);
  overflow-y:auto;
  display:flex;flex-direction:column;
}
.side-panel.open{transform:translateX(0)}
.sp-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:1.25rem 1.5rem;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.sp-header h3{font-size:1rem;font-weight:600;letter-spacing:-.01em}
.sp-close{
  width:32px;height:32px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;
  color:var(--text-secondary);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .15s;font-family:var(--font-sans);
}
.sp-close:hover{background:var(--surface-hover);color:var(--text);border-color:var(--border-hover)}
.sp-body{padding:1.5rem;flex:1}
.sp-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:.625rem 0;font-size:.8125rem;
}
.sp-row+.sp-row{border-top:1px solid var(--border)}
.sp-row-label{color:var(--text-muted);font-weight:500}
.sp-row-val{font-family:var(--font-mono);font-weight:500;text-align:right;max-width:60%}
.sp-desc{
  font-size:.8125rem;color:var(--text-secondary);line-height:1.6;
  margin:1rem 0;padding:1rem;
  background:var(--bg-elevated);border-radius:var(--radius);
  border:1px solid var(--border);
}
.sp-minerals{display:flex;flex-wrap:wrap;gap:.375rem;margin-top:.75rem}
.sp-mineral-tag{
  padding:.25rem .5rem;border-radius:999px;font-size:.75rem;
  background:var(--accent);color:#fff;font-weight:500;
  opacity:.85;
}
.sp-section-title{
  font-size:.75rem;font-weight:600;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.04em;
  margin:1.25rem 0 .5rem;
}
.sp-market-bar{
  height:6px;border-radius:99px;background:var(--border);overflow:hidden;margin-top:.375rem;
}
.sp-market-bar-fill{height:100%;border-radius:99px;background:var(--accent);transition:width .4s ease}
.sp-customers,.sp-facilities{
  display:flex;flex-wrap:wrap;gap:.375rem;margin-top:.375rem;
}
.sp-chip{
  padding:.2rem .5rem;border-radius:var(--radius);font-size:.75rem;
  background:var(--surface-hover);border:1px solid var(--border);color:var(--text-secondary);
}
.sp-sparkline-wrap{
  height:60px;margin:.5rem 0;position:relative;
}
.sp-sparkline-wrap canvas{width:100%!important;height:100%!important}
.sp-news-item{
  padding:.5rem 0;font-size:.8125rem;color:var(--text-secondary);
  border-bottom:1px solid var(--border);
}
.sp-news-item:last-child{border-bottom:none}
.sp-news-date{font-family:var(--font-mono);font-size:.6875rem;color:var(--text-muted);margin-right:.5rem}

/* ── Country Modal ── */
.country-modal-backdrop{
  position:fixed;inset:0;
  background:var(--backdrop);
  z-index:999;
  opacity:0;pointer-events:none;
  transition:opacity .2s;
  display:flex;align-items:center;justify-content:center;
}
.country-modal-backdrop.open{opacity:1;pointer-events:auto}
.country-modal{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  width:680px;max-width:94vw;max-height:85vh;
  overflow-y:auto;
  transform:scale(.95);opacity:0;
  transition:all .2s cubic-bezier(.4,0,.2,1);
  box-shadow:0 8px 32px rgba(0,0,0,.2);
}
.country-modal-backdrop.open .country-modal{transform:scale(1);opacity:1}
.cm-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:1.25rem 1.5rem;
  border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--surface);z-index:1;
}
.cm-header h3{font-size:1rem;font-weight:600}
.cm-close{
  width:32px;height:32px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;
  color:var(--text-secondary);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .15s;font-family:var(--font-sans);
}
.cm-close:hover{background:var(--surface-hover);color:var(--text);border-color:var(--border-hover)}
.cm-body{padding:1.5rem}
.cm-overview{
  font-size:.8125rem;color:var(--text-secondary);line-height:1.6;
  margin-bottom:1.25rem;padding:1rem;
  background:var(--bg-elevated);border-radius:var(--radius);
  border:1px solid var(--border);
}
.cm-section-title{
  font-size:.75rem;font-weight:600;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.04em;
  margin:1.25rem 0 .75rem;
}
.cm-companies{display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:.5rem}
.cm-company-tag{
  padding:.25rem .625rem;border-radius:var(--radius);font-size:.8125rem;
  background:var(--surface-hover);border:1px solid var(--border);
  color:var(--text);cursor:pointer;transition:all .15s;
}
.cm-company-tag:hover{border-color:var(--accent);color:var(--accent)}
.cm-chart-wrap{height:220px;margin:1rem 0;position:relative}
.cm-chart-wrap canvas{width:100%!important;height:100%!important}
.cm-partners{display:flex;flex-wrap:wrap;gap:.375rem}
.cm-partner-tag{
  padding:.25rem .5rem;border-radius:999px;font-size:.75rem;
  background:var(--surface-hover);border:1px solid var(--border);color:var(--text-secondary);
}

/* Sankey Section */
#sankey-view{display:none}
#sankey-view.active{display:block}
.sankey-header{
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;
}
.sankey-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.sankey-legend{display:flex;flex-wrap:wrap;gap:.625rem;font-size:.75rem;color:var(--text-muted)}
.sankey-legend span{display:flex;align-items:center;gap:.375rem}
.sankey-legend-dot{width:10px;height:10px;border-radius:3px}
.sankey-container{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem;overflow-x:auto;
}
.sankey-container svg text{font-family:var(--font-sans);font-size:11px;fill:var(--text)}
.sankey-tooltip{
  position:fixed;pointer-events:none;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:.625rem .875rem;font-family:var(--font-sans);font-size:.8125rem;color:var(--text);
  box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;max-width:260px;opacity:0;transition:opacity .12s;
}
.sankey-tooltip.visible{opacity:1}
.sankey-tooltip .tt-title{font-weight:600;margin-bottom:.25rem}
.sankey-tooltip .tt-val{font-family:var(--font-mono);font-weight:500;color:var(--accent)}
.sankey-tooltip .tt-sub{color:var(--text-muted);font-size:.75rem;margin-top:.125rem}
.sankey-filter-wrap{display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:1rem}
.sankey-filter{
  padding:.25rem .625rem;border-radius:999px;font-size:.75rem;font-weight:500;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text-muted);transition:all .15s;font-family:var(--font-sans);
}
.sankey-filter:hover{color:var(--text);background:var(--surface-hover)}
.sankey-filter.active{background:var(--text);color:var(--bg);border-color:var(--text)}

/* ── Trade Flows Section ── */
#trade-view{display:none}
#trade-view.active{display:block}

.section-header{
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;
}
.section-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.section-attribution{font-size:.6875rem;color:var(--text-muted);font-family:var(--font-mono)}

.trade-controls{display:flex;gap:.5rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap}
.trade-select{
  padding:.5rem .875rem;border-radius:var(--radius);font-size:.8125rem;font-weight:500;
  border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:var(--font-sans);
  cursor:pointer;transition:all .15s;appearance:none;-webkit-appearance:none;padding-right:2rem;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' viewBox='0 0 24 24' stroke='%2371717a' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right .625rem center;
}
.trade-select:hover{border-color:var(--border-hover)}
.trade-select:focus{outline:none;border-color:var(--accent)}

/* Data tables */
.data-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
.data-table{width:100%;border-collapse:collapse;font-size:.8125rem}
.data-table thead{background:var(--bg-elevated)}
.data-table th{
  padding:.75rem 1rem;text-align:left;font-weight:600;font-size:.75rem;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--border);
}
.data-table th.num{text-align:right}
.data-table th.sortable{cursor:pointer;user-select:none}
.data-table th.sortable:hover{color:var(--text)}
.data-table td{padding:.625rem 1rem;border-bottom:1px solid var(--border);color:var(--text)}
.data-table td.num{text-align:right;font-family:var(--font-mono);font-weight:500;font-size:.8125rem}
.data-table tbody tr:last-child td{border-bottom:none}
.data-table tbody tr:nth-child(even){background:var(--bg-elevated)}
.data-table tbody tr:hover{background:var(--surface-hover)}
.clickable-country{cursor:pointer;color:var(--accent);font-weight:500;transition:color .15s}
.clickable-country:hover{text-decoration:underline}

.change-pos{color:var(--green);font-family:var(--font-mono);font-size:.75rem}
.change-neg{color:var(--red);font-family:var(--font-mono);font-size:.75rem}

.trade-tables-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem}

.us-import-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem;margin-bottom:.75rem;
}
.us-import-card h3{font-size:.8125rem;font-weight:500;color:var(--text-secondary);margin-bottom:1rem}
.us-bar{
  display:flex;align-items:center;gap:.75rem;padding:.375rem 0;font-size:.8125rem;cursor:pointer;
  transition:background .1s;border-radius:4px;margin:0 -.25rem;padding-left:.25rem;padding-right:.25rem;
}
.us-bar:hover{background:var(--surface-hover)}
.us-bar+.us-bar{border-top:1px solid var(--border)}
.us-bar-country{width:100px;color:var(--text);font-weight:500;flex-shrink:0}
.us-bar-track{flex:1;height:20px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
.us-bar-fill{height:100%;border-radius:4px;background:var(--accent);transition:width .4s ease}
.us-bar-pct{width:48px;text-align:right;font-family:var(--font-mono);font-weight:600;font-size:.8125rem;color:var(--text-secondary);flex-shrink:0}

.flow-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:.75rem}
.flow-table-wrap h3{font-size:.8125rem;font-weight:500;color:var(--text-secondary);padding:1rem 1rem .5rem}

/* ── Pricing Section ── */
#pricing-view{display:none}
#pricing-view.active{display:block}

.pricing-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(420px,1fr));gap:.75rem}
.pricing-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem}
.pricing-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
.pricing-card-left h3{font-size:.875rem;font-weight:600;letter-spacing:-.01em;margin-bottom:.25rem}
.pricing-card-left .pricing-unit{font-size:.6875rem;color:var(--text-muted);font-family:var(--font-mono)}
.pricing-current{text-align:right}
.pricing-current .price-big{font-family:var(--font-mono);font-size:1.75rem;font-weight:700;letter-spacing:-.03em;line-height:1}
.pricing-current .price-change{font-family:var(--font-mono);font-size:.75rem;font-weight:600;margin-top:.25rem}
.pricing-current .price-change.up{color:var(--green)}
.pricing-current .price-change.down{color:var(--red)}
.pricing-chart-wrap{height:200px;position:relative}
.pricing-chart-wrap canvas{width:100%!important;height:100%!important}

/* ── Company Explorer ── */
#companies-view{display:none}
#companies-view.active{display:block}

.ce-controls{
  display:flex;gap:.75rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;
}
.ce-search{
  flex:1;min-width:200px;
  padding:.5rem .875rem;border-radius:var(--radius);font-size:.8125rem;
  border:1px solid var(--border);background:var(--surface);color:var(--text);
  font-family:var(--font-sans);transition:all .15s;
}
.ce-search:focus{outline:none;border-color:var(--accent)}
.ce-search::placeholder{color:var(--text-muted)}
.ce-filters{display:flex;gap:.375rem;flex-wrap:wrap}
.ce-filter{
  padding:.375rem .75rem;border-radius:999px;font-size:.75rem;font-weight:500;cursor:pointer;
  border:1px solid var(--border);background:transparent;color:var(--text-muted);transition:all .15s;font-family:var(--font-sans);
}
.ce-filter:hover{color:var(--text);background:var(--surface-hover)}
.ce-filter.active{background:var(--text);color:var(--bg);border-color:var(--text)}
.ce-sort-wrap{display:flex;align-items:center;gap:.5rem}
.ce-sort-label{font-size:.75rem;color:var(--text-muted);white-space:nowrap}

.ce-grid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:.75rem;
}
.ce-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1.25rem;cursor:pointer;transition:all .15s;
}
.ce-card:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.ce-card-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.75rem}
.ce-card-name{font-size:.875rem;font-weight:600;letter-spacing:-.01em}
.ce-card-flag{font-size:1.25rem}
.ce-card-ticker{font-family:var(--font-mono);font-size:.6875rem;color:var(--text-muted);margin-top:.125rem}
.ce-card-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;font-size:.8125rem}
.ce-card-mcap{font-family:var(--font-mono);font-weight:600;color:var(--text-secondary)}
.ce-card-role{font-size:.6875rem;color:var(--text-muted);padding:.2rem .5rem;background:var(--bg-elevated);border-radius:999px;border:1px solid var(--border)}
.ce-card-minerals{display:flex;flex-wrap:wrap;gap:.25rem}
.ce-mineral-pill{padding:.15rem .4rem;border-radius:999px;font-size:.6875rem;color:#fff;font-weight:500}
.ce-no-results{text-align:center;padding:3rem;color:var(--text-muted);font-size:.875rem}

/* ── Mine Map ── */
#minemap-view{display:none}
#minemap-view.active{display:block}

.mm-controls{
  display:flex;gap:.75rem;align-items:center;margin-bottom:1rem;flex-wrap:wrap;
}
.mm-map-container{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  overflow:hidden;position:relative;height:550px;
}
.mm-map-container .mapboxgl-canvas-container{border-radius:var(--radius-lg)}
.mm-map-container .mapboxgl-popup{font-family:var(--font-sans);z-index:10}
.mm-map-container .mapboxgl-popup-content{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:.75rem 1rem;box-shadow:0 4px 16px rgba(0,0,0,.2);color:var(--text);font-size:.8125rem;
}
.mm-map-container .mapboxgl-popup-tip{border-top-color:var(--surface)}
.mm-map-container .mapboxgl-popup-close-button{color:var(--text-muted);font-size:1rem;padding:2px 6px}
.mm-map-container .mapboxgl-popup-close-button:hover{color:var(--text);background:transparent}
.mm-popup-name{font-weight:600;margin-bottom:.25rem}
.mm-popup-company{color:var(--text-secondary);font-size:.75rem}
.mm-popup-detail{font-family:var(--font-mono);font-size:.75rem;color:var(--accent);margin-top:.25rem}
.mm-popup-type{font-size:.6875rem;color:var(--text-muted);margin-top:.125rem}
.mm-legend{
  display:flex;flex-wrap:wrap;gap:.75rem;font-size:.75rem;color:var(--text-muted);margin-top:.75rem;
}
.mm-legend span{display:flex;align-items:center;gap:.375rem}
.mm-legend-dot{width:10px;height:10px;border-radius:50%}
.mm-legend-sq{width:10px;height:10px;border-radius:2px}

/* Footer */
.footer{
  text-align:center;padding:2.5rem 2rem;font-size:.75rem;color:var(--text-muted);
  border-top:1px solid var(--border);max-width:1400px;margin:2rem auto 0;line-height:1.8;
}
.footer-brand{font-weight:500;color:var(--text-secondary)}

/* Responsive */
@media(max-width:768px){
  .header{padding:1rem}
  .header-left h1{font-size:1.125rem}
  .pills-wrap{padding:.625rem 1rem}
  .container{padding:1rem}
  .charts-grid,.trade-tables-grid{grid-template-columns:1fr}
  .overview-grid{grid-template-columns:1fr 1fr}
  .mm-map-container{height:400px}
  .stats-row{grid-template-columns:1fr 1fr}
  .pricing-grid{grid-template-columns:1fr}
  .ce-grid{grid-template-columns:1fr}
  .side-panel{width:100%}
  .country-modal{width:100%;max-width:100%;max-height:100%;border-radius:0}
}
@media(max-width:480px){
  .overview-grid{grid-template-columns:1fr}
  .stats-row{grid-template-columns:1fr}
  .pricing-grid{grid-template-columns:1fr}
  .ce-grid{grid-template-columns:1fr}
}

/* ── V4: Live/Cached Badges ── */
.data-badge{
  display:inline-flex;align-items:center;gap:.25rem;
  font-size:.625rem;font-family:var(--font-mono);font-weight:600;
  padding:.15rem .4rem;border-radius:999px;letter-spacing:.02em;text-transform:uppercase;
}
.data-badge.live{background:var(--green-muted);color:var(--green)}
.data-badge.cached{background:var(--orange-muted);color:var(--orange)}
.data-badge.loading{background:var(--surface-hover);color:var(--text-muted)}
.refresh-btn{
  width:28px;height:28px;border-radius:var(--radius);border:1px solid var(--border);
  background:transparent;color:var(--text-secondary);cursor:pointer;display:inline-flex;
  align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;
}
.refresh-btn:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.refresh-btn.spinning svg{animation:spin .8s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.last-fetched{font-size:.625rem;color:var(--text-muted);font-family:var(--font-mono)}

/* ── V4: Watchlist Star ── */
.watch-btn{
  width:28px;height:28px;border-radius:var(--radius);border:1px solid var(--border);
  background:transparent;color:var(--text-muted);cursor:pointer;display:inline-flex;
  align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;font-size:.875rem;
}
.watch-btn:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--orange)}
.watch-btn.watched{color:var(--orange);border-color:var(--orange);background:var(--orange-muted)}
.mc-top-row{display:flex;align-items:center;gap:.5rem}

/* ── V4: Alerts Tab ── */
#alerts-view{display:none}
#alerts-view.active{display:block}
.alerts-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
@media(max-width:768px){.alerts-grid{grid-template-columns:1fr}}
.watchlist-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1rem;display:flex;justify-content:space-between;align-items:center;transition:all .15s;cursor:pointer;
}
.watchlist-card:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.wl-left{display:flex;align-items:center;gap:.75rem}
.wl-icon{font-size:1.25rem}
.wl-name{font-size:.875rem;font-weight:600}
.wl-meta{font-size:.75rem;color:var(--text-muted);margin-top:.125rem}
.wl-right{display:flex;align-items:center;gap:.5rem}
.wl-remove{
  width:24px;height:24px;border-radius:var(--radius);border:1px solid var(--border);
  background:transparent;color:var(--text-muted);cursor:pointer;display:flex;
  align-items:center;justify-content:center;font-size:.75rem;transition:all .15s;
}
.wl-remove:hover{background:var(--red-muted);color:var(--red);border-color:var(--red)}
.threshold-input{
  width:52px;padding:.2rem .375rem;border-radius:var(--radius);border:1px solid var(--border);
  background:var(--surface);color:var(--text);font-family:var(--font-mono);font-size:.75rem;
  text-align:center;
}
.threshold-input:focus{outline:none;border-color:var(--accent)}
.news-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1rem;transition:all .15s;
}
.news-card:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.news-headline{font-size:.875rem;font-weight:600;margin-bottom:.375rem;line-height:1.4}
.news-meta{display:flex;align-items:center;gap:.5rem;font-size:.6875rem;color:var(--text-muted);margin-bottom:.375rem}
.news-source{font-family:var(--font-mono);font-weight:500}
.news-summary{font-size:.8125rem;color:var(--text-secondary);line-height:1.5}
.news-tag{
  display:inline-block;padding:.125rem .375rem;border-radius:999px;font-size:.625rem;
  font-weight:600;color:#fff;margin-top:.5rem;
}
.alert-banner{
  background:var(--orange-muted);border:1px solid var(--orange);border-radius:var(--radius-lg);
  padding:.75rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:.75rem;
  font-size:.8125rem;color:var(--orange);
}
.alert-banner-close{
  margin-left:auto;cursor:pointer;background:none;border:none;color:var(--orange);font-size:1rem;
}
.empty-watchlist{
  text-align:center;padding:3rem;color:var(--text-muted);font-size:.875rem;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
}

/* ── V4: API Preview ── */
#api-view{display:none}
#api-view.active{display:block}
.api-hero{text-align:center;padding:3rem 2rem 2rem;max-width:700px;margin:0 auto}
.api-hero h2{font-size:1.5rem;font-weight:700;letter-spacing:-.03em;margin-bottom:.5rem}
.api-hero p{color:var(--text-secondary);font-size:.875rem;line-height:1.6}
.api-endpoints{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  overflow:hidden;margin-bottom:.75rem;
}
.api-endpoint{
  padding:.875rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem;
}
.api-endpoint:last-child{border-bottom:none}
.api-method{
  font-family:var(--font-mono);font-size:.6875rem;font-weight:700;
  padding:.2rem .4rem;border-radius:4px;background:var(--green-muted);color:var(--green);min-width:36px;text-align:center;
}
.api-path{font-family:var(--font-mono);font-size:.8125rem;font-weight:500;color:var(--text)}
.api-desc{font-size:.75rem;color:var(--text-muted);margin-left:auto}
.api-code-block{
  background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1.25rem;overflow-x:auto;margin-bottom:.75rem;
}
.api-code-block pre{
  font-family:var(--font-mono);font-size:.75rem;color:var(--text-secondary);line-height:1.7;margin:0;
  white-space:pre;
}
.api-code-block .code-title{
  font-size:.6875rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;
  letter-spacing:.04em;margin-bottom:.75rem;font-family:var(--font-sans);
}
.api-tiers{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin:1.5rem 0}
@media(max-width:768px){.api-tiers{grid-template-columns:1fr}}
.api-tier{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  padding:1.5rem;text-align:center;transition:all .15s;
}
.api-tier:hover{border-color:var(--border-hover)}
.api-tier.featured{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.api-tier-name{font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.5rem}
.api-tier-price{font-family:var(--font-mono);font-size:2rem;font-weight:700;letter-spacing:-.03em;margin-bottom:.25rem}
.api-tier-price span{font-size:.875rem;font-weight:400;color:var(--text-muted)}
.api-tier-detail{font-size:.8125rem;color:var(--text-secondary);margin-bottom:1rem}
.api-tier ul{list-style:none;text-align:left;font-size:.8125rem;color:var(--text-secondary)}
.api-tier li{padding:.25rem 0;display:flex;align-items:center;gap:.375rem}
.api-tier li::before{content:'✓';color:var(--green);font-weight:700;font-size:.75rem}
.api-cta{
  display:inline-flex;align-items:center;gap:.5rem;padding:.625rem 1.5rem;border-radius:var(--radius);
  background:var(--text);color:var(--bg);font-size:.875rem;font-weight:600;
  text-decoration:none;transition:all .15s;border:none;cursor:pointer;font-family:var(--font-sans);
  margin-top:1rem;
}
.api-cta:hover{opacity:.9}

/* ── V4: Search / Command Palette ── */
.search-overlay{
  position:fixed;inset:0;background:var(--backdrop);z-index:2000;
  display:flex;align-items:flex-start;justify-content:center;padding-top:20vh;
  opacity:0;pointer-events:none;transition:opacity .15s;
}
.search-overlay.open{opacity:1;pointer-events:auto}
.search-dialog{
  width:560px;max-width:92vw;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);box-shadow:0 16px 64px rgba(0,0,0,.3);
  transform:scale(.96);transition:transform .15s;overflow:hidden;
}
.search-overlay.open .search-dialog{transform:scale(1)}
.search-input-wrap{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-bottom:1px solid var(--border)}
.search-input-icon{color:var(--text-muted);flex-shrink:0}
.search-input{
  flex:1;border:none;background:transparent;color:var(--text);font-size:.9375rem;
  font-family:var(--font-sans);outline:none;
}
.search-input::placeholder{color:var(--text-muted)}
.search-kbd{
  font-family:var(--font-mono);font-size:.625rem;color:var(--text-muted);
  padding:.15rem .375rem;border:1px solid var(--border);border-radius:4px;background:var(--bg-elevated);
}
.search-results{max-height:360px;overflow-y:auto;padding:.5rem}
.search-group-title{
  font-size:.6875rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;
  letter-spacing:.04em;padding:.375rem .75rem;
}
.search-result{
  padding:.5rem .75rem;border-radius:var(--radius);cursor:pointer;display:flex;
  align-items:center;gap:.75rem;transition:background .1s;font-size:.8125rem;
}
.search-result:hover,.search-result.active{background:var(--surface-hover)}
.search-result-icon{color:var(--text-muted);font-size:1rem;width:20px;text-align:center}
.search-result-name{font-weight:500;color:var(--text)}
.search-result-sub{font-size:.6875rem;color:var(--text-muted);margin-left:auto}
.search-empty{text-align:center;padding:2rem;color:var(--text-muted);font-size:.8125rem}
.search-footer{
  border-top:1px solid var(--border);padding:.5rem 1rem;
  display:flex;gap:1rem;font-size:.6875rem;color:var(--text-muted);
}
.search-footer span{display:flex;align-items:center;gap:.25rem}
.search-footer kbd{
  font-family:var(--font-mono);font-size:.5625rem;padding:.1rem .25rem;
  border:1px solid var(--border);border-radius:3px;background:var(--bg-elevated);
}

/* ── V4: Report Modal ── */
.report-modal-backdrop{
  position:fixed;inset:0;background:var(--backdrop);z-index:1500;
  opacity:0;pointer-events:none;transition:opacity .2s;
  display:flex;align-items:center;justify-content:center;
}
.report-modal-backdrop.open{opacity:1;pointer-events:auto}
.report-modal{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);
  width:480px;max-width:92vw;padding:1.5rem;transform:scale(.95);opacity:0;
  transition:all .2s cubic-bezier(.4,0,.2,1);
}
.report-modal-backdrop.open .report-modal{transform:scale(1);opacity:1}
.report-modal h3{font-size:1rem;font-weight:600;margin-bottom:1rem}
.report-option{
  display:flex;align-items:center;gap:.75rem;padding:.5rem 0;font-size:.8125rem;
}
.report-option input[type="checkbox"]{accent-color:var(--accent);width:16px;height:16px}
.report-option label{cursor:pointer;color:var(--text)}
.report-actions{display:flex;gap:.5rem;margin-top:1.25rem;justify-content:flex-end}
.report-btn{
  padding:.5rem 1rem;border-radius:var(--radius);font-size:.8125rem;font-weight:500;
  cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text);
  font-family:var(--font-sans);transition:all .15s;
}
.report-btn:hover{background:var(--surface-hover);border-color:var(--border-hover)}
.report-btn.primary{background:var(--text);color:var(--bg);border-color:var(--text)}
.report-btn.primary:hover{opacity:.9}

/* ── V4: Header Buttons ── */
.header-btn{
  width:36px;height:36px;border-radius:var(--radius);border:1px solid var(--border);
  background:transparent;color:var(--text-secondary);cursor:pointer;display:flex;
  align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;
}
.header-btn:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.header-btn svg{width:16px;height:16px}

/* ── V4: Copy Data Button ── */
.copy-btn{
  padding:.25rem .5rem;border-radius:var(--radius);font-size:.6875rem;font-weight:500;
  cursor:pointer;border:1px solid var(--border);background:transparent;color:var(--text-muted);
  font-family:var(--font-mono);transition:all .15s;
}
.copy-btn:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.copy-btn.copied{background:var(--green-muted);color:var(--green);border-color:var(--green)}

/* ── V4: Print Styles ── */
@media print{
  .header,.pills-wrap,.footer,.side-panel-backdrop,.side-panel,.country-modal-backdrop,
  .search-overlay,.report-modal-backdrop,.alert-banner,.watch-btn,.copy-btn,.refresh-btn,
  .header-btn,.theme-toggle,.back-btn,.ce-controls,.mm-controls,.trade-controls,
  .sankey-filter-wrap,.ce-filters,.mm-legend{display:none!important}
  body{background:#fff!important;color:#000!important}
  .container{max-width:100%;padding:1rem}
  .mineral-card,.stat-card,.pricing-card,.news-card,.watchlist-card,.chart-box,.data-table-wrap,
  .us-import-card,.flow-table-wrap,.api-endpoints,.api-code-block,.api-tier{
    break-inside:avoid;border-color:#ddd!important;background:#fff!important;
  }
  .overview-grid,.pricing-grid,.charts-grid,.trade-tables-grid,.alerts-grid,.api-tiers{
    grid-template-columns:1fr 1fr;
  }
  [data-theme="dark"]{--text:#000;--text-secondary:#333;--text-muted:#666;--border:#ddd;--surface:#fff;--bg:#fff}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>Critical Minerals Tracker</h1>
    <p>U.S. Dependency & Global Supply Chain Analysis</p>
  </div>
  <div class="header-right">
    <span class="last-updated">Updated Feb 2026</span>
    <button class="header-btn" onclick="openSearch()" aria-label="Search" title="Search (⌘K)">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
    </button>
    <button class="header-btn" onclick="openReportModal()" aria-label="Download Report" title="Download Report">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg>
    </button>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" id="themeBtn">
      <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display:none"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
      <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/></svg>
    </button>
  </div>
</div>

<div class="pills-wrap" id="pills"></div>

<div class="container">
  <div id="overview">
    <div class="overview-header">
      <h2>Supply Chain Risk Overview</h2>
      <div class="legend">
        <span><div class="legend-dot red"></div>High Risk (≥75%)</span>
        <span><div class="legend-dot yellow"></div>Moderate (40–74%)</span>
        <span><div class="legend-dot green"></div>Lower (&lt;40%)</span>
      </div>
    </div>
    <div class="overview-grid" id="overview-grid"></div>
  </div>

  <div id="sankey-view">
    <div class="sankey-header">
      <h2>Supply Chain Flow — Mining → Processing → End Use</h2>
    </div>
    <div class="sankey-filter-wrap" id="sankey-filters"></div>
    <div class="sankey-legend" id="sankey-legend"></div>
    <div class="sankey-container" id="sankey-container"></div>
  </div>

  <div id="trade-view">
    <div class="section-header">
      <h2>Global Trade Flows</h2>
      <span class="section-attribution">Data: USGS, UN Comtrade · Last updated: February 2026</span>
    </div>
    <div class="trade-controls">
      <select class="trade-select" id="trade-mineral-select" onchange="renderTradeView()"></select>
    </div>
    <div id="trade-content"></div>
  </div>

  <div id="pricing-view">
    <div class="section-header">
      <h2>Commodity Pricing — 5-Year History</h2>
      <span class="section-attribution">Data: World Bank Commodity Price Data (Pink Sheet) · Last updated: February 2026</span>
    </div>
    <div class="pricing-grid" id="pricing-grid"></div>
  </div>

  <div id="companies-view">
    <div class="section-header">
      <h2>Company Explorer</h2>
      <span class="section-attribution">50+ companies across the critical minerals supply chain</span>
    </div>
    <div class="ce-controls">
      <input type="text" class="ce-search" id="ce-search" placeholder="Search companies..." oninput="renderCompanyExplorer()">
      <div class="ce-filters" id="ce-role-filters">
        <button class="ce-filter active" data-role="All" onclick="setCERole('All',this)">All</button>
        <button class="ce-filter" data-role="Mining" onclick="setCERole('Mining',this)">Mining</button>
        <button class="ce-filter" data-role="Refining" onclick="setCERole('Refining',this)">Refining</button>
        <button class="ce-filter" data-role="Both" onclick="setCERole('Mining / Refining',this)">Both</button>
      </div>
      <select class="trade-select" id="ce-mineral-filter" onchange="renderCompanyExplorer()">
        <option value="All">All Minerals</option>
      </select>
      <div class="ce-sort-wrap">
        <span class="ce-sort-label">Sort:</span>
        <select class="trade-select" id="ce-sort" onchange="renderCompanyExplorer()">
          <option value="mcap">Market Cap</option>
          <option value="name">Name</option>
          <option value="country">Country</option>
        </select>
      </div>
    </div>
    <div class="ce-grid" id="ce-grid"></div>
  </div>

  <div id="minemap-view">
    <div class="section-header">
      <h2>Mine & Facility Map</h2>
      <span class="section-attribution">Major mining and processing facilities worldwide</span>
    </div>
    <div class="mm-controls">
      <div class="ce-filters" id="mm-mineral-filters"></div>
      <div class="ce-filters">
        <button class="ce-filter active" data-mtype="All" onclick="setMMType('All',this)">All</button>
        <button class="ce-filter" data-mtype="Mine" onclick="setMMType('Mine',this)">Mines</button>
        <button class="ce-filter" data-mtype="Refinery" onclick="setMMType('Refinery',this)">Refineries</button>
      </div>
    </div>
    <div class="mm-map-container" id="mm-map-container"></div>
    <div class="mm-legend" id="mm-legend"></div>
  </div>

  <!-- V4: Alert Banner -->
  <div class="alert-banner" id="alert-banner" style="display:none">
    <span>⚠️</span>
    <span id="alert-banner-text"></span>
    <button class="alert-banner-close" onclick="document.getElementById('alert-banner').style.display='none'">✕</button>
  </div>

  <div id="alerts-view">
    <div class="section-header">
      <h2>Alerts & Watchlist</h2>
      <span class="section-attribution">Personalized tracking · Stored locally</span>
    </div>
    <div id="watchlist-section"></div>
    <div style="margin-top:1.5rem">
      <div class="section-header">
        <h2>Critical Minerals News</h2>
        <span class="section-attribution">Recent developments · Updated Feb 2026</span>
      </div>
      <div id="news-feed" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:.75rem"></div>
    </div>
  </div>

  <div id="api-view">
    <div class="api-hero">
      <h2>Critical Minerals API</h2>
      <p>Programmatic access to supply chain data, pricing, trade flows, and company intelligence. Built for analysts, developers, and procurement teams.</p>
    </div>
    <div style="max-width:800px;margin:0 auto">
      <div class="api-endpoints">
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/minerals</span><span class="api-desc">List all 14 tracked minerals with risk scores</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/minerals/{id}/trade</span><span class="api-desc">Trade flows, importers, exporters by mineral</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/pricing/{mineral}</span><span class="api-desc">Historical & current commodity pricing</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/companies</span><span class="api-desc">50+ companies with supply chain data</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/companies/{id}</span><span class="api-desc">Company detail: facilities, customers, market share</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/mines</span><span class="api-desc">Global mine & facility locations with capacity</span></div>
        <div class="api-endpoint"><span class="api-method">GET</span><span class="api-path">/v1/countries/{iso}/profile</span><span class="api-desc">Country mineral profile & trade partners</span></div>
      </div>
      <div class="api-code-block">
        <div class="code-title">Example Response — GET /v1/minerals/lithium</div>
        <pre>{
  "id": "lithium",
  "name": "Lithium",
  "risk_level": "low",
  "import_reliance": 0.25,
  "china_refining_share": 0.65,
  "top_processor": "China",
  "current_price": {
    "value": 10800,
    "unit": "USD/tonne",
    "source": "World Bank",
    "updated_at": "2026-02-14T00:00:00Z"
  },
  "mining": [
    { "country": "Australia", "share": 0.47 },
    { "country": "Chile", "share": 0.25 },
    { "country": "China", "share": 0.15 }
  ],
  "companies": ["Albemarle", "SQM", "Pilbara Minerals"],
  "trade_volume_tonnes": 245000
}</pre>
      </div>
      <div class="api-tiers">
        <div class="api-tier">
          <div class="api-tier-name">Free</div>
          <div class="api-tier-price">$0<span>/mo</span></div>
          <div class="api-tier-detail">100 requests/day</div>
          <ul>
            <li>Mineral overview data</li>
            <li>Current pricing</li>
            <li>Basic trade flows</li>
            <li>JSON responses</li>
          </ul>
        </div>
        <div class="api-tier featured">
          <div class="api-tier-name">Pro</div>
          <div class="api-tier-price">$49<span>/mo</span></div>
          <div class="api-tier-detail">10,000 requests/day</div>
          <ul>
            <li>All Free features</li>
            <li>Historical pricing data</li>
            <li>Company intelligence</li>
            <li>Mine/facility database</li>
            <li>Webhook alerts</li>
          </ul>
        </div>
        <div class="api-tier">
          <div class="api-tier-name">Enterprise</div>
          <div class="api-tier-price">Custom</div>
          <div class="api-tier-detail">Unlimited requests</div>
          <ul>
            <li>All Pro features</li>
            <li>Bulk data export</li>
            <li>Custom endpoints</li>
            <li>Dedicated support</li>
            <li>SLA guarantee</li>
          </ul>
        </div>
      </div>
      <div style="text-align:center;padding:1rem 0 2rem">
        <a href="mailto:owen@prospectorlabs.io?subject=Critical%20Minerals%20API%20Access%20Request" class="api-cta">Request API Access →</a>
      </div>
    </div>
  </div>

  <div class="detail" id="detail">
    <div class="detail-header">
      <h2 id="detail-title"></h2>
      <button class="back-btn" onclick="showOverview()">← Back</button>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Mining Production — Top Countries</h3><canvas id="miningChart"></canvas></div>
      <div class="chart-box"><h3>Refining / Processing</h3><canvas id="refiningChart"></canvas></div>
    </div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Primary End Uses</h3><canvas id="usesChart"></canvas></div>
      <div class="chart-box" id="companies-section">
        <h3>Key Companies</h3>
        <div class="company-list" id="company-list"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Sources: USGS Mineral Commodity Summaries 2024/2025 · UN Comtrade · World Bank Commodity Markets · IEA Critical Minerals Market Review · DOE Critical Materials Assessment<br>
  <span class="footer-brand">Prospector Labs · Built by Owen Coonahan</span>
</div>

<div class="sankey-tooltip" id="sankey-tooltip">
  <div class="tt-title"></div>
  <div class="tt-val"></div>
  <div class="tt-sub"></div>
</div>

<!-- Mine Map uses Mapbox GL popups -->

<!-- Company Side Panel -->
<div class="side-panel-backdrop" id="sp-backdrop" onclick="closeCompanyPanel()"></div>
<div class="side-panel" id="side-panel">
  <div class="sp-header">
    <h3 id="sp-title"></h3>
    <button class="sp-close" onclick="closeCompanyPanel()">✕</button>
  </div>
  <div class="sp-body" id="sp-body"></div>
</div>

<!-- Country Modal -->
<!-- V4: Search Overlay -->
<div class="search-overlay" id="search-overlay" onclick="closeSearch()">
  <div class="search-dialog" onclick="event.stopPropagation()">
    <div class="search-input-wrap">
      <span class="search-input-icon">
        <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
      </span>
      <input type="text" class="search-input" id="search-input" placeholder="Search minerals, companies, countries, mines..." oninput="updateSearchResults()">
      <span class="search-kbd">ESC</span>
    </div>
    <div class="search-results" id="search-results">
      <div class="search-empty">Type to search across the entire dashboard</div>
    </div>
    <div class="search-footer">
      <span><kbd>↑↓</kbd> Navigate</span>
      <span><kbd>↵</kbd> Open</span>
      <span><kbd>esc</kbd> Close</span>
    </div>
  </div>
</div>

<!-- V4: Report Modal -->
<div class="report-modal-backdrop" id="report-backdrop" onclick="closeReportModal()">
  <div class="report-modal" onclick="event.stopPropagation()">
    <h3>📄 Generate Report</h3>
    <p style="font-size:.8125rem;color:var(--text-secondary);margin-bottom:1rem">Select sections to include in your PDF export:</p>
    <div class="report-option"><input type="checkbox" id="rpt-overview" checked><label for="rpt-overview">Overview Summary</label></div>
    <div class="report-option"><input type="checkbox" id="rpt-pricing" checked><label for="rpt-pricing">Pricing Charts</label></div>
    <div class="report-option"><input type="checkbox" id="rpt-trade" checked><label for="rpt-trade">Trade Flow Data</label></div>
    <div class="report-option"><input type="checkbox" id="rpt-companies"><label for="rpt-companies">Company Explorer</label></div>
    <div id="rpt-minerals-list" style="margin-top:.5rem"></div>
    <div class="report-actions">
      <button class="report-btn" onclick="closeReportModal()">Cancel</button>
      <button class="report-btn primary" onclick="generateReport()">Export as PDF</button>
    </div>
  </div>
</div>

<div class="country-modal-backdrop" id="cm-backdrop" onclick="closeCountryModal()">
  <div class="country-modal" id="country-modal" onclick="event.stopPropagation()">
    <div class="cm-header">
      <h3 id="cm-title"></h3>
      <button class="cm-close" onclick="closeCountryModal()">✕</button>
    </div>
    <div class="cm-body" id="cm-body"></div>
  </div>
</div>

<script>
// Theme
function getTheme(){return document.documentElement.getAttribute('data-theme')}
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('sunIcon').style.display=t==='dark'?'none':'block';
  document.getElementById('moonIcon').style.display=t==='dark'?'block':'none';
  localStorage.setItem('theme',t);
  if(document.getElementById('detail').classList.contains('active')){
    const name=document.getElementById('detail-title').textContent;
    if(name&&MINERALS[name])showMineral(name);
  }
  if(document.getElementById('sankey-view').classList.contains('active')) renderSankey();
  if(document.getElementById('pricing-view').classList.contains('active')) renderPricing();
  if(document.getElementById('trade-view').classList.contains('active')) renderTradeView();
  if(document.getElementById('minemap-view').classList.contains('active')) switchMapboxStyle();
}
function toggleTheme(){setTheme(getTheme()==='dark'?'light':'dark')}
if(localStorage.getItem('theme'))setTheme(localStorage.getItem('theme'));else setTheme('dark');

const COLORS=['#3b82f6','#06b6d4','#8b5cf6','#f59e0b','#ec4899','#22c55e','#6366f1','#14b8a6','#f97316','#d946ef','#84cc16','#ef4444'];

// ══════════════════════════════════════════════════════════════
// COMPANY DATABASE (Enhanced v3)
// ══════════════════════════════════════════════════════════════
const COMPANY_DB = {
  'Albemarle':{ticker:'ALB',country:'US',flag:'🇺🇸',mcap:'$12B',mcapNum:12,hq:'Charlotte, NC, USA',desc:'World\'s largest lithium producer. Operates brine and hard-rock lithium assets in Chile, Australia, and the US.',minerals:['Lithium'],role:'Mining / Refining',
    revenue:'$9.6B',production:'88,000 t LCE/yr',marketShare:18,marketShareMineral:'Lithium',
    customers:['CATL','Tesla','Samsung SDI','SK Innovation','Panasonic'],
    facilities:[{name:'Silver Peak',country:'USA'},{name:'Salar de Atacama',country:'Chile'},{name:'Kemerton',country:'Australia'},{name:'Kings Mountain',country:'USA'}],
    sparkline:[145,138,125,108,95,88,82,90,105,98,92,88],
    news:['Jan 2026: Completed Kings Mountain lithium mine restart in North Carolina','Nov 2025: Signed 5-year supply deal with Tesla for 50,000t LCE','Sep 2025: Announced $1.3B expansion of Kemerton hydroxide plant']},
  'SQM':{ticker:'SQM',country:'Chile',flag:'🇨🇱',mcap:'$15B',mcapNum:15,hq:'Santiago, Chile',desc:'Major lithium and specialty chemicals producer. Operates in Chile\'s Atacama salt flat, one of the world\'s richest lithium brine deposits.',minerals:['Lithium'],role:'Mining / Refining',
    revenue:'$7.2B',production:'180,000 t LCE/yr',marketShare:22,marketShareMineral:'Lithium',
    customers:['LG Energy Solution','CATL','BYD','SK Innovation','Posco'],
    facilities:[{name:'Salar de Atacama',country:'Chile'},{name:'Nueva Victoria',country:'Chile'},{name:'Shanghai Plant',country:'China'}],
    sparkline:[58,55,48,42,38,35,40,52,48,44,42,40],
    news:['Dec 2025: Renewed Atacama lease agreement with Chilean government through 2060','Oct 2025: Broke ground on 40,000t lithium hydroxide plant','Aug 2025: Partnered with Codelco on joint lithium venture']},
  'Pilbara Minerals':{ticker:'PLS',country:'AU',flag:'🇦🇺',mcap:'$8B',mcapNum:8,hq:'Perth, Australia',desc:'Australian hard-rock lithium (spodumene) miner. Operates the Pilgangoora mine, one of the world\'s largest lithium operations.',minerals:['Lithium'],role:'Mining',
    revenue:'$2.8B',production:'620,000 t spodumene/yr',marketShare:8,marketShareMineral:'Lithium',
    customers:['Ganfeng Lithium','POSCO','General Lithium','Yibin Tianyi'],
    facilities:[{name:'Pilgangoora',country:'Australia'},{name:'Ngungaju',country:'Australia'}],
    sparkline:[4.2,3.8,3.5,3.0,2.8,2.6,3.1,3.5,3.2,2.9,2.7,2.8],
    news:['Jan 2026: Pilgangoora P1000 expansion reached full 1Mtpa capacity','Oct 2025: Launched mid-stream processing partnership with POSCO','Jul 2025: Acquired adjacent tenements to extend mine life to 2050+']},
  'Ganfeng Lithium':{ticker:'1772.HK',country:'CN',flag:'🇨🇳',mcap:'$8B',mcapNum:8,hq:'Xinyu, China',desc:'China\'s largest lithium company with integrated mining and processing. Global operations spanning Australia, Argentina, Mexico, and Africa.',minerals:['Lithium'],role:'Mining / Refining',
    revenue:'$6.1B',production:'120,000 t LCE/yr',marketShare:14,marketShareMineral:'Lithium',
    customers:['Tesla','BMW','Volkswagen','BYD','CATL'],
    facilities:[{name:'Xinyu Complex',country:'China'},{name:'Mt Marion',country:'Australia'},{name:'Cauchari-Olaroz',country:'Argentina'},{name:'Sonora',country:'Mexico'}],
    sparkline:[42,38,32,28,25,22,26,30,28,24,22,21],
    news:['Feb 2026: Commissioned lithium recycling mega-plant in Jiangxi province','Nov 2025: Acquired controlling stake in Mali lithium deposit','Aug 2025: Signed BMW supply agreement worth $3B over 6 years']},
  'Tianqi Lithium':{ticker:'9696.HK',country:'CN',flag:'🇨🇳',mcap:'$6B',mcapNum:6,hq:'Chengdu, China',desc:'Major Chinese lithium producer with stakes in Australian mines and Chilean operations. Key supplier to EV battery makers.',minerals:['Lithium'],role:'Mining / Refining',
    revenue:'$3.8B',production:'69,000 t LCE/yr',marketShare:9,marketShareMineral:'Lithium',
    customers:['CATL','BYD','LG Energy Solution','Samsung SDI'],
    facilities:[{name:'Greenbushes (26% stake)',country:'Australia'},{name:'Kwinana',country:'Australia'},{name:'Anju Plant',country:'China'}],
    sparkline:[55,48,40,35,30,28,32,38,34,30,28,26],
    news:['Jan 2026: Kwinana lithium hydroxide refinery reached nameplate capacity','Sep 2025: Wrote down $800M on Greenbushes stake amid price decline','Jun 2025: Announced partnership with CATL on recycling technology']},
  'Arcadium':{ticker:'ALTM',country:'US',flag:'🇺🇸',mcap:'$5B',mcapNum:5,hq:'Philadelphia, PA, USA',desc:'Formed from Livent-Allkem merger. Vertically integrated lithium producer with operations in Argentina, Australia, Canada, and the US.',minerals:['Lithium'],role:'Mining / Refining',
    revenue:'$2.2B',production:'75,000 t LCE/yr',marketShare:6,marketShareMineral:'Lithium',
    customers:['Tesla','BMW','General Motors','LG Energy Solution'],
    facilities:[{name:'Olaroz',country:'Argentina'},{name:'Bessemer City',country:'USA'},{name:'Naraha',country:'Japan'}],
    sparkline:[22,20,18,16,15,14,16,18,17,15,14,13],
    news:['Dec 2025: Rio Tinto completed $6.7B acquisition of Arcadium Lithium','Oct 2025: Sal de Vida project in Argentina reached first production','Jul 2025: Expanded Bessemer City hydroxide capacity by 30%']},
  'Mineral Resources':{ticker:'MIN',country:'AU',flag:'🇦🇺',mcap:'$7B',mcapNum:7,hq:'Perth, Australia',desc:'Diversified Australian mining services and lithium producer. Operates multiple hard-rock lithium mines in Western Australia.',minerals:['Lithium'],role:'Mining',
    revenue:'$3.5B',production:'450,000 t spodumene/yr',marketShare:6,marketShareMineral:'Lithium',
    customers:['Albemarle','Ganfeng Lithium','SQM','CNGR Advanced Material'],
    facilities:[{name:'Mt Marion',country:'Australia'},{name:'Wodgina',country:'Australia'},{name:'Bald Hill',country:'Australia'}],
    sparkline:[65,58,48,42,38,35,40,48,42,38,34,32],
    news:['Jan 2026: Wodgina Train 4 commissioning underway','Oct 2025: Sold 49% of Onslow Iron haul road for $1.1B','Jul 2025: Announced $500M cost reduction program amid lithium downturn']},
  'Glencore':{ticker:'GLEN',country:'CH',flag:'🇨🇭',mcap:'$60B',mcapNum:60,hq:'Baar, Switzerland',desc:'Global commodity trading and mining giant. One of the world\'s largest producers of cobalt, copper, nickel, and zinc with operations across 35+ countries.',minerals:['Cobalt','Copper','Nickel'],role:'Mining / Refining',
    revenue:'$217B',production:'38,000 t cobalt/yr',marketShare:20,marketShareMineral:'Cobalt',
    customers:['Umicore','GEM Co','CATL','Tesla','Volkswagen'],
    facilities:[{name:'Mutanda Mine',country:'DRC'},{name:'Katanga Mining',country:'DRC'},{name:'Murrin Murrin',country:'Australia'},{name:'Sudbury (Raglan)',country:'Canada'}],
    sparkline:[480,465,440,420,415,425,445,470,460,450,440,435],
    news:['Feb 2026: Restarted Mutanda cobalt mine at reduced capacity','Nov 2025: Completed $6.9B acquisition of Teck Resources coal unit','Aug 2025: Signed responsible cobalt supply agreement with BMW']},
  'CMOC':{ticker:'3993.HK',country:'CN',flag:'🇨🇳',mcap:'$15B',mcapNum:15,hq:'Luoyang, China',desc:'Major Chinese mining company and world\'s second-largest cobalt producer through its Tenke Fungurume mine in the DRC.',minerals:['Cobalt','Copper'],role:'Mining',
    revenue:'$8.5B',production:'32,000 t cobalt/yr',marketShare:18,marketShareMineral:'Cobalt',
    customers:['Huayou Cobalt','CATL','GEM Co','Samsung SDI'],
    facilities:[{name:'Tenke Fungurume',country:'DRC'},{name:'Kisanfu',country:'DRC'},{name:'Northparkes',country:'Australia'}],
    sparkline:[4.8,5.2,5.8,6.2,6.8,7.5,8.2,8.8,8.5,7.8,7.2,6.8],
    news:['Jan 2026: Kisanfu mine ramped to 30,000t copper cathode/yr','Oct 2025: DRC government dispute over Tenke royalties resolved','Jul 2025: Announced $2B copper-cobalt expansion at TFM']},
  'Barrick Gold':{ticker:'GOLD',country:'CA',flag:'🇨🇦',mcap:'$30B',mcapNum:30,hq:'Toronto, Canada',desc:'One of the world\'s largest gold miners with significant copper production. Cobalt produced as a byproduct from multiple operations.',minerals:['Cobalt','Copper'],role:'Mining',
    revenue:'$12.9B',production:'1,200 t cobalt/yr',marketShare:1,marketShareMineral:'Cobalt',
    customers:['Sumitomo','Glencore Trading','LME Warehouse'],
    facilities:[{name:'Lumwana',country:'Zambia'},{name:'Reko Diq',country:'Pakistan'},{name:'Nevada Gold Mines',country:'USA'}],
    sparkline:[18,17.5,17,16.5,16,15.5,16,17,18,19,19.5,20],
    news:['Feb 2026: Reko Diq copper-gold project in Pakistan reached 50% construction','Oct 2025: Lumwana Super Pit expansion approved for 240kt Cu/yr','Jul 2025: Merged Nevada operations with Newmont JV']},
  'Huayou Cobalt':{ticker:'603799.SS',country:'CN',flag:'🇨🇳',mcap:'$10B',mcapNum:10,hq:'Tongxiang, China',desc:'Leading Chinese cobalt refiner and battery materials producer. Major processor of DRC-sourced cobalt for EV supply chains.',minerals:['Cobalt'],role:'Refining',
    revenue:'$7.8B',production:'55,000 t refined cobalt/yr',marketShare:28,marketShareMineral:'Cobalt',
    customers:['CATL','BYD','LG Energy Solution','Samsung SDI','Panasonic'],
    facilities:[{name:'Tongxiang Refinery',country:'China'},{name:'Kokkola (Finland JV)',country:'Finland'},{name:'Lualaba (DRC mine)',country:'DRC'}],
    sparkline:[32,35,38,42,45,48,52,55,50,46,42,40],
    news:['Jan 2026: Completed Indonesian nickel-cobalt HPAL plant commissioning','Oct 2025: Signed 100,000t/yr nickel matte offtake with Indonesia','Aug 2025: Expanded precursor cathode capacity to 200,000t/yr']},
  'Umicore':{ticker:'UMI',country:'BE',flag:'🇧🇪',mcap:'$6B',mcapNum:6,hq:'Brussels, Belgium',desc:'Belgian materials technology and recycling company. Major cobalt refiner and cathode materials producer for EV batteries.',minerals:['Cobalt','Germanium'],role:'Refining',
    revenue:'$4.2B',production:'8,000 t refined cobalt/yr',marketShare:5,marketShareMineral:'Cobalt',
    customers:['Volkswagen','BMW','Samsung SDI','SK Innovation','Hyundai'],
    facilities:[{name:'Hoboken Refinery',country:'Belgium'},{name:'Olen Plant',country:'Belgium'},{name:'Nysa Plant',country:'Poland'},{name:'Loyalist (Canada)',country:'Canada'}],
    sparkline:[32,30,28,26,24,22,20,18,17,16,15,15],
    news:['Dec 2025: Paused €3B European gigafactory cathode expansion','Oct 2025: Expanded Hoboken precious metals recycling capacity','Jul 2025: Signed long-term cobalt supply deal with Glencore']},
  'Vale':{ticker:'VALE',country:'BR',flag:'🇧🇷',mcap:'$45B',mcapNum:45,hq:'Rio de Janeiro, Brazil',desc:'World\'s largest nickel producer and major iron ore miner. Significant nickel operations in Canada, Indonesia, and New Caledonia.',minerals:['Nickel','Copper'],role:'Mining',
    revenue:'$38.5B',production:'168,000 t nickel/yr',marketShare:6,marketShareMineral:'Nickel',
    customers:['Toyota','Sumitomo','Glencore','Trafigura','Posco'],
    facilities:[{name:'Sudbury',country:'Canada'},{name:'Voisey\'s Bay',country:'Canada'},{name:'Onça Puma',country:'Brazil'},{name:'Sorowako',country:'Indonesia'}],
    sparkline:[12,11.5,11,10.5,10,9.5,10,11,12,12.5,13,13],
    news:['Feb 2026: Indonesia HPAL nickel plant achieved 80% utilization','Nov 2025: Divested New Caledonia nickel operations','Sep 2025: Signed Tesla battery-grade nickel supply agreement']},
  'Norilsk Nickel':{ticker:'GMKN',country:'RU',flag:'🇷🇺',mcap:'$25B',mcapNum:25,hq:'Moscow, Russia',desc:'World\'s largest producer of palladium and high-grade nickel. Major PGM and copper producer from Arctic operations.',minerals:['Nickel','Platinum Group','Copper'],role:'Mining / Refining',
    revenue:'$15.2B',production:'204,000 t nickel/yr',marketShare:7,marketShareMineral:'Nickel',
    customers:['LME Warehouse','Shanghai Metals Market','Trafigura','Chinese Smelters'],
    facilities:[{name:'Norilsk Complex',country:'Russia'},{name:'Kola Peninsula',country:'Russia'},{name:'Harjavalta (divested)',country:'Finland'}],
    sparkline:[220,210,195,180,170,165,170,180,175,168,160,155],
    news:['Jan 2026: Western sanctions tightened on Russian nickel exports','Oct 2025: Diverted 60% of exports to Chinese buyers','Jul 2025: Announced Arctic Palladium JV with Russian Platinum']},
  'BHP':{ticker:'BHP',country:'AU',flag:'🇦🇺',mcap:'$150B',mcapNum:150,hq:'Melbourne, Australia',desc:'World\'s largest mining company by market cap. Major producer of copper, nickel, iron ore, and potash with global operations.',minerals:['Nickel','Copper'],role:'Mining',
    revenue:'$53.8B',production:'78,000 t nickel/yr',marketShare:3,marketShareMineral:'Nickel',
    customers:['Toyota','BHP Mitsui Coal','Glencore','Trafigura'],
    facilities:[{name:'Nickel West',country:'Australia'},{name:'Olympic Dam',country:'Australia'},{name:'Escondida',country:'Chile'},{name:'Jansen (Potash)',country:'Canada'}],
    sparkline:[42,41,40,39,38,38.5,40,42,43,44,45,46],
    news:['Feb 2026: Olympic Dam copper smelter expansion approved ($4.7B)','Nov 2025: Placed West Musgrave nickel under strategic review','Sep 2025: Escondida produced record 1.2Mt copper concentrate']},
  'Tsingshan':{ticker:'Private',country:'CN',flag:'🇨🇳',mcap:'Private',mcapNum:0,hq:'Wenzhou, China',desc:'World\'s largest stainless steel producer. Revolutionized nickel processing with NPI-to-matte conversion technology in Indonesia.',minerals:['Nickel'],role:'Mining / Refining',
    revenue:'$56B',production:'850,000 t NPI (nickel units)/yr',marketShare:15,marketShareMineral:'Nickel',
    customers:['CATL','BYD','Chinese stainless steel mills','Huayou Cobalt'],
    facilities:[{name:'Indonesia Morowali Industrial Park',country:'Indonesia'},{name:'Indonesia Weda Bay',country:'Indonesia'},{name:'Wenzhou HQ',country:'China'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: Weda Bay Phase 3 nickel smelter operational','Oct 2025: Battery-grade nickel matte output exceeded 200,000t','Jul 2025: Faced EU anti-dumping investigation on Indonesian NPI']},
  'Northern Rare Earths':{ticker:'600111.SS',country:'CN',flag:'🇨🇳',mcap:'$8B',mcapNum:8,hq:'Baotou, China',desc:'China\'s largest rare earth producer, subsidiary of China North Industries (state-owned). Operates the massive Bayan Obo mine.',minerals:['Rare Earths'],role:'Mining / Refining',
    revenue:'$4.5B',production:'70,000 t REO/yr',marketShare:25,marketShareMineral:'Rare Earths',
    customers:['Zhongke Sanhuan','JL MAG','Innuovo','TDK','Shin-Etsu'],
    facilities:[{name:'Bayan Obo Mine',country:'China'},{name:'Baotou Processing',country:'China'}],
    sparkline:[28,30,32,34,36,35,33,30,28,26,25,24],
    news:['Feb 2026: China imposed new rare earth export licensing requirements','Nov 2025: Bayan Obo expansion plan approved for +20,000t REO/yr','Aug 2025: Signed 10-year supply contract with JL MAG for NdFeB']},
  'China Southern RE':{ticker:'600259.SS',country:'CN',flag:'🇨🇳',mcap:'$4B',mcapNum:4,hq:'Ganzhou, China',desc:'Major state-backed Chinese rare earth company focused on heavy rare earths (dysprosium, terbium) from southern China ionic clay deposits.',minerals:['Rare Earths'],role:'Mining / Refining',
    revenue:'$2.8B',production:'35,000 t REO/yr',marketShare:12,marketShareMineral:'Rare Earths',
    customers:['JL MAG','Zhongke Sanhuan','Hitachi Metals','TDK'],
    facilities:[{name:'Ganzhou Mines',country:'China'},{name:'Jiangxi Processing',country:'China'}],
    sparkline:[18,19,20,22,24,23,21,19,18,17,16,15],
    news:['Jan 2026: Merged with Chinalco Rare Earth to form mega-entity','Oct 2025: Heavy rare earth quotas tightened by MIIT','Jul 2025: Invested $400M in ionic clay extraction technology']},
  'MP Materials':{ticker:'MP',country:'US',flag:'🇺🇸',mcap:'$3B',mcapNum:3,hq:'Las Vegas, NV, USA',desc:'Operates Mountain Pass, the only active rare earth mine in the Western Hemisphere. Building downstream separation and magnet manufacturing capacity.',minerals:['Rare Earths'],role:'Mining',
    revenue:'$0.8B',production:'43,000 t REO/yr',marketShare:4,marketShareMineral:'Rare Earths',
    customers:['Sumitomo','GM','DOD (US Defense)','Shenghe Resources'],
    facilities:[{name:'Mountain Pass',country:'USA'},{name:'Fort Worth Magnetics',country:'USA'}],
    sparkline:[32,28,24,20,18,16,15,16,18,17,15,14],
    news:['Feb 2026: Fort Worth NdFeB magnet factory began pilot production','Nov 2025: Received $60M DOD grant for heavy rare earth separation','Sep 2025: Mountain Pass Stage 3 separation plant commissioned']},
  'Lynas Rare Earths':{ticker:'LYC',country:'AU',flag:'🇦🇺',mcap:'$5B',mcapNum:5,hq:'Perth, Australia',desc:'Largest rare earth producer outside China. Mines at Mt Weld (Australia), processes in Malaysia, and building US facility with DOD funding.',minerals:['Rare Earths'],role:'Mining / Refining',
    revenue:'$0.6B',production:'12,000 t REO/yr',marketShare:6,marketShareMineral:'Rare Earths',
    customers:['Toyota','Siemens Gamesa','DOD (US Defense)','Proterial (Hitachi Metals)'],
    facilities:[{name:'Mt Weld Mine',country:'Australia'},{name:'Kuantan LAMP',country:'Malaysia'},{name:'Seadrift (Texas)',country:'USA'}],
    sparkline:[8.5,7.8,7.0,6.2,5.5,5.0,5.2,5.8,5.5,5.0,4.8,4.5],
    news:['Jan 2026: Seadrift Texas processing facility nearing commissioning','Oct 2025: Received $258M DOD contract for US heavy RE separation','Jul 2025: Mt Weld expansion to 12,000tpa NdPr on track']},
  'Iluka Resources':{ticker:'ILU',country:'AU',flag:'🇦🇺',mcap:'$3B',mcapNum:3,hq:'Perth, Australia',desc:'Australian mineral sands producer developing the Eneabba rare earth refinery, a critical non-Chinese rare earth processing facility.',minerals:['Rare Earths'],role:'Mining / Refining',
    revenue:'$1.4B',production:'2,500 t REO/yr (ramping)',marketShare:1,marketShareMineral:'Rare Earths',
    customers:['DOD','European Automakers','Lynas (feedstock swap)'],
    facilities:[{name:'Eneabba Refinery',country:'Australia'},{name:'Jacinth-Ambrosia',country:'Australia'}],
    sparkline:[9.5,9.0,8.5,8.0,7.5,7.0,6.5,6.0,5.8,5.5,5.2,5.0],
    news:['Dec 2025: Eneabba rare earth refinery produced first separated REO','Oct 2025: Australian government committed $1.5B loan for Eneabba','Jun 2025: Discovered additional monazite-rich deposit near Eneabba']},
  'Codelco':{ticker:'State-owned',country:'Chile',flag:'🇨🇱',mcap:'State-owned',mcapNum:0,hq:'Santiago, Chile',desc:'World\'s largest copper producer, owned by the Chilean state. Produces ~8% of global copper from massive Chilean mines.',minerals:['Copper'],role:'Mining / Refining',
    revenue:'$16.5B',production:'1,390,000 t Cu/yr',marketShare:8,marketShareMineral:'Copper',
    customers:['Aurubis','LS-Nikko','Jiangxi Copper','Freeport Smelting'],
    facilities:[{name:'Chuquicamata',country:'Chile'},{name:'El Teniente',country:'Chile'},{name:'Radomiro Tomic',country:'Chile'},{name:'Ministro Hales',country:'Chile'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Feb 2026: El Teniente underground expansion reached new levels','Nov 2025: Production fell to 1.39Mt, lowest in 25 years','Sep 2025: Partnered with SQM on Atacama lithium-copper JV']},
  'Freeport-McMoRan':{ticker:'FCX',country:'US',flag:'🇺🇸',mcap:'$60B',mcapNum:60,hq:'Phoenix, AZ, USA',desc:'World\'s largest publicly traded copper producer. Operates the massive Grasberg mine in Indonesia and significant US copper assets.',minerals:['Copper'],role:'Mining',
    revenue:'$22.8B',production:'1,890,000 t Cu/yr',marketShare:7,marketShareMineral:'Copper',
    customers:['Aurubis','Atlantic Copper','Freeport Indonesia Smelter','Jiangxi Copper','Sumitomo'],
    facilities:[{name:'Grasberg',country:'Indonesia'},{name:'Morenci',country:'USA'},{name:'Cerro Verde',country:'Peru'},{name:'Bagdad',country:'USA'}],
    sparkline:[38,36,34,33,35,40,42,45,48,50,48,46],
    news:['Jan 2026: Grasberg underground block cave reached peak design capacity','Nov 2025: Manyar copper smelter in Indonesia began commissioning','Sep 2025: Morenci expansion added 200Mlb/yr cathode capacity']},
  'Southern Copper':{ticker:'SCCO',country:'MX',flag:'🇲🇽',mcap:'$45B',mcapNum:45,hq:'Mexico City, Mexico',desc:'One of the world\'s largest integrated copper producers with operations in Peru and Mexico. Subsidiary of Grupo México.',minerals:['Copper'],role:'Mining / Refining',
    revenue:'$10.2B',production:'985,000 t Cu/yr',marketShare:4,marketShareMineral:'Copper',
    customers:['Jiangxi Copper','Aurubis','LS-Nikko','Sumitomo'],
    facilities:[{name:'Buenavista del Cobre',country:'Mexico'},{name:'Cuajone',country:'Peru'},{name:'Toquepala',country:'Peru'},{name:'La Caridad',country:'Mexico'}],
    sparkline:[62,60,58,55,52,50,55,60,65,70,72,75],
    news:['Feb 2026: Pilares mine in Sonora reached full production','Nov 2025: Tía María copper project in Peru received final permits','Aug 2025: Annual copper output guidance raised to 1.05Mt']},
  'Ivanhoe Mines':{ticker:'IVN',country:'CA',flag:'🇨🇦',mcap:'$12B',mcapNum:12,hq:'Vancouver, Canada',desc:'Developing world-class copper mine at Kamoa-Kakula in the DRC, rapidly becoming one of the world\'s top copper operations.',minerals:['Copper'],role:'Mining',
    revenue:'$3.2B',production:'450,000 t Cu/yr',marketShare:2,marketShareMineral:'Copper',
    customers:['CITIC Metal','Zijin Mining','LME Warehouse'],
    facilities:[{name:'Kamoa-Kakula',country:'DRC'},{name:'Platreef',country:'South Africa'},{name:'Kipushi',country:'DRC'}],
    sparkline:[8,9,10,11,12,13,14,15,14.5,13.5,12.5,12],
    news:['Jan 2026: Kamoa-Kakula Phase 3 concentrator operational — 600ktpa target','Oct 2025: Kipushi zinc-copper mine restarted after 30-year hiatus','Jul 2025: Platreef PGM-nickel-copper mine began underground development']},
  'BTR New Material':{ticker:'835185.BJ',country:'CN',flag:'🇨🇳',mcap:'$5B',mcapNum:5,hq:'Shenzhen, China',desc:'World\'s largest producer of lithium-ion battery anode materials (graphite). Dominant supplier to CATL, BYD, and global battery makers.',minerals:['Graphite'],role:'Refining',
    revenue:'$3.2B',production:'380,000 t anode material/yr',marketShare:25,marketShareMineral:'Graphite',
    customers:['CATL','BYD','Samsung SDI','LG Energy Solution','Panasonic'],
    facilities:[{name:'Shenzhen HQ',country:'China'},{name:'Inner Mongolia Plant',country:'China'},{name:'Huizhou Plant',country:'China'}],
    sparkline:[18,20,22,25,28,26,24,22,20,18,17,16],
    news:['Jan 2026: Announced 200,000t/yr Indonesia graphite processing plant','Oct 2025: Won CATL\'s largest single anode supply contract','Aug 2025: Developed silicon-graphite composite anode with 400Wh/kg']},
  'Showa Denko':{ticker:'4004.T',country:'JP',flag:'🇯🇵',mcap:'$8B',mcapNum:8,hq:'Tokyo, Japan',desc:'Major Japanese chemical company and leading synthetic graphite producer for EV battery anodes and industrial applications.',minerals:['Graphite'],role:'Refining',
    revenue:'$9.5B',production:'45,000 t synthetic graphite/yr',marketShare:8,marketShareMineral:'Graphite',
    customers:['Panasonic','Toyota','Samsung SDI','Murata'],
    facilities:[{name:'Omachi Plant',country:'Japan'},{name:'Tokushima',country:'Japan'},{name:'Ridgeville (US)',country:'USA'}],
    sparkline:[25,24,23,22,21,20,22,24,26,28,30,32],
    news:['Dec 2025: Rebranded to Resonac; expanded US graphite electrode capacity','Oct 2025: Developed ultra-fast-charge synthetic graphite anode','Jul 2025: Partnered with Toyota on solid-state battery graphite R&D']},
  'Syrah Resources':{ticker:'SYR',country:'AU',flag:'🇦🇺',mcap:'$0.3B',mcapNum:0.3,hq:'Melbourne, Australia',desc:'Operates the Balama graphite mine in Mozambique, one of the world\'s largest. Building a US-based anode processing facility in Louisiana.',minerals:['Graphite'],role:'Mining',
    revenue:'$0.12B',production:'120,000 t natural graphite/yr',marketShare:4,marketShareMineral:'Graphite',
    customers:['Tesla','Vidalia AAM (own facility)'],
    facilities:[{name:'Balama Mine',country:'Mozambique'},{name:'Vidalia AAM',country:'USA'}],
    sparkline:[1.2,1.0,0.8,0.6,0.5,0.4,0.35,0.3,0.28,0.25,0.22,0.20],
    news:['Feb 2026: Vidalia Louisiana AAM facility received DOE loan guarantee','Oct 2025: Balama resumed operations after insurgency-related pause','Jul 2025: Signed binding Tesla offtake for 8,000tpa anode material']},
  'Northern Graphite':{ticker:'NGC',country:'CA',flag:'🇨🇦',mcap:'$0.1B',mcapNum:0.1,hq:'Ottawa, Canada',desc:'Canadian graphite mining company developing domestic supply for North American battery supply chains.',minerals:['Graphite'],role:'Mining',
    revenue:'$0.02B',production:'12,000 t natural graphite/yr',marketShare:0.5,marketShareMineral:'Graphite',
    customers:['North American industrial buyers'],
    facilities:[{name:'Lac des Îles',country:'Canada'},{name:'Bissett Creek',country:'Canada'}],
    sparkline:[1.5,1.3,1.1,0.9,0.8,0.7,0.6,0.5,0.45,0.4,0.35,0.3],
    news:['Nov 2025: Lac des Îles mine restarted production','Aug 2025: Received Canadian government critical minerals grant','May 2025: Completed Bissett Creek feasibility study update']},
  'Nouveau Monde':{ticker:'NOU',country:'CA',flag:'🇨🇦',mcap:'$0.2B',mcapNum:0.2,hq:'Montreal, Canada',desc:'Canadian company developing an integrated natural graphite mining and battery anode material operation in Quebec.',minerals:['Graphite'],role:'Mining / Refining',
    revenue:'$0.01B',production:'Pre-production',marketShare:0,marketShareMineral:'Graphite',
    customers:['Panasonic (LOI)','GM (LOI)'],
    facilities:[{name:'Matawinie Mine (dev)',country:'Canada'},{name:'Bécancour AAM (dev)',country:'Canada'}],
    sparkline:[5.0,4.5,4.0,3.5,3.0,2.5,2.0,1.8,1.5,1.3,1.1,1.0],
    news:['Jan 2026: Matawinie mine received final environmental approval','Oct 2025: Panasonic signed binding offtake for 50,000tpa graphite','Jul 2025: Bécancour anode facility construction 40% complete']},
  'South32':{ticker:'S32',country:'AU',flag:'🇦🇺',mcap:'$10B',mcapNum:10,hq:'Perth, Australia',desc:'Diversified mining company spun off from BHP. Major producer of manganese, alumina, and other base metals.',minerals:['Manganese'],role:'Mining',
    revenue:'$8.1B',production:'5,800,000 t Mn ore/yr',marketShare:12,marketShareMineral:'Manganese',
    customers:['Chinese steel mills','Samancor Chrome','Jiangxi Copper'],
    facilities:[{name:'GEMCO (Groote Eylandt)',country:'Australia'},{name:'TEMCO',country:'Australia'},{name:'Hotazel',country:'South Africa'}],
    sparkline:[3.8,3.6,3.4,3.2,3.0,2.8,3.0,3.2,3.4,3.6,3.8,3.9],
    news:['Feb 2026: GEMCO cyclone recovery 80% complete; production restarting','Oct 2025: Acquired Sierra Gorda copper mine stake from KGHM','Jul 2025: Taylor zinc-lead deposit in Arizona received permits']},
  'Eramet':{ticker:'ERA',country:'FR',flag:'🇫🇷',mcap:'$3B',mcapNum:3,hq:'Paris, France',desc:'French mining and metallurgy group. Major manganese producer with operations in Gabon and New Caledonia nickel assets.',minerals:['Manganese','Nickel'],role:'Mining / Refining',
    revenue:'$3.8B',production:'7,200,000 t Mn ore/yr',marketShare:15,marketShareMineral:'Manganese',
    customers:['Eramet Alloys','ArcelorMittal','Nippon Steel'],
    facilities:[{name:'COMILOG (Moanda)',country:'Gabon'},{name:'Doniambo Smelter',country:'New Caledonia'},{name:'Sandouville',country:'France'}],
    sparkline:[95,88,82,78,72,68,72,80,85,82,78,75],
    news:['Jan 2026: Centenario lithium project in Argentina began production','Oct 2025: Sold New Caledonia nickel operations at a loss','Jul 2025: COMILOG achieved record 7.2Mt manganese ore output']},
  'MOIL':{ticker:'MOIL',country:'India',flag:'🇮🇳',mcap:'$1B',mcapNum:1,hq:'Nagpur, India',desc:'India\'s largest manganese ore producer, state-owned. Operates multiple mines across central India.',minerals:['Manganese'],role:'Mining',
    revenue:'$0.4B',production:'1,400,000 t Mn ore/yr',marketShare:3,marketShareMineral:'Manganese',
    customers:['Tata Steel','JSW Steel','SAIL','Indian ferro-alloy producers'],
    facilities:[{name:'Balaghat Mines',country:'India'},{name:'Chikla Mines',country:'India'},{name:'Dongri Buzurg',country:'India'}],
    sparkline:[195,200,210,220,230,240,250,260,265,270,275,280],
    news:['Dec 2025: Approved expansion plan to reach 2Mtpa by 2028','Sep 2025: Discovered new high-grade deposit in Maharashtra','Jun 2025: Signed MOU with ISRO for manganese-based battery R&D']},
  'Assmang':{ticker:'Private',country:'SA',flag:'🇿🇦',mcap:'Private',mcapNum:0,hq:'Johannesburg, South Africa',desc:'Major South African manganese and iron ore producer. Joint venture between Assore and African Rainbow Minerals.',minerals:['Manganese'],role:'Mining',
    revenue:'$2.1B',production:'4,200,000 t Mn ore/yr',marketShare:9,marketShareMineral:'Manganese',
    customers:['Chinese ferro-alloy producers','ArcelorMittal','Glencore Trading'],
    facilities:[{name:'Nchwaning Mine',country:'South Africa'},{name:'Gloria Mine',country:'South Africa'},{name:'Black Rock',country:'South Africa'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: Invested $300M in Nchwaning Mine modernization','Sep 2025: Black Rock manganese output reached 3.5Mt/yr','Jun 2025: Rail capacity constraints eased with new Transnet allocation']},
  'Jupiter Mines':{ticker:'JMS',country:'AU',flag:'🇦🇺',mcap:'$0.4B',mcapNum:0.4,hq:'Perth, Australia',desc:'Australian mining company operating the Tshipi manganese mine in South Africa, one of the largest manganese operations globally.',minerals:['Manganese'],role:'Mining',
    revenue:'$0.35B',production:'3,600,000 t Mn ore/yr',marketShare:7,marketShareMineral:'Manganese',
    customers:['Chinese smelters','Indian ferro-alloy makers'],
    facilities:[{name:'Tshipi é Ntle',country:'South Africa'}],
    sparkline:[0.32,0.30,0.28,0.26,0.25,0.24,0.26,0.28,0.30,0.32,0.34,0.35],
    news:['Nov 2025: Tshipi achieved record quarterly shipments of 1.05Mt','Aug 2025: Extended mine life to 2045 with new resource estimate','May 2025: Invested in automated haulage fleet at Tshipi']},
  'Chinalco':{ticker:'601600.SS',country:'CN',flag:'🇨🇳',mcap:'$12B',mcapNum:12,hq:'Beijing, China',desc:'China\'s largest aluminum producer and a major gallium producer. Gallium is extracted as a byproduct of alumina refining.',minerals:['Gallium'],role:'Refining',
    revenue:'$42B',production:'~300 t gallium/yr',marketShare:45,marketShareMineral:'Gallium',
    customers:['Chinese semiconductor fabs','AXT Inc','Freiberger','San\'an Optoelectronics'],
    facilities:[{name:'Shandong Refinery',country:'China'},{name:'Henan Refinery',country:'China'},{name:'Guangxi Refinery',country:'China'}],
    sparkline:[5.8,5.5,5.2,5.0,4.8,4.6,4.9,5.2,5.5,5.8,6.0,6.2],
    news:['Feb 2026: Gallium export licenses further restricted by MOFCOM','Nov 2025: Invested $2B in high-purity gallium production line','Aug 2025: Partnered with TSMC on gallium supply security program']},
  'CMC':{ticker:'Private',country:'CN',flag:'🇨🇳',mcap:'Private',mcapNum:0,hq:'Beijing, China',desc:'Chinese metals and chemicals company involved in gallium and germanium production for semiconductor applications.',minerals:['Gallium','Germanium'],role:'Refining',
    revenue:'$1.2B',production:'~80 t gallium, ~20 t germanium/yr',marketShare:12,marketShareMineral:'Gallium',
    customers:['Chinese LED makers','San\'an Optoelectronics','domestic semiconductor industry'],
    facilities:[{name:'Beijing Plant',country:'China'},{name:'Yunnan Facility',country:'China'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: Expanded 6N gallium purification capacity','Sep 2025: Received government subsidy for strategic mineral production','Jun 2025: Doubled germanium wafer output']},
  'AXT Inc':{ticker:'AXTI',country:'US',flag:'🇺🇸',mcap:'$0.2B',mcapNum:0.2,hq:'Fremont, CA, USA',desc:'US manufacturer of compound semiconductor substrates (GaAs, InP, GaSb) used in fiber optics, wireless, and defense electronics.',minerals:['Gallium'],role:'Refining',
    revenue:'$0.13B',production:'~5 t gallium substrates/yr',marketShare:2,marketShareMineral:'Gallium',
    customers:['Skyworks Solutions','Broadcom','II-VI/Coherent','MACOM'],
    facilities:[{name:'Fremont Fab',country:'USA'},{name:'Beijing JV',country:'China'}],
    sparkline:[4.5,4.2,3.8,3.5,3.2,3.0,3.2,3.5,3.8,4.0,4.2,4.5],
    news:['Dec 2025: Received CHIPS Act grant for domestic GaAs expansion','Sep 2025: Qualified 200mm InP wafer for 5G applications','Jun 2025: Beijing JV operations disrupted by export controls']},
  'Freiberger':{ticker:'Private',country:'DE',flag:'🇩🇪',mcap:'Private',mcapNum:0,hq:'Freiberg, Germany',desc:'German manufacturer of gallium arsenide and germanium wafers for semiconductor, solar, and defense applications.',minerals:['Gallium','Germanium'],role:'Refining',
    revenue:'$0.3B',production:'~8 t Ga/Ge substrates/yr',marketShare:3,marketShareMineral:'Gallium',
    customers:['Infineon','STMicroelectronics','IQE','Osram'],
    facilities:[{name:'Freiberg Fab',country:'Germany'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: EU Critical Raw Materials Act funding secured for expansion','Sep 2025: Developed 200mm GaAs wafer for European defense contracts','Jun 2025: Partnered with Umicore on germanium recycling supply']},
  'Coherent':{ticker:'COHR',country:'US',flag:'🇺🇸',mcap:'$8B',mcapNum:8,hq:'Saxonburg, PA, USA',desc:'Major photonics and semiconductor materials company (formerly II-VI). Producer of compound semiconductor materials including GaAs and SiC.',minerals:['Gallium'],role:'Refining',
    revenue:'$5.2B',production:'~12 t compound semiconductor materials/yr',marketShare:4,marketShareMineral:'Gallium',
    customers:['Apple','Cisco','Lumentum','TRUMPF'],
    facilities:[{name:'Saxonburg HQ',country:'USA'},{name:'Easton PA',country:'USA'},{name:'Sherman TX SiC',country:'USA'}],
    sparkline:[55,52,48,45,42,40,42,45,48,52,55,58],
    news:['Feb 2026: Expanded SiC substrate capacity to 250,000 wafers/quarter','Nov 2025: Won $150M DOD contract for IR optical materials','Aug 2025: Launched 200mm SiC wafer for EV power electronics']},
  'Yunnan Germanium':{ticker:'002428.SZ',country:'CN',flag:'🇨🇳',mcap:'$1.5B',mcapNum:1.5,hq:'Kunming, China',desc:'World\'s largest germanium producer. Key supplier of germanium for fiber optics, IR optics, and solar applications.',minerals:['Germanium'],role:'Mining / Refining',
    revenue:'$0.6B',production:'~60 t germanium/yr',marketShare:35,marketShareMineral:'Germanium',
    customers:['Huawei','ZTE','Chinese solar manufacturers','defense contractors'],
    facilities:[{name:'Kunming Refinery',country:'China'},{name:'Chuxiong Mine',country:'China'}],
    sparkline:[12,11.5,11,10.5,10,9.5,10,11,12,13,14,15],
    news:['Jan 2026: Germanium prices surged 80% on continued export restrictions','Oct 2025: Expanded zone-refined germanium capacity for IR optics','Jul 2025: MOFCOM export controls on germanium remained in effect']},
  'Teck Resources':{ticker:'TECK',country:'CA',flag:'🇨🇦',mcap:'$20B',mcapNum:20,hq:'Vancouver, Canada',desc:'Major Canadian mining company producing copper, zinc, and germanium. Trail smelter is a significant Western germanium source.',minerals:['Germanium','Copper'],role:'Mining / Refining',
    revenue:'$12.8B',production:'~15 t germanium/yr',marketShare:8,marketShareMineral:'Germanium',
    customers:['Umicore','US defense contractors','Corning','Western semiconductor fabs'],
    facilities:[{name:'Trail Smelter',country:'Canada'},{name:'Highland Valley Copper',country:'Canada'},{name:'QB2',country:'Chile'}],
    sparkline:[42,40,38,36,35,38,42,45,48,50,52,55],
    news:['Feb 2026: QB2 copper mine in Chile reached design capacity of 300ktpa','Nov 2025: Trail smelter germanium output doubled amid supply concerns','Sep 2025: Completed sale of coal business to Glencore for $6.9B']},
  'China Minmetals':{ticker:'State-owned',country:'CN',flag:'🇨🇳',mcap:'State-owned',mcapNum:0,hq:'Beijing, China',desc:'State-owned Chinese metals and mining conglomerate. World\'s largest tungsten producer and major diversified mineral trader.',minerals:['Tungsten','Rare Earths'],role:'Mining / Refining',
    revenue:'$92B',production:'35,000 t W content/yr',marketShare:35,marketShareMineral:'Tungsten',
    customers:['Sandvik','Kennametal','Chinese carbide industry','global trading partners'],
    facilities:[{name:'Hunan Mines',country:'China'},{name:'Jiangxi Mines',country:'China'},{name:'MMG Las Bambas',country:'Peru'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Feb 2026: China added tungsten to export control list','Nov 2025: Merged rare earth assets with China Southern RE','Aug 2025: MMG Las Bambas copper output reached 350ktpa']},
  'Xiamen Tungsten':{ticker:'600549.SS',country:'CN',flag:'🇨🇳',mcap:'$5B',mcapNum:5,hq:'Xiamen, China',desc:'Major Chinese tungsten producer and processor. Also produces rare earth materials and cemented carbide products.',minerals:['Tungsten','Rare Earths'],role:'Mining / Refining',
    revenue:'$4.8B',production:'12,000 t W content/yr',marketShare:12,marketShareMineral:'Tungsten',
    customers:['Bosch','Siemens','Sandvik','domestic carbide makers'],
    facilities:[{name:'Xiamen Complex',country:'China'},{name:'Ninghua Mine',country:'China'}],
    sparkline:[22,24,26,28,30,32,30,28,26,24,22,21],
    news:['Jan 2026: Expanded cemented carbide capacity by 5,000t/yr','Oct 2025: Rare earth magnet division IPO\'d on Shenzhen exchange','Jul 2025: Tungsten APT prices rose on Chinese export restrictions']},
  'Wolfram Bergbau':{ticker:'Private',country:'AT',flag:'🇦🇹',mcap:'Private',mcapNum:0,hq:'St. Martin, Austria',desc:'Austrian tungsten mining and processing company. One of the few significant non-Chinese tungsten producers in the Western world.',minerals:['Tungsten'],role:'Mining / Refining',
    revenue:'$0.5B',production:'1,500 t W content/yr',marketShare:2,marketShareMineral:'Tungsten',
    customers:['Sandvik','Kennametal','Plansee','European defense industry'],
    facilities:[{name:'Mittersill Mine',country:'Austria'},{name:'St. Martin Processing',country:'Austria'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Dec 2025: EU designated Mittersill as strategic mine under CRMA','Sep 2025: Expanded APT production capacity by 20%','Jun 2025: Signed long-term Plansee supply agreement']},
  'Kennametal':{ticker:'KMT',country:'US',flag:'🇺🇸',mcap:'$3B',mcapNum:3,hq:'Pittsburgh, PA, USA',desc:'US industrial technology company specializing in tungsten carbide cutting tools, tooling systems, and wear-resistant solutions.',minerals:['Tungsten'],role:'Refining',
    revenue:'$2.1B',production:'5,000 t WC products/yr',marketShare:5,marketShareMineral:'Tungsten',
    customers:['Boeing','Caterpillar','General Electric','Lockheed Martin','automotive OEMs'],
    facilities:[{name:'Latrobe',country:'USA'},{name:'Fallon',country:'USA'},{name:'Vogt (Germany)',country:'Germany'}],
    sparkline:[28,27,26,25,24,23,24,25,26,27,28,29],
    news:['Jan 2026: Won $200M DOD contract for advanced tungsten armor-piercing rounds','Oct 2025: Opened recycled tungsten carbide facility in Fallon, NV','Jul 2025: Partnered with DOE on tungsten supply chain resilience']},
  'Sandvik':{ticker:'SAND',country:'SE',flag:'🇸🇪',mcap:'$25B',mcapNum:25,hq:'Stockholm, Sweden',desc:'Swedish engineering group and major producer of cemented carbide tools, mining equipment, and advanced materials.',minerals:['Tungsten'],role:'Refining',
    revenue:'$12.5B',production:'12,000 t WC products/yr',marketShare:10,marketShareMineral:'Tungsten',
    customers:['Caterpillar','BHP','Rio Tinto','Volvo','Airbus'],
    facilities:[{name:'Sandviken',country:'Sweden'},{name:'Gimo',country:'Sweden'},{name:'Coventry',country:'UK'},{name:'Pune',country:'India'}],
    sparkline:[190,188,185,182,180,178,182,186,190,194,198,200],
    news:['Feb 2026: Acquired tungsten recycling startup for $150M','Nov 2025: Launched AI-powered cutting tool optimization platform','Aug 2025: Expanded Sandviken cemented carbide plant by 15%']},
  'Pangang Group':{ticker:'000629.SZ',country:'CN',flag:'🇨🇳',mcap:'$4B',mcapNum:4,hq:'Panzhihua, China',desc:'China\'s largest vanadium producer. Extracts vanadium from titanium-magnetite ore as a byproduct of steelmaking.',minerals:['Vanadium'],role:'Mining / Refining',
    revenue:'$8.5B',production:'32,000 t V₂O₅/yr',marketShare:22,marketShareMineral:'Vanadium',
    customers:['Chinese steel mills','VRB Energy','Largo Clean Energy'],
    facilities:[{name:'Panzhihua Complex',country:'China'},{name:'Xichang Steel',country:'China'}],
    sparkline:[3.2,3.0,2.8,2.6,2.5,2.4,2.5,2.7,2.9,3.0,3.1,3.2],
    news:['Jan 2026: Invested $500M in vanadium electrolyte production for VRFBs','Oct 2025: Panzhihua V₂O₅ output reached 32,000t/yr','Jul 2025: Signed VRFB electrolyte supply deal with Rongke Power']},
  'Evraz':{ticker:'Private',country:'RU',flag:'🇷🇺',mcap:'Private',mcapNum:0,hq:'Moscow, Russia',desc:'Major Russian steel and vanadium producer. One of the world\'s top vanadium producers from its operations.',minerals:['Vanadium'],role:'Mining / Refining',
    revenue:'$14B',production:'18,000 t V₂O₅/yr',marketShare:12,marketShareMineral:'Vanadium',
    customers:['Russian steel mills','Chinese traders','CIS industrial buyers'],
    facilities:[{name:'NTMK (Nizhny Tagil)',country:'Russia'},{name:'KGOK',country:'Russia'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: Diverted vanadium exports to China and India markets','Sep 2025: Completed Nizhny Tagil vanadium slag recovery upgrade','Jun 2025: Western sanctions limited Evraz\'s European customer base']},
  'Bushveld Minerals':{ticker:'BMN',country:'SA',flag:'🇿🇦',mcap:'$0.1B',mcapNum:0.1,hq:'Johannesburg, South Africa',desc:'South African primary vanadium producer also developing vanadium redox flow battery (VRFB) energy storage systems.',minerals:['Vanadium'],role:'Mining',
    revenue:'$0.12B',production:'4,200 t V₂O₅/yr',marketShare:3,marketShareMineral:'Vanadium',
    customers:['Glencore Trading','Trafigura','VRFB developers'],
    facilities:[{name:'Vametco',country:'South Africa'},{name:'Vanchem',country:'South Africa'}],
    sparkline:[0.35,0.30,0.25,0.20,0.18,0.15,0.12,0.10,0.08,0.07,0.06,0.05],
    news:['Dec 2025: Vanchem plant optimization increased recovery to 82%','Sep 2025: Secured $40M refinancing to fund operations','Jun 2025: Piloted 1MWh VRFB system at Vametco mine site']},
  'Largo Inc':{ticker:'LGO',country:'CA',flag:'🇨🇦',mcap:'$0.3B',mcapNum:0.3,hq:'Toronto, Canada',desc:'Pure-play vanadium producer operating the Maracás Menchen mine in Brazil. Also developing VRFB energy storage technology.',minerals:['Vanadium'],role:'Mining',
    revenue:'$0.18B',production:'11,500 t V₂O₅/yr',marketShare:8,marketShareMineral:'Vanadium',
    customers:['Glencore','European steel mills','VRFB system integrators'],
    facilities:[{name:'Maracás Menchen',country:'Brazil'}],
    sparkline:[8.5,7.8,7.0,6.2,5.5,5.0,4.5,4.0,3.5,3.2,2.8,2.5],
    news:['Jan 2026: Launched Largo Clean Energy VRFB division','Oct 2025: Maracás production stabilized at 11,500tpa V₂O₅','Jul 2025: Won 10MWh VRFB contract for California grid storage']},
  'Anglo American Platinum':{ticker:'AMS',country:'SA',flag:'🇿🇦',mcap:'$12B',mcapNum:12,hq:'Johannesburg, South Africa',desc:'World\'s largest primary platinum producer, subsidiary of Anglo American. Operates major PGM mines on South Africa\'s Bushveld Complex.',minerals:['Platinum Group'],role:'Mining / Refining',
    revenue:'$7.8B',production:'3,800,000 oz PGMs/yr',marketShare:35,marketShareMineral:'Platinum Group',
    customers:['Johnson Matthey','BASF Catalysts','Toyota','Hyundai','hydrogen fuel cell makers'],
    facilities:[{name:'Mogalakwena',country:'South Africa'},{name:'Amandelbult',country:'South Africa'},{name:'Mototolo',country:'South Africa'},{name:'Polokwane Smelter',country:'South Africa'}],
    sparkline:[85,80,75,70,68,65,68,72,75,78,80,82],
    news:['Feb 2026: Mogalakwena opencast mine expansion approved','Nov 2025: Signed hydrogen economy PGM supply MOU with Plug Power','Sep 2025: Restructured operations, cutting 3,700 jobs']},
  'Impala Platinum':{ticker:'IMP',country:'SA',flag:'🇿🇦',mcap:'$5B',mcapNum:5,hq:'Johannesburg, South Africa',desc:'Second-largest platinum producer globally. Operations across South Africa\'s Bushveld Complex and in Zimbabwe and Canada.',minerals:['Platinum Group'],role:'Mining / Refining',
    revenue:'$5.2B',production:'2,900,000 oz PGMs/yr',marketShare:22,marketShareMineral:'Platinum Group',
    customers:['Johnson Matthey','BASF','Heraeus','Impala Refining Services'],
    facilities:[{name:'Impala Rustenburg',country:'South Africa'},{name:'Marula',country:'South Africa'},{name:'Zimplats',country:'Zimbabwe'},{name:'Impala Canada',country:'Canada'}],
    sparkline:[12,11,10,9.5,9,8.5,8,7.5,7,6.8,6.5,6.2],
    news:['Jan 2026: Zimplats Phase 3 expansion to add 600koz PGMs/yr','Oct 2025: Placed Rustenburg 1 Shaft under care and maintenance','Jul 2025: Impala Canada Lac des Îles mine optimization complete']},
  'Sibanye-Stillwater':{ticker:'SBSW',country:'SA',flag:'🇿🇦',mcap:'$4B',mcapNum:4,hq:'Johannesburg, South Africa',desc:'Major PGM and gold producer with the only US PGM mine (Stillwater, Montana). Diversifying into battery metals.',minerals:['Platinum Group'],role:'Mining',
    revenue:'$6.5B',production:'1,800,000 oz PGMs/yr',marketShare:12,marketShareMineral:'Platinum Group',
    customers:['Johnson Matthey','BASF','US Mint','Heraeus'],
    facilities:[{name:'Stillwater',country:'USA'},{name:'Kroondal',country:'South Africa'},{name:'Marikana',country:'South Africa'},{name:'Sandouville Ni',country:'France'}],
    sparkline:[15,14,12,10,8,7,6,5.5,5,4.5,4,3.8],
    news:['Feb 2026: Stillwater Mine palladium output recovered to 500koz/yr','Nov 2025: Acquired Reldan recycling for PGM secondary supply','Sep 2025: Restructured SA gold operations; closed Beatrix mine']},
  'Kazatomprom':{ticker:'KAP',country:'KZ',flag:'🇰🇿',mcap:'$8B',mcapNum:8,hq:'Astana, Kazakhstan',desc:'World\'s largest uranium producer, state-owned. Produces ~43% of global uranium primarily through in-situ leaching.',minerals:['Uranium'],role:'Mining',
    revenue:'$3.2B',production:'22,500 t U₃O₈/yr',marketShare:43,marketShareMineral:'Uranium',
    customers:['EDF','China General Nuclear','KEPCO','Exelon','Orano'],
    facilities:[{name:'ISL Operations (Central)',country:'Kazakhstan'},{name:'ISL Operations (South)',country:'Kazakhstan'}],
    sparkline:[28,30,32,34,36,38,42,48,52,55,58,60],
    news:['Jan 2026: Announced 10% production increase for 2026','Oct 2025: Signed 10-year uranium supply contract with China','Jul 2025: Sulfuric acid shortages resolved; production normalized']},
  'Cameco':{ticker:'CCJ',country:'CA',flag:'🇨🇦',mcap:'$22B',mcapNum:22,hq:'Saskatoon, Canada',desc:'World\'s second-largest uranium producer. Operates high-grade mines in Saskatchewan\'s Athabasca Basin.',minerals:['Uranium'],role:'Mining',
    revenue:'$2.6B',production:'8,500 t U₃O₈/yr',marketShare:15,marketShareMineral:'Uranium',
    customers:['US utilities','EDF','Bruce Power','KEPCO'],
    facilities:[{name:'McArthur River',country:'Canada'},{name:'Cigar Lake',country:'Canada'},{name:'Key Lake Mill',country:'Canada'},{name:'Port Hope Conversion',country:'Canada'}],
    sparkline:[18,20,22,25,30,35,42,48,52,55,58,62],
    news:['Feb 2026: McArthur River/Key Lake production reached 18M lbs U₃O₈','Nov 2025: Acquired 49% of Westinghouse nuclear fuel division','Sep 2025: Signed 15-year enriched uranium supply with US utility']},
  'Orano':{ticker:'Private',country:'FR',flag:'🇫🇷',mcap:'Private',mcapNum:0,hq:'Paris, France',desc:'French state-owned nuclear fuel cycle company. Major uranium miner, converter, and enricher with global operations.',minerals:['Uranium'],role:'Mining / Refining',
    revenue:'$5.8B',production:'4,200 t U₃O₈/yr',marketShare:8,marketShareMineral:'Uranium',
    customers:['EDF','Engie','Finnish utilities','Japanese utilities'],
    facilities:[{name:'La Hague',country:'France'},{name:'Tricastin Enrichment',country:'France'},{name:'SOMAIR Mine',country:'Niger'},{name:'McClean Lake Mill',country:'Canada'}],
    sparkline:[0,0,0,0,0,0,0,0,0,0,0,0],
    news:['Jan 2026: Niger operations partially resumed after 2023 coup disruption','Oct 2025: La Hague reprocessing plant 50-year life extension approved','Jul 2025: Signed MOX fuel supply agreement with Japanese utilities']},
  'Energy Fuels':{ticker:'UUUU',country:'US',flag:'🇺🇸',mcap:'$1.5B',mcapNum:1.5,hq:'Lakewood, CO, USA',desc:'Leading US uranium producer and emerging rare earth processor. Operates the White Mesa Mill, the only conventional uranium mill in the US.',minerals:['Uranium','Rare Earths'],role:'Mining / Refining',
    revenue:'$0.32B',production:'500 t U₃O₈/yr',marketShare:1,marketShareMineral:'Uranium',
    customers:['US utilities','DOE Strategic Reserve'],
    facilities:[{name:'White Mesa Mill',country:'USA'},{name:'Nichols Ranch ISR',country:'USA'},{name:'Pinyon Plain',country:'USA'}],
    sparkline:[5.5,5.8,6.2,6.8,7.5,8.5,10,11.5,10,9,8.5,8],
    news:['Feb 2026: White Mesa rare earth separation circuit producing mixed REO','Nov 2025: Pinyon Plain uranium mine production restarted','Sep 2025: DOE purchased 200,000 lbs U₃O₈ for strategic reserve']},
  'Centrus Energy':{ticker:'LEU',country:'US',flag:'🇺🇸',mcap:'$2B',mcapNum:2,hq:'Bethesda, MD, USA',desc:'US nuclear fuel company and sole domestic HALEU producer. Received DOE funding to build US uranium enrichment capability.',minerals:['Uranium'],role:'Refining',
    revenue:'$0.45B',production:'900 kg HALEU/yr (ramping)',marketShare:1,marketShareMineral:'Uranium',
    customers:['DOE','TerraPower','X-energy','Kairos Power'],
    facilities:[{name:'Piketon Enrichment',country:'USA'}],
    sparkline:[22,25,28,32,38,45,55,65,60,55,50,48],
    news:['Jan 2026: DOE extended HALEU production contract to 2031','Oct 2025: Piketon centrifuge cascade expansion underway','Jul 2025: Delivered first commercial HALEU to TerraPower']},
  'Tongwei':{ticker:'600438.SS',country:'CN',flag:'🇨🇳',mcap:'$15B',mcapNum:15,hq:'Chengdu, China',desc:'World\'s largest polysilicon and solar cell producer. Dominant player in solar-grade silicon manufacturing.',minerals:['Silicon'],role:'Refining',
    revenue:'$18.5B',production:'450,000 t polysilicon/yr',marketShare:28,marketShareMineral:'Silicon',
    customers:['LONGi','JA Solar','Trina Solar','Canadian Solar','JinkoSolar'],
    facilities:[{name:'Leshan Plant',country:'China'},{name:'Baotou Plant',country:'China'},{name:'Yongxiang (Yunnan)',country:'China'}],
    sparkline:[42,45,48,52,55,50,45,38,32,28,25,22],
    news:['Feb 2026: Polysilicon prices hit $6/kg; Tongwei cut production 15%','Nov 2025: Acquired 20GW solar cell capacity in Southeast Asia','Sep 2025: Announced industry-first perovskite-silicon tandem cell']},
  'GCL-Poly':{ticker:'3800.HK',country:'CN',flag:'🇨🇳',mcap:'$4B',mcapNum:4,hq:'Hong Kong/Suzhou, China',desc:'Major Chinese polysilicon and silicon wafer producer. Pioneer of granular polysilicon technology for solar applications.',minerals:['Silicon'],role:'Refining',
    revenue:'$5.8B',production:'220,000 t polysilicon/yr',marketShare:14,marketShareMineral:'Silicon',
    customers:['LONGi','Zhonghuan (TCL)','Trina Solar'],
    facilities:[{name:'Xuzhou FBR Plant',country:'China'},{name:'Leshan Plant',country:'China'},{name:'Inner Mongolia',country:'China'}],
    sparkline:[1.8,2.0,2.2,2.5,2.8,2.5,2.2,1.8,1.5,1.2,1.0,0.9],
    news:['Jan 2026: FBR granular polysilicon reached 60% of production mix','Oct 2025: Polysilicon oversupply led to $2B inventory writedown','Jul 2025: Partnered with Longi on ultra-thin wafer technology']},
  'Daqo New Energy':{ticker:'DQ',country:'CN',flag:'🇨🇳',mcap:'$2B',mcapNum:2,hq:'Shanghai, China',desc:'Chinese manufacturer of high-purity polysilicon for solar PV. One of the lowest-cost producers globally.',minerals:['Silicon'],role:'Refining',
    revenue:'$2.2B',production:'195,000 t polysilicon/yr',marketShare:12,marketShareMineral:'Silicon',
    customers:['LONGi','JinkoSolar','JA Solar','Trina Solar'],
    facilities:[{name:'Shihezi Plant',country:'China (Xinjiang)'},{name:'Baotou Plant',country:'China (Inner Mongolia)'}],
    sparkline:[52,48,42,35,28,22,18,15,12,10,8,7],
    news:['Feb 2026: Reduced polysilicon output by 20% amid price collapse','Nov 2025: Xinjiang operations faced renewed ESG scrutiny','Sep 2025: Diversified into semiconductor-grade polysilicon']},
  'Wacker Chemie':{ticker:'WCH',country:'DE',flag:'🇩🇪',mcap:'$8B',mcapNum:8,hq:'Munich, Germany',desc:'German chemical company and major Western polysilicon producer. Key non-Chinese source of semiconductor and solar-grade silicon.',minerals:['Silicon'],role:'Refining',
    revenue:'$7.2B',production:'80,000 t polysilicon/yr',marketShare:5,marketShareMineral:'Silicon',
    customers:['Hanwha Q Cells','SunPower','First Solar','Infineon','TSMC'],
    facilities:[{name:'Burghausen',country:'Germany'},{name:'Nünchritz',country:'Germany'},{name:'Charleston TN',country:'USA'}],
    sparkline:[125,120,115,110,105,100,95,90,88,85,82,80],
    news:['Jan 2026: Charleston TN polysilicon plant qualified for IRA subsidies','Oct 2025: Developed 11N semiconductor-grade silicon for advanced chips','Jul 2025: Signed 10-year solar polysilicon supply deal with Hanwha']},
  'REC Silicon':{ticker:'RECSI',country:'NO',flag:'🇳🇴',mcap:'$0.5B',mcapNum:0.5,hq:'Lysaker, Norway',desc:'Norwegian silicon materials producer with US manufacturing facility in Moses Lake, WA. Resuming US polysilicon production.',minerals:['Silicon'],role:'Refining',
    revenue:'$0.25B',production:'18,000 t polysilicon/yr',marketShare:1,marketShareMineral:'Silicon',
    customers:['Hanwha Q Cells','US solar manufacturers'],
    facilities:[{name:'Moses Lake',country:'USA'},{name:'Butte',country:'USA'}],
    sparkline:[12,11,10,9.5,9,8.5,8,7.5,7,6.5,6,5.5],
    news:['Jan 2026: Moses Lake FBR polysilicon plant reached 80% utilization','Oct 2025: Received $125M DOE loan guarantee for capacity expansion','Jul 2025: Hanwha invested additional $100M for 50% capacity increase']},
};

// Country flag lookup
const COUNTRY_FLAGS = {
  'China':'🇨🇳','USA':'🇺🇸','US':'🇺🇸','Chile':'🇨🇱','Australia':'🇦🇺','Argentina':'🇦🇷',
  'Brazil':'🇧🇷','DRC':'🇨🇩','Indonesia':'🇮🇩','Russia':'🇷🇺','Philippines':'🇵🇭',
  'Canada':'🇨🇦','South Africa':'🇿🇦','Japan':'🇯🇵','South Korea':'🇰🇷','EU':'🇪🇺',
  'India':'🇮🇳','Germany':'🇩🇪','Finland':'🇫🇮','Belgium':'🇧🇪','Norway':'🇳🇴',
  'UK':'🇬🇧','Myanmar':'🇲🇲','Malaysia':'🇲🇾','Taiwan':'🇹🇼','Peru':'🇵🇪',
  'Mexico':'🇲🇽','Gabon':'🇬🇦','Ghana':'🇬🇭','Madagascar':'🇲🇬','Mozambique':'🇲🇿',
  'Kazakhstan':'🇰🇿','Namibia':'🇳🇦','Uzbekistan':'🇺🇿','Niger':'🇳🇪',
  'Bolivia':'🇧🇴','Rwanda':'🇷🇼','Vietnam':'🇻🇳','Zimbabwe':'🇿🇼',
  'New Caledonia':'🇳🇨','Thailand':'🇹🇭','Sweden':'🇸🇪','Austria':'🇦🇹',
  'France':'🇫🇷','Estonia':'🇪🇪','Other':'🌐',
  'Estonia/Japan':'🇪🇪','Switzerland':'🇨🇭',
};

const COUNTRY_PROFILES = {
  'China': {overview:'Dominant force in global critical mineral processing. Refines 60-90%+ of most critical minerals despite mining only a fraction. Invested $130B+ in mineral supply chains 2018-2023. Has imposed export controls on gallium, germanium, graphite, and rare earths.',tradePartners:['Japan','South Korea','EU','USA','India']},
  'Chile': {overview:'World\'s largest copper producer and second-largest lithium producer. State-owned Codelco leads copper production. Atacama salt flat contains some of the world\'s richest lithium brine deposits.',tradePartners:['China','Japan','South Korea','USA','EU']},
  'Australia': {overview:'Major mining economy and top producer of lithium, iron ore, and critical minerals. Key Western ally for supply chain diversification away from China.',tradePartners:['China','Japan','South Korea','India','EU']},
  'DRC': {overview:'Produces 73% of global cobalt and is a rapidly growing copper producer. Artisanal mining raises ESG concerns. Chinese companies control significant mining assets.',tradePartners:['China','Belgium','Finland','South Korea','India']},
  'Indonesia': {overview:'World\'s largest nickel producer (55% of global supply) driven by Chinese-financed smelters. Growing cobalt production as a nickel byproduct.',tradePartners:['China','Japan','South Korea','EU','India']},
  'Russia': {overview:'Major producer of palladium (40%), nickel, uranium enrichment (38%), and various metals. Western sanctions since 2022 have disrupted some supply chains.',tradePartners:['China','India','EU','Japan','Turkey']},
  'South Africa': {overview:'Dominates platinum group metals (72% of platinum mining) and significant manganese producer (37%). Home to the Bushveld Complex.',tradePartners:['China','USA','Germany','Japan','UK']},
  'Japan': {overview:'Major importer and processor of critical minerals. Key refining capacity for nickel, copper, rare earths, and PGMs. Strategic mineral stockpiling program.',tradePartners:['Australia','Chile','Indonesia','China','Canada']},
  'USA': {overview:'Highly import-dependent for most critical minerals. IRA and DPA investments aim to rebuild supply chains.',tradePartners:['Canada','Chile','Australia','China','Mexico']},
  'Canada': {overview:'Important US trading partner and source of nickel, copper, uranium, cobalt, and PGMs.',tradePartners:['USA','EU','Japan','China','South Korea']},
  'South Korea': {overview:'Major importer of critical minerals for electronics and EV battery industries. Home to Samsung SDI, LG Energy Solution, and SK Innovation.',tradePartners:['Australia','Chile','China','Indonesia','Argentina']},
  'EU': {overview:'Highly import-dependent on critical minerals. European Critical Raw Materials Act aims to diversify supply.',tradePartners:['Chile','Australia','DRC','Indonesia','South Africa']},
  'Argentina': {overview:'Growing lithium producer from brine operations in the "Lithium Triangle." Rapidly expanding production capacity.',tradePartners:['China','USA','Japan','South Korea','EU']},
  'Peru': {overview:'World\'s third-largest copper producer. Significant mining sector but facing social license challenges.',tradePartners:['China','Japan','South Korea','USA','EU']},
  'Mexico': {overview:'Growing copper producer and significant US trading partner.',tradePartners:['USA','China','Japan','South Korea','Canada']},
  'Finland': {overview:'Key European cobalt and nickel refiner. Important for EU supply chain diversification.',tradePartners:['DRC','Russia','EU','USA','Japan']},
  'Belgium': {overview:'Major cobalt refining hub through Umicore. Important European processing center for specialty metals.',tradePartners:['DRC','China','EU','USA','Canada']},
  'Norway': {overview:'Producer of silicon metal, nickel refining, and host of REC Silicon.',tradePartners:['EU','USA','Japan','China','South Korea']},
  'Gabon': {overview:'Second-largest manganese producer globally (18%). Eramet\'s COMILOG mine is the primary operation.',tradePartners:['China','EU','India','USA','Japan']},
  'Kazakhstan': {overview:'World\'s largest uranium producer (43%) through state-owned Kazatomprom.',tradePartners:['China','EU','USA','Russia','Japan']},
  'Namibia': {overview:'Third-largest uranium producer globally (11%). Hosts major uranium mines.',tradePartners:['China','EU','USA','Japan','South Korea']},
  'Bolivia': {overview:'Significant tungsten producer and hosts massive lithium resources in Salar de Uyuni.',tradePartners:['USA','EU','China','Brazil','Japan']},
  'Vietnam': {overview:'Growing tungsten producer (5% of global supply). Emerging rare earth mining potential.',tradePartners:['China','Japan','South Korea','EU','USA']},
  'Rwanda': {overview:'Emerging tungsten and tin producer in Central Africa.',tradePartners:['China','EU','USA','UAE','Malaysia']},
  'Madagascar': {overview:'Growing graphite producer with several new mining projects.',tradePartners:['China','EU','USA','Japan','India']},
  'Mozambique': {overview:'Rapidly growing graphite producer (11% of global supply). Syrah Resources\' Balama mine is one of the world\'s largest.',tradePartners:['China','EU','India','Japan','USA']},
  'Myanmar': {overview:'Second-largest rare earth mining country (10%). Heavy rare earth production from ionic clay deposits near Chinese border.',tradePartners:['China']},
  'Malaysia': {overview:'Hosts Lynas rare earth processing facility — the largest non-Chinese rare earth separation plant.',tradePartners:['Australia','China','Japan','South Korea','USA']},
  'Zimbabwe': {overview:'Growing PGM producer (8% of global platinum). Great Dyke geological formation hosts significant deposits.',tradePartners:['South Africa','China','EU','Japan','USA']},
  'Taiwan': {overview:'Major semiconductor manufacturer importing gallium and germanium for chip production.',tradePartners:['China','Japan','USA','South Korea','EU']},
  'UK': {overview:'Home to Johnson Matthey, major PGM refiner and catalyst manufacturer.',tradePartners:['South Africa','Russia','USA','EU','Japan']},
  'New Caledonia': {overview:'French overseas territory with ~5% of global nickel production.',tradePartners:['EU','Japan','China','South Korea','Australia']},
  'India': {overview:'Growing critical minerals consumer and modest producer of manganese, rare earths, and other minerals.',tradePartners:['China','Indonesia','Australia','South Africa','Russia']},
  'Niger': {overview:'Uranium producer (4% of global supply) with Orano-operated mines.',tradePartners:['France','EU','China','USA','Japan']},
  'Uzbekistan': {overview:'Significant uranium producer (7% of global supply) with state-owned Navoi Mining.',tradePartners:['China','Russia','USA','EU','Japan']},
};

const MINERALS = {
  Lithium:{importReliance:25,importLabel:'>25%',chinaRefining:65,topProcessor:'China (65%)',mining:[['Australia',47],['Chile',25],['China',15],['Argentina',6],['Brazil',3],['Other',4]],refining:[['China',65],['Chile',20],['Argentina',5],['Other',10]],uses:[['EV Batteries',74],['Portable Electronics',9],['Grid Storage',7],['Ceramics/Glass',4],['Lubricants',3],['Other',3]],companies:[['Albemarle','US'],['SQM','Chile'],['Pilbara Minerals','AU'],['Ganfeng Lithium','CN'],['Tianqi Lithium','CN'],['Arcadium','US'],['Mineral Resources','AU']]},
  Cobalt:{importReliance:76,importLabel:'76%',chinaRefining:74,topProcessor:'China (74%)',mining:[['DRC',73],['Indonesia',5],['Russia',4],['Australia',3],['Philippines',3],['Canada',2],['Other',10]],refining:[['China',74],['Finland',10],['Belgium',5],['Canada',3],['Other',8]],uses:[['EV Batteries',40],['Portable Electronics',30],['Aerospace Superalloys',15],['Catalysts',5],['Cutting Tools',5],['Other',5]],companies:[['Glencore','CH'],['CMOC','CN'],['Barrick Gold','CA'],['Huayou Cobalt','CN'],['Umicore','BE']]},
  Nickel:{importReliance:56,importLabel:'56%',chinaRefining:35,topProcessor:'China (35%)',mining:[['Indonesia',55],['Philippines',10],['Russia',6],['New Caledonia',5],['Australia',4],['Canada',4],['China',3],['Other',13]],refining:[['China',35],['Indonesia',25],['Japan',8],['Russia',5],['Finland',4],['Australia',3],['Other',20]],uses:[['Stainless Steel',65],['EV Batteries',15],['Alloys/Superalloys',8],['Plating',6],['Other',6]],companies:[['Vale','BR'],['Norilsk Nickel','RU'],['BHP','AU'],['Glencore','CH'],['Tsingshan','CN']]},
  'Rare Earths':{importReliance:95,importLabel:'>95%',chinaRefining:90,topProcessor:'China (90%)',mining:[['China',70],['Myanmar',10],['Australia',6],['USA',4],['India',2],['Thailand',2],['Other',6]],refining:[['China',90],['Malaysia',5],['Estonia/Japan',3],['Other',2]],uses:[['Permanent Magnets',38],['Catalysts',23],['Polishing',12],['Glass',8],['Metallurgy',8],['Ceramics',5],['Other',6]],companies:[['Northern Rare Earths','CN'],['China Southern RE','CN'],['MP Materials','US'],['Lynas Rare Earths','AU'],['Iluka Resources','AU']]},
  Copper:{importReliance:45,importLabel:'45%',chinaRefining:42,topProcessor:'China (42%)',mining:[['Chile',24],['DRC',12],['Peru',10],['China',8],['USA',5],['Indonesia',5],['Australia',4],['Russia',4],['Other',28]],refining:[['China',42],['Chile',9],['Japan',7],['DRC',5],['India',4],['Russia',3],['USA',3],['Other',27]],uses:[['Electrical/Power',65],['Construction',15],['Transportation',7],['Industrial',7],['Consumer',6]],companies:[['Codelco','Chile'],['Freeport-McMoRan','US'],['BHP','AU'],['Southern Copper','MX'],['Glencore','CH'],['Ivanhoe Mines','CA']]},
  Graphite:{importReliance:100,importLabel:'100%',chinaRefining:90,topProcessor:'China (90%+)',mining:[['China',65],['Mozambique',11],['Brazil',7],['Madagascar',5],['India',3],['Other',9]],refining:[['China',90],['Japan',4],['Other',6]],uses:[['EV Battery Anodes',55],['Steelmaking',20],['Foundries',8],['Lubricants',5],['Brake Linings',5],['Other',7]],companies:[['BTR New Material','CN'],['Showa Denko','JP'],['Syrah Resources','AU'],['Northern Graphite','CA'],['Nouveau Monde','CA']]},
  Manganese:{importReliance:100,importLabel:'100%',chinaRefining:93,topProcessor:'China (93%)',mining:[['South Africa',37],['Gabon',18],['Australia',15],['China',6],['Ghana',5],['Brazil',4],['India',4],['Other',11]],refining:[['China',93],['Other',7]],uses:[['Steelmaking',90],['EV Batteries',5],['Aluminum Alloys',3],['Other',2]],companies:[['South32','AU'],['Eramet','FR'],['MOIL','India'],['Assmang','SA'],['Jupiter Mines','AU']]},
  Gallium:{importReliance:100,importLabel:'100%',chinaRefining:98,topProcessor:'China (98%)',mining:[['China',98],['Japan',1],['Russia',0.5],['Other',0.5]],refining:[['China',98],['Japan',1],['Other',1]],uses:[['Semiconductors (GaAs)',70],['LEDs/Optoelectronics',20],['Solar (Space/Military)',5],['Research',5]],companies:[['Chinalco','CN'],['CMC','CN'],['AXT Inc','US'],['Freiberger','DE'],['Coherent','US']]},
  Germanium:{importReliance:50,importLabel:'>50%',chinaRefining:60,topProcessor:'China (60%)',mining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],refining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],uses:[['Fiber Optics',35],['IR Optics/Night Vision',25],['Solar Cells',15],['Catalysts',10],['Other',15]],companies:[['Yunnan Germanium','CN'],['Umicore','BE'],['Teck Resources','CA']]},
  Tungsten:{importReliance:50,importLabel:'50%',chinaRefining:82,topProcessor:'China (82%)',mining:[['China',82],['Vietnam',5],['Russia',3],['Bolivia',2],['Rwanda',2],['Other',6]],refining:[['China',82],['Austria',4],['Other',14]],uses:[['Cutting Tools/Carbide',55],['Mill Products',20],['Steels/Alloys',15],['Chemicals',10]],companies:[['China Minmetals','CN'],['Xiamen Tungsten','CN'],['Wolfram Bergbau','AT'],['Kennametal','US'],['Sandvik','SE']]},
  Vanadium:{importReliance:72,importLabel:'72%',chinaRefining:66,topProcessor:'China (66%)',mining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],refining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],uses:[['Steel Alloys',90],['Flow Batteries (VRFB)',5],['Titanium Alloys',3],['Chemicals',2]],companies:[['Pangang Group','CN'],['Evraz','RU'],['Bushveld Minerals','SA'],['Largo Inc','BR/CA']]},
  'Platinum Group':{importReliance:77,importLabel:'77%',chinaRefining:8,topProcessor:'South Africa (45%)',mining:[['South Africa',72],['Russia',10],['Zimbabwe',8],['Canada',5],['USA',2],['Other',3]],refining:[['South Africa',45],['Russia',25],['UK',10],['Japan',8],['USA',5],['Other',7]],uses:[['Autocatalysts',40],['Jewelry',25],['Hydrogen/Fuel Cells',15],['Chemical Catalysts',10],['Electronics',5],['Other',5]],companies:[['Anglo American Platinum','SA'],['Impala Platinum','SA'],['Sibanye-Stillwater','SA/US'],['Norilsk Nickel','RU']]},
  Uranium:{importReliance:90,importLabel:'>90%',chinaRefining:12,topProcessor:'Russia (38%)',mining:[['Kazakhstan',43],['Canada',15],['Namibia',11],['Australia',8],['Uzbekistan',7],['Russia',5],['Niger',4],['Other',7]],refining:[['Russia',38],['Urenco (EU)',30],['Orano (France)',15],['China',12],['USA',5]],uses:[['Nuclear Power',93],['Medical Isotopes',3],['Defense/Naval',3],['Research',1]],companies:[['Kazatomprom','KZ'],['Cameco','CA'],['Orano','FR'],['Energy Fuels','US'],['Centrus Energy','US']]},
  Silicon:{importReliance:33,importLabel:'33%',chinaRefining:80,topProcessor:'China (80%)',mining:[['China',71],['Russia',6],['Brazil',5],['Norway',5],['USA',3],['France',2],['Other',8]],refining:[['China',80],['Germany',5],['South Korea',5],['Norway',3],['Other',7]],uses:[['Aluminum Alloys',45],['Silicones/Chemicals',30],['Solar Polysilicon',15],['Semiconductors',5],['Other',5]],companies:[['Tongwei','CN'],['GCL-Poly','CN'],['Daqo New Energy','CN'],['Wacker Chemie','DE'],['REC Silicon','NO/US']]}
};

// Mineral color map
const MINERAL_COLORS = {
  Lithium:'#3b82f6',Cobalt:'#8b5cf6',Nickel:'#06b6d4','Rare Earths':'#ec4899',
  Copper:'#f59e0b',Graphite:'#22c55e',Gallium:'#6366f1',Germanium:'#14b8a6',
  Tungsten:'#f97316',Manganese:'#84cc16',Vanadium:'#d946ef','Platinum Group':'#ef4444',
  Uranium:'#a855f7',Silicon:'#64748b'
};
const SANKEY_MINERALS = ['Lithium','Cobalt','Nickel','Rare Earths','Copper','Graphite','Gallium','Germanium','Tungsten'];

function riskLevel(r){return r>=75?'high':r>=40?'med':'low'}

let charts={};
function destroyCharts(){Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});charts={}}

function chartColors(){
  const dark=getTheme()==='dark';
  return{
    grid:dark?'#1e1e22':'#f0f0f2',
    tick:dark?'#71717a':'#a1a1aa',
    label:dark?'#fafafa':'#09090b',
    legendText:dark?'#a1a1aa':'#52525b'
  };
}

// ══════════════════════════════════════════════════════════════
// COMPANY SIDE PANEL (Enhanced v3)
// ══════════════════════════════════════════════════════════════
let spSparkChart = null;

function openCompanyPanel(companyName){
  const co = COMPANY_DB[companyName];
  if(!co) return;
  const panel = document.getElementById('side-panel');
  const backdrop = document.getElementById('sp-backdrop');
  const coWatched = isWatched('company',companyName);
  document.getElementById('sp-title').innerHTML = co.flag+' '+companyName+` <button class="watch-btn ${coWatched?'watched':''}" style="margin-left:.5rem;vertical-align:middle" onclick="toggleWatch('company','${companyName.replace(/'/g,"\\'")}',this)" title="${coWatched?'Remove from watchlist':'Add to watchlist'}">★</button>`;

  const mineralColor = MINERAL_COLORS[co.minerals[0]] || '#3b82f6';

  let html = `
    <div class="sp-row"><span class="sp-row-label">Ticker</span><span class="sp-row-val">${co.ticker}</span></div>
    <div class="sp-row"><span class="sp-row-label">Market Cap</span><span class="sp-row-val">${co.mcap}</span></div>
    <div class="sp-row"><span class="sp-row-label">HQ</span><span class="sp-row-val">${co.hq}</span></div>
    <div class="sp-row"><span class="sp-row-label">Role</span><span class="sp-row-val">${co.role}</span></div>
    <div class="sp-row"><span class="sp-row-label">Revenue</span><span class="sp-row-val">${co.revenue}</span></div>
    <div class="sp-row"><span class="sp-row-label">Production</span><span class="sp-row-val">${co.production}</span></div>
    <div class="sp-desc">${co.desc}</div>
  `;

  // Market share
  if(co.marketShare > 0){
    html += `
      <div class="sp-section-title">Global Market Share — ${co.marketShareMineral}</div>
      <div style="display:flex;align-items:center;gap:.75rem">
        <div class="sp-market-bar" style="flex:1"><div class="sp-market-bar-fill" style="width:${co.marketShare}%;background:${mineralColor}"></div></div>
        <span style="font-family:var(--font-mono);font-size:.875rem;font-weight:600;color:var(--text)">${co.marketShare}%</span>
      </div>
    `;
  }

  // Minerals
  html += `
    <div class="sp-section-title">Minerals</div>
    <div class="sp-minerals">${co.minerals.map(m=>`<span class="sp-mineral-tag" style="background:${MINERAL_COLORS[m]||'#3b82f6'}">${m}</span>`).join('')}</div>
  `;

  // Key Customers
  if(co.customers && co.customers.length){
    html += `
      <div class="sp-section-title">Key Customers</div>
      <div class="sp-customers">${co.customers.map(c=>`<span class="sp-chip">${c}</span>`).join('')}</div>
    `;
  }

  // Facilities
  if(co.facilities && co.facilities.length){
    html += `
      <div class="sp-section-title">Key Facilities</div>
      <div class="sp-facilities">${co.facilities.map(f=>`<span class="sp-chip">${f.name} · ${f.country}</span>`).join('')}</div>
    `;
  }

  // Sparkline (stock price)
  const hasSparkData = co.sparkline && co.sparkline.some(v=>v>0);
  if(hasSparkData){
    html += `
      <div class="sp-section-title">1-Year Stock Trend</div>
      <div class="sp-sparkline-wrap"><canvas id="sp-sparkline-chart"></canvas></div>
    `;
  }

  // News
  if(co.news && co.news.length){
    html += `<div class="sp-section-title">Recent Developments</div>`;
    co.news.forEach(n=>{
      const colonIdx = n.indexOf(':');
      const date = n.substring(0,colonIdx);
      const text = n.substring(colonIdx+1).trim();
      html += `<div class="sp-news-item"><span class="sp-news-date">${date}</span>${text}</div>`;
    });
  }

  document.getElementById('sp-body').innerHTML = html;
  backdrop.classList.add('open');
  panel.classList.add('open');
  document.body.style.overflow='hidden';

  // Render sparkline
  if(hasSparkData){
    setTimeout(()=>{
      if(spSparkChart){try{spSparkChart.destroy()}catch(e){}}
      const ctx = document.getElementById('sp-sparkline-chart');
      if(!ctx) return;
      const dark = getTheme()==='dark';
      spSparkChart = new Chart(ctx.getContext('2d'),{
        type:'line',
        data:{
          labels:['Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec','Jan','Feb'],
          datasets:[{
            data:co.sparkline,
            borderColor:mineralColor,
            backgroundColor:mineralColor+'18',
            fill:true,tension:.4,pointRadius:0,borderWidth:1.5,
          }]
        },
        options:{
          responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},tooltip:{enabled:false}},
          scales:{x:{display:false},y:{display:false}}
        }
      });
    },50);
  }
}

function closeCompanyPanel(){
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('sp-backdrop').classList.remove('open');
  document.body.style.overflow='';
  if(spSparkChart){try{spSparkChart.destroy()}catch(e){}}
  spSparkChart=null;
}

// ══════════════════════════════════════════════════════════════
// COUNTRY MODAL
// ══════════════════════════════════════════════════════════════
let countryModalChart = null;

function openCountryModal(country, mineral){
  const backdrop = document.getElementById('cm-backdrop');
  const flag = COUNTRY_FLAGS[country]||'🌐';
  document.getElementById('cm-title').textContent = flag+' '+country+' — '+mineral;

  const profile = COUNTRY_PROFILES[country] || {overview:'Key participant in the global '+mineral+' supply chain.',tradePartners:['China','USA','EU','Japan']};

  const mineralData = MINERALS[mineral];
  const companiesInCountry = [];
  if(mineralData){
    const countryCodeMap = {'US':'USA','CN':'China','AU':'Australia','BR':'Brazil','CA':'Canada','CH':'Switzerland','RU':'Russia',
      'DE':'Germany','JP':'Japan','SE':'Sweden','AT':'Austria','FR':'France','BE':'Belgium','SA':'South Africa','NO':'Norway',
      'KZ':'Kazakhstan','MX':'Mexico','India':'India','Chile':'Chile'};
    mineralData.companies.forEach(([name, code])=>{
      const fullName = countryCodeMap[code]||code;
      if(fullName===country || code===country) companiesInCountry.push(name);
    });
  }

  const baseVolumes = generateTradeHistory(country, mineral);

  let html = `<div class="cm-overview">${profile.overview}</div>`;

  if(companiesInCountry.length>0){
    html += `<div class="cm-section-title">Key Companies in ${mineral}</div>
    <div class="cm-companies">${companiesInCountry.map(c=>`<span class="cm-company-tag" onclick="event.stopPropagation();closeCountryModal();openCompanyPanel('${c.replace(/'/g,"\\'")}')">${c}</span>`).join('')}</div>`;
  }

  html += `
    <div class="cm-section-title">Historical Trade Volume (5 Years)</div>
    <div class="cm-chart-wrap"><canvas id="countryTradeChart"></canvas></div>
    <div class="cm-section-title">Key Trade Partners</div>
    <div class="cm-partners">${profile.tradePartners.map(p=>`<span class="cm-partner-tag">${COUNTRY_FLAGS[p]||'🌐'} ${p}</span>`).join('')}</div>
  `;

  document.getElementById('cm-body').innerHTML = html;
  backdrop.classList.add('open');
  document.body.style.overflow='hidden';

  setTimeout(()=>{
    if(countryModalChart){try{countryModalChart.destroy()}catch(e){}}
    const ctx = document.getElementById('countryTradeChart');
    if(!ctx) return;
    const dark = getTheme()==='dark';
    const cc = chartColors();
    countryModalChart = new Chart(ctx.getContext('2d'),{
      type:'line',
      data:{
        labels:['2021','2022','2023','2024','2025'],
        datasets:[{
          label:'Trade Volume (Index)',
          data:baseVolumes,
          borderColor:'var(--accent)',
          backgroundColor:dark?'rgba(59,130,246,.12)':'rgba(37,99,235,.08)',
          fill:true,tension:.3,pointRadius:4,pointHitRadius:8,borderWidth:2,
          pointBackgroundColor:dark?'#3b82f6':'#2563eb',
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{
          backgroundColor:dark?'#131316':'#ffffff',
          titleColor:dark?'#fafafa':'#09090b',
          bodyColor:dark?'#a1a1aa':'#52525b',
          borderColor:dark?'#27272a':'#e4e4e7',
          borderWidth:1,titleFont:{family:'Geist',weight:'600'},bodyFont:{family:'Geist Mono'},padding:10,cornerRadius:8,
        }},
        scales:{
          x:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:11,family:'Geist Mono'}}},
          y:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:11,family:'Geist Mono'}},beginAtZero:false}
        }
      }
    });
  },50);
}

function closeCountryModal(){
  document.getElementById('cm-backdrop').classList.remove('open');
  document.body.style.overflow='';
  if(countryModalChart){try{countryModalChart.destroy()}catch(e){}}
  countryModalChart=null;
}

function generateTradeHistory(country, mineral){
  let seed = 0;
  for(let i=0;i<country.length;i++) seed+=country.charCodeAt(i);
  for(let i=0;i<mineral.length;i++) seed+=mineral.charCodeAt(i)*3;
  const base = 60 + (seed % 40);
  const growth = ((seed*7)%30)-10;
  return [0,1,2,3,4].map(i=>{
    const noise = ((seed*(i+1)*13)%20)-10;
    return Math.round(base + growth*i/4 + noise);
  });
}

// ══════════════════════════════════════════════════════════════
// TRADE FLOW DATA
// ══════════════════════════════════════════════════════════════
const TRADE_DATA = {
  Lithium: {
    hsCode:'2836.91 / 2825.20',unit:'Lithium Carbonate Equivalent (LCE)',globalTrade:245000,
    exporters:[{country:'Chile',volume:92000,value:5520,yoy:8.2},{country:'Australia',volume:68000,value:4080,yoy:12.5},{country:'China',volume:35000,value:2100,yoy:-3.1},{country:'Argentina',volume:28000,value:1680,yoy:22.4},{country:'USA',volume:5000,value:300,yoy:15.0}],
    importers:[{country:'China',volume:115000,value:6900,yoy:6.8},{country:'South Korea',volume:38000,value:2280,yoy:11.2},{country:'Japan',volume:28000,value:1680,yoy:4.5},{country:'USA',volume:18000,value:1080,yoy:9.3},{country:'EU',volume:15000,value:900,yoy:18.7}],
    usImports:[{country:'Chile',pct:55},{country:'Argentina',pct:22},{country:'China',pct:12},{country:'Australia',pct:8},{country:'Other',pct:3}],
    flows:[['Australia','China',3200],['Australia','South Korea',520],['Australia','Japan',360],['Chile','China',1800],['Chile','South Korea',1100],['Chile','Japan',900],['Chile','USA',850],['Argentina','China',600],['Argentina','USA',380],['China','South Korea',450],['China','Japan',320]]
  },
  Cobalt: {
    hsCode:'2605.00 / 8105.20',unit:'Tonnes (metal content)',globalTrade:180000,
    exporters:[{country:'DRC',volume:130000,value:5200,yoy:4.2},{country:'Indonesia',volume:12000,value:480,yoy:45.0},{country:'Russia',volume:6500,value:260,yoy:-8.5},{country:'Australia',volume:5800,value:232,yoy:2.1},{country:'Philippines',volume:4800,value:192,yoy:6.3}],
    importers:[{country:'China',volume:120000,value:4800,yoy:7.5},{country:'Finland',volume:15000,value:600,yoy:3.2},{country:'Belgium',volume:10000,value:400,yoy:-2.1},{country:'Japan',volume:8000,value:320,yoy:1.8},{country:'USA',volume:6500,value:260,yoy:5.4}],
    usImports:[{country:'Norway',pct:24},{country:'Canada',pct:19},{country:'Japan',pct:17},{country:'Finland',pct:14},{country:'China',pct:12},{country:'Other',pct:14}],
    flows:[['DRC','China',3800],['DRC','Finland',450],['DRC','Belgium',320],['Indonesia','China',380],['Russia','Finland',120],['Russia','China',100],['Australia','China',180],['Philippines','China',150],['DRC','Japan',200]]
  },
  Nickel: {
    hsCode:'2604.00 / 7502.10',unit:'Tonnes (metal content)',globalTrade:3200000,
    exporters:[{country:'Indonesia',volume:1650000,value:28000,yoy:18.5},{country:'Philippines',volume:380000,value:4200,yoy:5.2},{country:'Russia',volume:195000,value:5100,yoy:-12.3},{country:'New Caledonia',volume:160000,value:2800,yoy:-6.1},{country:'Australia',volume:145000,value:3200,yoy:3.8}],
    importers:[{country:'China',volume:1450000,value:22000,yoy:14.2},{country:'Japan',volume:280000,value:5600,yoy:-1.5},{country:'EU',volume:320000,value:6400,yoy:4.8},{country:'South Korea',volume:185000,value:3700,yoy:7.2},{country:'USA',volume:120000,value:2400,yoy:6.1}],
    usImports:[{country:'Canada',pct:42},{country:'Australia',pct:15},{country:'Norway',pct:10},{country:'Finland',pct:9},{country:'Russia',pct:6},{country:'Other',pct:18}],
    flows:[['Indonesia','China',18000],['Indonesia','Japan',3200],['Indonesia','South Korea',2800],['Philippines','China',2800],['Philippines','Japan',1200],['Russia','EU',2400],['Russia','China',1500],['Australia','Japan',800],['New Caledonia','EU',1800],['Canada','USA',1400],['Australia','USA',520]]
  },
  'Rare Earths': {
    hsCode:'2846.10-90 / 2805.30',unit:'Tonnes REO',globalTrade:125000,
    exporters:[{country:'China',volume:72000,value:5400,yoy:-4.2},{country:'Myanmar',volume:18000,value:900,yoy:15.3},{country:'Australia',volume:12000,value:960,yoy:8.7},{country:'USA',volume:8000,value:640,yoy:25.0},{country:'Malaysia',volume:4500,value:360,yoy:12.1}],
    importers:[{country:'Japan',volume:32000,value:2560,yoy:2.1},{country:'USA',volume:18000,value:1440,yoy:8.5},{country:'EU',volume:15000,value:1200,yoy:14.3},{country:'South Korea',volume:12000,value:960,yoy:6.8},{country:'India',volume:5000,value:400,yoy:22.0}],
    usImports:[{country:'China',pct:72},{country:'Estonia',pct:8},{country:'Japan',pct:7},{country:'Malaysia',pct:6},{country:'Australia',pct:4},{country:'Other',pct:3}],
    flows:[['China','Japan',2200],['China','USA',1200],['China','EU',800],['China','South Korea',680],['China','India',320],['Myanmar','China',750],['Australia','Japan',280],['Australia','EU',200],['USA','Japan',180],['Malaysia','Japan',150]]
  },
  Copper: {
    hsCode:'2603.00 / 7403.11',unit:'Tonnes',globalTrade:25000000,
    exporters:[{country:'Chile',volume:5800000,value:52200,yoy:2.1},{country:'Peru',volume:2400000,value:21600,yoy:-3.5},{country:'DRC',volume:2800000,value:25200,yoy:22.0},{country:'Australia',volume:950000,value:8550,yoy:5.8},{country:'Indonesia',volume:1200000,value:10800,yoy:8.3}],
    importers:[{country:'China',volume:12500000,value:112500,yoy:6.2},{country:'Japan',volume:1400000,value:12600,yoy:-2.1},{country:'EU',volume:2800000,value:25200,yoy:3.5},{country:'South Korea',volume:950000,value:8550,yoy:4.8},{country:'USA',volume:850000,value:7650,yoy:5.1}],
    usImports:[{country:'Chile',pct:35},{country:'Canada',pct:28},{country:'Mexico',pct:15},{country:'Peru',pct:10},{country:'Other',pct:12}],
    flows:[['Chile','China',28000],['Chile','Japan',5200],['Chile','South Korea',4800],['Chile','USA',3800],['Peru','China',12000],['Peru','USA',2200],['DRC','China',18000],['Australia','China',5500],['Australia','Japan',2200],['Indonesia','China',8500],['Canada','USA',3200],['Mexico','USA',1600]]
  },
  Graphite: {
    hsCode:'2504.10-90',unit:'Tonnes',globalTrade:1600000,
    exporters:[{country:'China',volume:680000,value:1360,yoy:-2.5},{country:'Mozambique',volume:180000,value:360,yoy:35.0},{country:'Brazil',volume:115000,value:230,yoy:4.2},{country:'Madagascar',volume:75000,value:150,yoy:8.1},{country:'India',volume:50000,value:100,yoy:6.3}],
    importers:[{country:'Japan',volume:180000,value:360,yoy:3.5},{country:'South Korea',volume:145000,value:290,yoy:12.1},{country:'EU',volume:165000,value:330,yoy:8.4},{country:'USA',volume:95000,value:190,yoy:15.2},{country:'India',volume:85000,value:170,yoy:10.5}],
    usImports:[{country:'China',pct:33},{country:'Mexico',pct:22},{country:'Canada',pct:15},{country:'Madagascar',pct:12},{country:'Mozambique',pct:8},{country:'Other',pct:10}],
    flows:[['China','Japan',250],['China','South Korea',200],['China','EU',180],['China','USA',120],['Mozambique','EU',80],['Mozambique','China',60],['Brazil','EU',45],['Brazil','USA',35],['Madagascar','USA',28],['Madagascar','EU',22]]
  },
  Gallium: {
    hsCode:'8112.92',unit:'Tonnes',globalTrade:600,
    exporters:[{country:'China',volume:480,value:288,yoy:-15.0},{country:'Japan',volume:30,value:18,yoy:5.2},{country:'South Korea',volume:22,value:13.2,yoy:8.0},{country:'Russia',volume:12,value:7.2,yoy:-22.0},{country:'Germany',volume:8,value:4.8,yoy:12.0}],
    importers:[{country:'Japan',volume:120,value:72,yoy:-8.5},{country:'USA',volume:65,value:39,yoy:-12.0},{country:'EU',volume:85,value:51,yoy:-5.2},{country:'South Korea',volume:55,value:33,yoy:2.1},{country:'Taiwan',volume:45,value:27,yoy:-3.8}],
    usImports:[{country:'China',pct:53},{country:'UK',pct:14},{country:'Germany',pct:12},{country:'Japan',pct:11},{country:'Other',pct:10}],
    flows:[['China','Japan',52],['China','USA',28],['China','EU',32],['China','South Korea',25],['China','Taiwan',20],['Japan','USA',8],['Germany','USA',5]]
  },
  Germanium: {
    hsCode:'8112.92',unit:'Tonnes',globalTrade:180,
    exporters:[{country:'China',volume:95,value:142,yoy:-18.0},{country:'Belgium',volume:25,value:37.5,yoy:4.5},{country:'Canada',volume:18,value:27,yoy:6.2},{country:'Russia',volume:8,value:12,yoy:-25.0},{country:'USA',volume:6,value:9,yoy:10.0}],
    importers:[{country:'USA',volume:35,value:52.5,yoy:-8.0},{country:'Japan',volume:30,value:45,yoy:2.5},{country:'EU',volume:28,value:42,yoy:5.8},{country:'South Korea',volume:15,value:22.5,yoy:12.0},{country:'Taiwan',volume:12,value:18,yoy:4.3}],
    usImports:[{country:'China',pct:42},{country:'Belgium',pct:22},{country:'Germany',pct:13},{country:'Russia',pct:8},{country:'Other',pct:15}],
    flows:[['China','Japan',28],['China','USA',22],['China','EU',18],['China','South Korea',12],['Belgium','USA',10],['Belgium','EU',8],['Canada','USA',7]]
  },
  Tungsten: {
    hsCode:'2611.00',unit:'Tonnes (W content)',globalTrade:95000,
    exporters:[{country:'China',volume:62000,value:1860,yoy:-3.8},{country:'Vietnam',volume:6200,value:186,yoy:12.5},{country:'Russia',volume:3200,value:96,yoy:-15.0},{country:'Bolivia',volume:2100,value:63,yoy:8.2},{country:'Rwanda',volume:1800,value:54,yoy:18.0}],
    importers:[{country:'Japan',volume:8500,value:255,yoy:2.8},{country:'USA',volume:7200,value:216,yoy:4.5},{country:'EU',volume:12000,value:360,yoy:3.2},{country:'South Korea',volume:5500,value:165,yoy:6.8},{country:'India',volume:3200,value:96,yoy:15.0}],
    usImports:[{country:'China',pct:32},{country:'Germany',pct:18},{country:'Bolivia',pct:15},{country:'Canada',pct:12},{country:'Other',pct:23}],
    flows:[['China','Japan',180],['China','USA',95],['China','EU',220],['China','South Korea',110],['China','India',65],['Vietnam','Japan',45],['Vietnam','EU',38],['Russia','EU',55],['Bolivia','USA',35],['Rwanda','EU',22]]
  }
};

// ══════════════════════════════════════════════════════════════
// PRICING DATA
// ══════════════════════════════════════════════════════════════
const PRICING_DATA = {
  'Lithium Carbonate': {unit:'$/tonne',current:10800,yoyChange:-28.5,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[8500,9200,12500,28000,38000,52000,68000,82000,72000,42000,28000,18000,15200,13800,12500,11800,15100,14200,12800,11200,10800],color:'#3b82f6'},
  'Cobalt': {unit:'$/tonne',current:24200,yoyChange:-18.2,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[36500,42000,52000,56000,72000,82000,55000,52000,35000,33500,32000,30000,28500,27200,29500,26800,29600,28000,26200,25100,24200],color:'#8b5cf6'},
  'Nickel': {unit:'$/tonne',current:15400,yoyChange:-8.3,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[18200,17800,19200,20500,22800,33000,22000,23500,28500,24000,21500,18200,16500,18200,17000,15800,16800,16200,15800,15600,15400],color:'#06b6d4'},
  'Copper': {unit:'$/tonne',current:9250,yoyChange:5.7,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[7950,9200,9400,9600,9800,10200,7600,7700,9100,8800,8500,8000,8400,9800,9500,9600,8750,9100,9400,9100,9250],color:'#f59e0b'},
  'Rare Earths (NdPr Oxide)': {unit:'$/kg',current:52,yoyChange:-12.4,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[55,70,85,120,140,120,90,75,72,68,55,50,62,68,58,55,59.4,58,55,53,52],color:'#ec4899'},
  'Tungsten (APT)': {unit:'$/mtu',current:325,yoyChange:8.3,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[275,280,290,295,310,325,300,295,280,285,295,290,285,295,310,320,300,310,320,318,325],color:'#f97316'},
  'Manganese (Mn 99.7%)': {unit:'$/tonne',current:1850,yoyChange:-5.2,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[1620,1750,1880,2050,2280,2450,2350,2200,2100,1980,1920,1850,1900,2050,2100,1980,1950,1920,1880,1860,1850],color:'#22c55e'},
  'Vanadium (V₂O₅)': {unit:'$/lb',current:6.20,yoyChange:-14.8,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[7.80,8.50,9.20,10.50,12.80,14.20,11.50,9.80,8.50,7.90,7.20,6.80,7.50,8.20,7.80,7.10,7.28,7.00,6.60,6.35,6.20],color:'#6366f1'},
  'Graphite (Flake, Large)': {unit:'$/tonne',current:680,yoyChange:-12.0,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[520,560,610,680,750,820,880,920,950,880,820,780,750,780,760,720,773,740,710,690,680],color:'#14b8a6'},
  'Uranium (U₃O₈)': {unit:'$/lb',current:78,yoyChange:22.5,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[29,31,33,42,43,50,48,50,51,53,56,72,95,88,82,78,63.7,68,72,75,78],color:'#d946ef'},
  'Platinum': {unit:'$/oz',current:985,yoyChange:3.8,labels:['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],prices:[1090,1220,1080,1020,1020,960,880,920,1050,1080,940,880,920,950,980,960,949,960,970,978,985],color:'#84cc16'}
};

// ══════════════════════════════════════════════════════════════
// MINE & FACILITY DATABASE
// ══════════════════════════════════════════════════════════════
const FACILITIES_DB = [
  // Lithium
  {name:'Greenbushes',company:'Tianqi/IGO',mineral:'Lithium',type:'Mine',country:'Australia',lat:-33.86,lng:116.06,capacity:'1.6Mt spodumene/yr'},
  {name:'Salar de Atacama',company:'SQM/Albemarle',mineral:'Lithium',type:'Mine',country:'Chile',lat:-23.5,lng:-68.2,capacity:'180,000t LCE/yr'},
  {name:'Pilgangoora',company:'Pilbara Minerals',mineral:'Lithium',type:'Mine',country:'Australia',lat:-21.07,lng:118.83,capacity:'1Mt spodumene/yr'},
  {name:'Mt Marion',company:'Mineral Resources/Ganfeng',mineral:'Lithium',type:'Mine',country:'Australia',lat:-31.2,lng:121.5,capacity:'450kt spodumene/yr'},
  {name:'Cauchari-Olaroz',company:'Ganfeng/Lithium Americas',mineral:'Lithium',type:'Mine',country:'Argentina',lat:-23.4,lng:-66.7,capacity:'40,000t LCE/yr'},
  {name:'Silver Peak',company:'Albemarle',mineral:'Lithium',type:'Mine',country:'USA',lat:37.76,lng:-117.64,capacity:'5,000t LCE/yr'},
  {name:'Thacker Pass',company:'Lithium Americas',mineral:'Lithium',type:'Mine',country:'USA',lat:41.15,lng:-117.35,capacity:'40,000t LCE/yr (dev)'},
  {name:'Kwinana Refinery',company:'Tianqi',mineral:'Lithium',type:'Refinery',country:'Australia',lat:-32.24,lng:115.77,capacity:'24,000t LiOH/yr'},
  {name:'Kemerton Refinery',company:'Albemarle',mineral:'Lithium',type:'Refinery',country:'Australia',lat:-33.12,lng:115.73,capacity:'50,000t LiOH/yr'},
  {name:'Xinyu Complex',company:'Ganfeng Lithium',mineral:'Lithium',type:'Refinery',country:'China',lat:27.8,lng:114.93,capacity:'100,000t LCE/yr'},
  // Cobalt
  {name:'Mutanda Mine',company:'Glencore',mineral:'Cobalt',type:'Mine',country:'DRC',lat:-10.65,lng:25.95,capacity:'25,000t Co/yr'},
  {name:'Tenke Fungurume',company:'CMOC',mineral:'Cobalt',type:'Mine',country:'DRC',lat:-10.6,lng:26.12,capacity:'18,000t Co/yr'},
  {name:'Kisanfu',company:'CMOC',mineral:'Cobalt',type:'Mine',country:'DRC',lat:-10.8,lng:26.3,capacity:'15,000t Co/yr'},
  {name:'Kolwezi',company:'Various',mineral:'Cobalt',type:'Mine',country:'DRC',lat:-10.72,lng:25.47,capacity:'Major cobalt hub'},
  {name:'Tongxiang Refinery',company:'Huayou Cobalt',mineral:'Cobalt',type:'Refinery',country:'China',lat:30.63,lng:120.57,capacity:'55,000t Co/yr'},
  {name:'Hoboken Refinery',company:'Umicore',mineral:'Cobalt',type:'Refinery',country:'Belgium',lat:51.22,lng:4.35,capacity:'8,000t Co/yr'},
  {name:'Kokkola Refinery',company:'Freeport Cobalt',mineral:'Cobalt',type:'Refinery',country:'Finland',lat:63.84,lng:23.13,capacity:'12,000t Co/yr'},
  // Nickel
  {name:'Norilsk Complex',company:'Norilsk Nickel',mineral:'Nickel',type:'Mine',country:'Russia',lat:69.35,lng:88.2,capacity:'204,000t Ni/yr'},
  {name:'Sudbury Basin',company:'Vale/Glencore',mineral:'Nickel',type:'Mine',country:'Canada',lat:46.49,lng:-81.0,capacity:'65,000t Ni/yr'},
  {name:'IMIP (Morowali)',company:'Tsingshan',mineral:'Nickel',type:'Refinery',country:'Indonesia',lat:-2.85,lng:121.65,capacity:'500,000t NPI/yr'},
  {name:'Weda Bay',company:'Tsingshan',mineral:'Nickel',type:'Mine',country:'Indonesia',lat:0.4,lng:127.9,capacity:'250,000t NPI/yr'},
  {name:'Sorowako',company:'Vale',mineral:'Nickel',type:'Mine',country:'Indonesia',lat:-2.53,lng:121.35,capacity:'75,000t Ni matte/yr'},
  {name:'Murrin Murrin',company:'Glencore',mineral:'Nickel',type:'Mine',country:'Australia',lat:-29.0,lng:121.8,capacity:'35,000t Ni/yr'},
  {name:'Nickel West',company:'BHP',mineral:'Nickel',type:'Mine',country:'Australia',lat:-31.2,lng:121.5,capacity:'78,000t Ni/yr'},
  {name:'Voisey\'s Bay',company:'Vale',mineral:'Nickel',type:'Mine',country:'Canada',lat:56.33,lng:-62.08,capacity:'45,000t Ni/yr'},
  {name:'Onça Puma',company:'Vale',mineral:'Nickel',type:'Mine',country:'Brazil',lat:-6.58,lng:-51.05,capacity:'25,000t Ni/yr'},
  // Copper
  {name:'Escondida',company:'BHP',mineral:'Copper',type:'Mine',country:'Chile',lat:-24.27,lng:-69.07,capacity:'1,200,000t Cu/yr'},
  {name:'Grasberg',company:'Freeport-McMoRan',mineral:'Copper',type:'Mine',country:'Indonesia',lat:-4.05,lng:137.12,capacity:'700,000t Cu/yr'},
  {name:'Morenci',company:'Freeport-McMoRan',mineral:'Copper',type:'Mine',country:'USA',lat:33.08,lng:-109.35,capacity:'400,000t Cu/yr'},
  {name:'Chuquicamata',company:'Codelco',mineral:'Copper',type:'Mine',country:'Chile',lat:-22.29,lng:-68.9,capacity:'300,000t Cu/yr'},
  {name:'El Teniente',company:'Codelco',mineral:'Copper',type:'Mine',country:'Chile',lat:-34.09,lng:-70.35,capacity:'450,000t Cu/yr'},
  {name:'Kamoa-Kakula',company:'Ivanhoe Mines',mineral:'Copper',type:'Mine',country:'DRC',lat:-10.77,lng:25.27,capacity:'450,000t Cu/yr'},
  {name:'Cerro Verde',company:'Freeport-McMoRan',mineral:'Copper',type:'Mine',country:'Peru',lat:-16.54,lng:-71.6,capacity:'500,000t Cu/yr'},
  {name:'Olympic Dam',company:'BHP',mineral:'Copper',type:'Mine',country:'Australia',lat:-30.45,lng:136.88,capacity:'180,000t Cu/yr'},
  {name:'Buenavista del Cobre',company:'Southern Copper',mineral:'Copper',type:'Mine',country:'Mexico',lat:30.95,lng:-109.92,capacity:'350,000t Cu/yr'},
  {name:'Highland Valley',company:'Teck Resources',mineral:'Copper',type:'Mine',country:'Canada',lat:50.5,lng:-121.04,capacity:'120,000t Cu/yr'},
  {name:'QB2 (Quebrada Blanca)',company:'Teck Resources',mineral:'Copper',type:'Mine',country:'Chile',lat:-21.0,lng:-68.8,capacity:'300,000t Cu/yr'},
  {name:'Lumwana',company:'Barrick Gold',mineral:'Copper',type:'Mine',country:'Zambia',lat:-12.1,lng:25.85,capacity:'130,000t Cu/yr'},
  // Rare Earths
  {name:'Bayan Obo',company:'Northern Rare Earths',mineral:'Rare Earths',type:'Mine',country:'China',lat:41.8,lng:109.97,capacity:'70,000t REO/yr'},
  {name:'Mountain Pass',company:'MP Materials',mineral:'Rare Earths',type:'Mine',country:'USA',lat:35.48,lng:-115.53,capacity:'43,000t REO/yr'},
  {name:'Mt Weld',company:'Lynas Rare Earths',mineral:'Rare Earths',type:'Mine',country:'Australia',lat:-28.77,lng:122.37,capacity:'12,000t REO/yr'},
  {name:'Kuantan LAMP',company:'Lynas Rare Earths',mineral:'Rare Earths',type:'Refinery',country:'Malaysia',lat:3.8,lng:103.32,capacity:'12,000t REO/yr'},
  {name:'Ganzhou Ionic Clays',company:'China Southern RE',mineral:'Rare Earths',type:'Mine',country:'China',lat:25.85,lng:114.95,capacity:'35,000t REO/yr'},
  {name:'Fort Worth Magnetics',company:'MP Materials',mineral:'Rare Earths',type:'Refinery',country:'USA',lat:32.75,lng:-97.33,capacity:'1,000t NdFeB/yr'},
  {name:'Eneabba Refinery',company:'Iluka Resources',mineral:'Rare Earths',type:'Refinery',country:'Australia',lat:-29.82,lng:115.27,capacity:'2,500t REO/yr'},
  // Graphite
  {name:'Balama Mine',company:'Syrah Resources',mineral:'Graphite',type:'Mine',country:'Mozambique',lat:-13.35,lng:38.58,capacity:'350,000t/yr'},
  {name:'Inner Mongolia Plants',company:'BTR New Material',mineral:'Graphite',type:'Refinery',country:'China',lat:40.82,lng:111.65,capacity:'200,000t anode/yr'},
  {name:'Heilongjiang Mines',company:'Various',mineral:'Graphite',type:'Mine',country:'China',lat:47.35,lng:128.75,capacity:'Major graphite hub'},
  {name:'Vidalia AAM',company:'Syrah Resources',mineral:'Graphite',type:'Refinery',country:'USA',lat:31.27,lng:-91.43,capacity:'11,250t anode/yr'},
  {name:'Matawinie (dev)',company:'Nouveau Monde',mineral:'Graphite',type:'Mine',country:'Canada',lat:46.7,lng:-73.9,capacity:'100,000t/yr (planned)'},
  // Manganese
  {name:'GEMCO (Groote Eylandt)',company:'South32',mineral:'Manganese',type:'Mine',country:'Australia',lat:-14.0,lng:136.5,capacity:'5,800,000t ore/yr'},
  {name:'COMILOG (Moanda)',company:'Eramet',mineral:'Manganese',type:'Mine',country:'Gabon',lat:-1.55,lng:13.27,capacity:'7,200,000t ore/yr'},
  {name:'Nchwaning/Black Rock',company:'Assmang',mineral:'Manganese',type:'Mine',country:'South Africa',lat:-27.18,lng:22.8,capacity:'4,200,000t ore/yr'},
  {name:'Tshipi é Ntle',company:'Jupiter Mines',mineral:'Manganese',type:'Mine',country:'South Africa',lat:-27.2,lng:22.82,capacity:'3,600,000t ore/yr'},
  {name:'Balaghat Mines',company:'MOIL',mineral:'Manganese',type:'Mine',country:'India',lat:21.81,lng:80.19,capacity:'1,400,000t ore/yr'},
  // Gallium
  {name:'Shandong Alumina Refinery',company:'Chinalco',mineral:'Gallium',type:'Refinery',country:'China',lat:36.67,lng:116.98,capacity:'~120t Ga/yr'},
  {name:'Henan Alumina Refinery',company:'Chinalco',mineral:'Gallium',type:'Refinery',country:'China',lat:34.68,lng:112.43,capacity:'~80t Ga/yr'},
  // Germanium
  {name:'Chuxiong Mine',company:'Yunnan Germanium',mineral:'Germanium',type:'Mine',country:'China',lat:25.03,lng:101.55,capacity:'~60t Ge/yr'},
  {name:'Trail Smelter',company:'Teck Resources',mineral:'Germanium',type:'Refinery',country:'Canada',lat:49.1,lng:-117.71,capacity:'~15t Ge/yr'},
  {name:'Hoboken Ge Refinery',company:'Umicore',mineral:'Germanium',type:'Refinery',country:'Belgium',lat:51.22,lng:4.35,capacity:'~12t Ge/yr'},
  // Tungsten
  {name:'Hunan Tungsten Mines',company:'China Minmetals',mineral:'Tungsten',type:'Mine',country:'China',lat:25.79,lng:113.15,capacity:'20,000t W/yr'},
  {name:'Jiangxi Tungsten Mines',company:'Xiamen Tungsten',mineral:'Tungsten',type:'Mine',country:'China',lat:25.5,lng:114.5,capacity:'12,000t W/yr'},
  {name:'Mittersill Mine',company:'Wolfram Bergbau',mineral:'Tungsten',type:'Mine',country:'Austria',lat:47.27,lng:12.47,capacity:'1,500t W/yr'},
  {name:'Hemerdon (closed)',company:'Tungsten West',mineral:'Tungsten',type:'Mine',country:'UK',lat:50.4,lng:-4.0,capacity:'3,000t WO3/yr'},
  // Vanadium
  {name:'Panzhihua Complex',company:'Pangang Group',mineral:'Vanadium',type:'Mine',country:'China',lat:26.58,lng:101.72,capacity:'32,000t V₂O₅/yr'},
  {name:'Vametco',company:'Bushveld Minerals',mineral:'Vanadium',type:'Mine',country:'South Africa',lat:-25.4,lng:27.8,capacity:'2,700t V₂O₅/yr'},
  {name:'Maracás Menchen',company:'Largo Inc',mineral:'Vanadium',type:'Mine',country:'Brazil',lat:-13.44,lng:-40.43,capacity:'11,500t V₂O₅/yr'},
  {name:'Nizhny Tagil (NTMK)',company:'Evraz',mineral:'Vanadium',type:'Mine',country:'Russia',lat:56.82,lng:60.22,capacity:'18,000t V₂O₅/yr'},
  // PGMs
  {name:'Mogalakwena',company:'Anglo American Platinum',mineral:'Platinum Group',type:'Mine',country:'South Africa',lat:-23.63,lng:28.73,capacity:'1,200,000 oz PGMs/yr'},
  {name:'Rustenburg Operations',company:'Impala Platinum',mineral:'Platinum Group',type:'Mine',country:'South Africa',lat:-25.67,lng:27.24,capacity:'800,000 oz PGMs/yr'},
  {name:'Marikana',company:'Sibanye-Stillwater',mineral:'Platinum Group',type:'Mine',country:'South Africa',lat:-25.71,lng:27.48,capacity:'650,000 oz PGMs/yr'},
  {name:'Stillwater',company:'Sibanye-Stillwater',mineral:'Platinum Group',type:'Mine',country:'USA',lat:45.38,lng:-109.88,capacity:'500,000 oz PGMs/yr'},
  {name:'Zimplats',company:'Impala Platinum',mineral:'Platinum Group',type:'Mine',country:'Zimbabwe',lat:-19.0,lng:30.2,capacity:'600,000 oz PGMs/yr'},
  {name:'Kola Peninsula',company:'Norilsk Nickel',mineral:'Platinum Group',type:'Refinery',country:'Russia',lat:68.97,lng:33.08,capacity:'PGM refining'},
  // Uranium
  {name:'ISL Central Kazakhstan',company:'Kazatomprom',mineral:'Uranium',type:'Mine',country:'Kazakhstan',lat:44.8,lng:65.5,capacity:'12,000t U₃O₈/yr'},
  {name:'ISL South Kazakhstan',company:'Kazatomprom',mineral:'Uranium',type:'Mine',country:'Kazakhstan',lat:41.5,lng:67.3,capacity:'10,500t U₃O₈/yr'},
  {name:'McArthur River',company:'Cameco',mineral:'Uranium',type:'Mine',country:'Canada',lat:57.77,lng:-105.08,capacity:'8,500t U₃O₈/yr'},
  {name:'Cigar Lake',company:'Cameco',mineral:'Uranium',type:'Mine',country:'Canada',lat:58.07,lng:-104.52,capacity:'6,800t U₃O₈/yr'},
  {name:'Rössing',company:'CNNC',mineral:'Uranium',type:'Mine',country:'Namibia',lat:-22.48,lng:15.18,capacity:'2,500t U₃O₈/yr'},
  {name:'Husab',company:'CGN/Swakop',mineral:'Uranium',type:'Mine',country:'Namibia',lat:-22.6,lng:15.1,capacity:'3,500t U₃O₈/yr'},
  {name:'Tricastin Enrichment',company:'Orano',mineral:'Uranium',type:'Refinery',country:'France',lat:44.33,lng:4.72,capacity:'7.5M SWU/yr'},
  {name:'Piketon (HALEU)',company:'Centrus Energy',mineral:'Uranium',type:'Refinery',country:'USA',lat:39.0,lng:-83.0,capacity:'900kg HALEU/yr'},
  // Silicon
  {name:'Leshan Polysilicon',company:'Tongwei',mineral:'Silicon',type:'Refinery',country:'China',lat:29.57,lng:103.77,capacity:'200,000t poly/yr'},
  {name:'Baotou Polysilicon',company:'Tongwei',mineral:'Silicon',type:'Refinery',country:'China',lat:40.66,lng:109.84,capacity:'150,000t poly/yr'},
  {name:'Shihezi Plant',company:'Daqo New Energy',mineral:'Silicon',type:'Refinery',country:'China',lat:44.3,lng:86.05,capacity:'195,000t poly/yr'},
  {name:'Burghausen',company:'Wacker Chemie',mineral:'Silicon',type:'Refinery',country:'Germany',lat:48.17,lng:12.83,capacity:'50,000t poly/yr'},
  {name:'Charleston TN',company:'Wacker Chemie',mineral:'Silicon',type:'Refinery',country:'USA',lat:35.29,lng:-84.76,capacity:'20,000t poly/yr'},
  {name:'Moses Lake',company:'REC Silicon',mineral:'Silicon',type:'Refinery',country:'USA',lat:47.13,lng:-119.28,capacity:'18,000t poly/yr'},
];

// ══════════════════════════════════════════════════════════════
// NAVIGATION
// ══════════════════════════════════════════════════════════════
const pillsEl=document.getElementById('pills');
const sections=[
  {id:'overview',label:'Overview',fn:showOverview},
  {id:'sankey',label:'Supply Chain Flow',fn:showSankey},
  {id:'trade',label:'Trade Flows',fn:showTrade},
  {id:'pricing',label:'Pricing',fn:showPricingView},
  {id:'companies',label:'Companies',fn:showCompanies},
  {id:'minemap',label:'Mine Map',fn:showMineMap},
  {id:'alerts',label:'Alerts',fn:showAlerts},
  {id:'api',label:'API',fn:showAPIView},
];
sections.forEach(s=>{
  const p=document.createElement('div');
  p.className='pill section-pill'+(s.id==='overview'?' active':'');
  p.textContent=s.label;
  p.dataset.section=s.id;
  p.onclick=s.fn;
  pillsEl.appendChild(p);
});

const sep=document.createElement('div');
sep.className='pill-separator';
pillsEl.appendChild(sep);

Object.keys(MINERALS).forEach(m=>{
  const p=document.createElement('div');p.className='pill';p.textContent=m;
  p.onclick=()=>showMineral(m);pillsEl.appendChild(p);
});

// Populate trade mineral selector
const tradeSelect=document.getElementById('trade-mineral-select');
Object.keys(TRADE_DATA).forEach(m=>{
  const o=document.createElement('option');o.value=m;o.textContent=m;
  tradeSelect.appendChild(o);
});

// Populate company mineral filter
const ceMineralFilter=document.getElementById('ce-mineral-filter');
Object.keys(MINERALS).forEach(m=>{
  const o=document.createElement('option');o.value=m;o.textContent=m;
  ceMineralFilter.appendChild(o);
});

// Overview grid
const gridEl=document.getElementById('overview-grid');
Object.entries(MINERALS).forEach(([name,d])=>{
  const risk=riskLevel(d.importReliance);
  const card=document.createElement('div');
  card.className='mineral-card';
  card.onclick=()=>showMineral(name);
  const watched = isWatched('mineral',name);
  card.innerHTML=`
    <div class="mc-top">
      <div class="mc-top-row">
        <div class="mc-name">${name}</div>
        <button class="watch-btn ${watched?'watched':''}" onclick="event.stopPropagation();toggleWatch('mineral','${name}',this)" title="${watched?'Remove from watchlist':'Add to watchlist'}">★</button>
      </div>
      <span class="mc-badge ${risk}">${risk==='high'?'High Risk':risk==='med'?'Moderate':'Lower'}</span>
    </div>
    <div class="mc-import ${risk}">${d.importLabel}</div>
    <div class="mc-sublabel">U.S. Net Import Reliance</div>
    <div class="mc-row"><span class="mc-label">Top Processor</span><span class="mc-val">${d.topProcessor}</span></div>
    <div class="mc-row"><span class="mc-label">China Refining</span><span class="mc-val">${d.chinaRefining}%</span></div>
  `;
  gridEl.appendChild(card);
});

function setActivePill(name){
  document.querySelectorAll('.pill').forEach(p=>{
    const sec=p.dataset.section;
    if(sec){
      const match=sections.find(s=>s.id===sec);
      p.classList.toggle('active',match&&match.label===name);
    } else {
      p.classList.toggle('active',p.textContent===name);
    }
  });
}

function hideAllViews(){
  document.getElementById('overview').style.display='none';
  document.getElementById('detail').classList.remove('active');
  document.getElementById('sankey-view').classList.remove('active');
  document.getElementById('trade-view').classList.remove('active');
  document.getElementById('pricing-view').classList.remove('active');
  document.getElementById('companies-view').classList.remove('active');
  document.getElementById('minemap-view').classList.remove('active');
  document.getElementById('alerts-view').classList.remove('active');
  document.getElementById('api-view').classList.remove('active');
  destroyCharts();
}

function showOverview(){hideAllViews();setActivePill('Overview');document.getElementById('overview').style.display=''}
function showSankey(){hideAllViews();setActivePill('Supply Chain Flow');document.getElementById('sankey-view').classList.add('active');renderSankey()}
function showTrade(){hideAllViews();setActivePill('Trade Flows');document.getElementById('trade-view').classList.add('active');renderTradeView()}
function showPricingView(){hideAllViews();setActivePill('Pricing');document.getElementById('pricing-view').classList.add('active');renderPricing()}
function showCompanies(){hideAllViews();setActivePill('Companies');document.getElementById('companies-view').classList.add('active');renderCompanyExplorer()}
function showMineMap(){hideAllViews();setActivePill('Mine Map');document.getElementById('minemap-view').classList.add('active');renderMineMap()}
function showAlerts(){hideAllViews();setActivePill('Alerts');document.getElementById('alerts-view').classList.add('active');renderAlerts()}
function showAPIView(){hideAllViews();setActivePill('API');document.getElementById('api-view').classList.add('active')}

function showMineral(name){
  hideAllViews();
  setActivePill(name);
  const d=MINERALS[name];
  document.getElementById('detail').classList.add('active');
  document.getElementById('detail-title').textContent=name;

  const risk=riskLevel(d.importReliance);
  const gaugeColor=risk==='high'?'var(--red)':risk==='med'?'var(--orange)':'var(--green)';
  const pct=d.importReliance;

  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card">
      <div class="stat-label">Import Reliance</div>
      <div class="stat-value" style="color:${gaugeColor}">${d.importLabel}</div>
      <div style="margin-top:.75rem"><div class="gauge-bar-track"><div class="gauge-bar-fill" style="width:${pct}%;background:${gaugeColor}"></div></div></div>
    </div>
    <div class="stat-card">
      <div class="stat-label">China Refining</div>
      <div class="stat-value" style="color:${d.chinaRefining>=70?'var(--red)':d.chinaRefining>=40?'var(--orange)':'var(--green)'}">${d.chinaRefining}%</div>
      <div class="stat-sub">of global processing</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Top Processor</div>
      <div class="stat-value" style="font-size:1.25rem;margin-top:.25rem">${d.topProcessor.split(' (')[0]}</div>
      <div class="stat-sub">${d.topProcessor}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Risk Level</div>
      <div class="stat-value" style="color:${gaugeColor}">${risk==='high'?'HIGH':risk==='med'?'MOD.':'LOW'}</div>
      <div class="stat-sub">supply chain vulnerability</div>
    </div>
  `;

  const cc=chartColors();
  const ttOpts = {
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,titleFont:{family:'Geist',weight:'600'},bodyFont:{family:'Geist Mono'},padding:10,cornerRadius:8,
  };

  charts.mining=new Chart(document.getElementById('miningChart').getContext('2d'),{type:'bar',data:{
    labels:d.mining.map(x=>x[0]),datasets:[{data:d.mining.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.mining.length),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttOpts,callbacks:{title:c=>`${name} — Mining`,label:c=>`${c.label}: ${c.raw}% of global production`}}},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.refining=new Chart(document.getElementById('refiningChart').getContext('2d'),{type:'bar',data:{
    labels:d.refining.map(x=>x[0]),datasets:[{data:d.refining.map(x=>x[1]),backgroundColor:d.refining.map(x=>x[0]==='China'?'#ef4444':COLORS[1]),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttOpts,callbacks:{title:c=>`${name} — Refining`,label:c=>`${c.label}: ${c.raw}% of global processing`}}},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.uses=new Chart(document.getElementById('usesChart').getContext('2d'),{type:'doughnut',data:{
    labels:d.uses.map(x=>x[0]),datasets:[{data:d.uses.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.uses.length),borderWidth:0,hoverOffset:6}]
  },options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{color:cc.legendText,font:{size:11,family:'Geist'},padding:8,usePointStyle:true,pointStyleWidth:8}},tooltip:{...ttOpts,callbacks:{title:c=>`${name} — End Uses`,label:c=>`${c.label}: ${c.raw}%`}}}}});

  document.getElementById('company-list').innerHTML=d.companies.map(([n,c])=>{
    const hasData = COMPANY_DB[n];
    if(hasData) return `<div class="company-tag" onclick="openCompanyPanel('${n.replace(/'/g,"\\'")}')">${n}<span class="co-country">${c}</span></div>`;
    return `<div class="company-tag">${n}<span class="co-country">${c}</span></div>`;
  }).join('');
}

// ── TRADE FLOWS RENDERING ──
function renderTradeView(){
  destroyCharts();
  const mineral=document.getElementById('trade-mineral-select').value;
  const d=TRADE_DATA[mineral];
  if(!d) return;

  const content=document.getElementById('trade-content');
  const fmtNum=n=>n>=1000?n.toLocaleString():n;
  const fmtVal=v=>v>=1000?'$'+v.toLocaleString()+'M':'$'+v+'M';
  const chgHtml=v=>`<span class="${v>=0?'change-pos':'change-neg'}">${v>=0?'▲':'▼'} ${Math.abs(v)}%</span>`;

  const sortedFlows = [...d.flows].sort((a,b)=>b[2]-a[2]).slice(0,10);

  let html=`
    <div style="margin-bottom:.75rem;font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">
      HS Code: ${d.hsCode} · Unit: ${d.unit} · Global trade volume: ~${fmtNum(d.globalTrade)} tonnes
    </div>
    <div class="trade-tables-grid">
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Exporters</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.exporters.map(e=>`<tr><td><span class="clickable-country" onclick="openCountryModal('${e.country}','${mineral}')">${COUNTRY_FLAGS[e.country]||''} ${e.country}</span></td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
        <div style="padding:.5rem 1rem;text-align:right"><button class="copy-btn" onclick="copyTableData(this.closest('.data-table-wrap').querySelector('table'),this)">Copy</button></div>
      </div>
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Importers</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.importers.map(e=>`<tr><td><span class="clickable-country" onclick="openCountryModal('${e.country}','${mineral}')">${COUNTRY_FLAGS[e.country]||''} ${e.country}</span></td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
        <div style="padding:.5rem 1rem;text-align:right"><button class="copy-btn" onclick="copyTableData(this.closest('.data-table-wrap').querySelector('table'),this)">Copy</button></div>
      </div>
    </div>
    <div class="us-import-card">
      <h3>U.S. Import Sources — ${mineral}</h3>
      ${d.usImports.map(u=>`
        <div class="us-bar" onclick="openCountryModal('${u.country}','${mineral}')">
          <span class="us-bar-country">${COUNTRY_FLAGS[u.country]||''} ${u.country}</span>
          <div class="us-bar-track"><div class="us-bar-fill" style="width:${u.pct}%;background:${u.country==='China'?'var(--red)':'var(--accent)'}"></div></div>
          <span class="us-bar-pct">${u.pct}%</span>
        </div>
      `).join('')}
    </div>
    <div class="flow-table-wrap">
      <h3>Top Bilateral Trade Routes — ${mineral}</h3>
      <table class="data-table" id="flow-table">
        <thead><tr><th style="width:30px">#</th><th>Route</th><th class="num sortable" onclick="sortFlowTable()" style="cursor:pointer">Value ($M) ↓</th></tr></thead>
        <tbody>${sortedFlows.map(([from,to,val],i)=>`
          <tr><td style="color:var(--text-muted);font-family:var(--font-mono);font-size:.75rem">${i+1}</td>
          <td><span class="clickable-country" onclick="openCountryModal('${from}','${mineral}')">${COUNTRY_FLAGS[from]||''} ${from}</span><span style="color:var(--text-muted);margin:0 .5rem">→</span><span class="clickable-country" onclick="openCountryModal('${to}','${mineral}')">${COUNTRY_FLAGS[to]||''} ${to}</span></td>
          <td class="num">$${val.toLocaleString()}M</td></tr>
        `).join('')}</tbody>
      </table>
    </div>`;
  content.innerHTML=html;
}

let flowSortAsc = false;
function sortFlowTable(){
  const mineral=document.getElementById('trade-mineral-select').value;
  const d=TRADE_DATA[mineral];
  if(!d) return;
  flowSortAsc = !flowSortAsc;
  const sorted = [...d.flows].sort((a,b)=>flowSortAsc?a[2]-b[2]:b[2]-a[2]).slice(0,10);
  const arrow = flowSortAsc?'↑':'↓';
  document.querySelector('#flow-table th.sortable').textContent = 'Value ($M) '+arrow;
  document.querySelector('#flow-table tbody').innerHTML = sorted.map(([from,to,val],i)=>`
    <tr><td style="color:var(--text-muted);font-family:var(--font-mono);font-size:.75rem">${i+1}</td>
    <td><span class="clickable-country" onclick="openCountryModal('${from}','${mineral}')">${COUNTRY_FLAGS[from]||''} ${from}</span><span style="color:var(--text-muted);margin:0 .5rem">→</span><span class="clickable-country" onclick="openCountryModal('${to}','${mineral}')">${COUNTRY_FLAGS[to]||''} ${to}</span></td>
    <td class="num">$${val.toLocaleString()}M</td></tr>
  `).join('');
}

// ── PRICING RENDERING ──
function renderPricing(){
  destroyCharts();
  const grid=document.getElementById('pricing-grid');
  grid.innerHTML='';
  const cc=chartColors();
  const dark=getTheme()==='dark';

  Object.entries(PRICING_DATA).forEach(([name,d],idx)=>{
    const card=document.createElement('div');
    card.className='pricing-card';
    const dir=d.yoyChange>=0?'up':'down';
    const arrow=d.yoyChange>=0?'▲':'▼';
    const fmtPrice=d.current>=1000?'$'+d.current.toLocaleString():'$'+d.current;

    card.innerHTML=`
      <div class="pricing-card-header">
        <div class="pricing-card-left"><h3>${name}</h3><span class="pricing-unit">${d.unit}</span></div>
        <div class="pricing-current"><div class="price-big">${fmtPrice}</div><div class="price-change ${dir}">${arrow} ${Math.abs(d.yoyChange)}% YoY</div></div>
      </div>
      <div class="pricing-chart-wrap"><canvas id="priceChart${idx}"></canvas></div>
    `;
    grid.appendChild(card);

    const ctx=document.getElementById('priceChart'+idx).getContext('2d');
    charts['price'+idx]=new Chart(ctx,{
      type:'line',
      data:{labels:d.labels,datasets:[{data:d.prices,borderColor:d.color,backgroundColor:d.color+'18',fill:true,tension:.3,pointRadius:0,pointHitRadius:8,borderWidth:2}]},
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{
          backgroundColor:dark?'#131316':'#ffffff',titleColor:dark?'#fafafa':'#09090b',bodyColor:dark?'#a1a1aa':'#52525b',
          borderColor:dark?'#27272a':'#e4e4e7',borderWidth:1,titleFont:{family:'Geist',weight:'600'},bodyFont:{family:'Geist Mono'},padding:10,cornerRadius:8,
          callbacks:{title:c=>c[0].label,label:c=>{const v=c.raw;if(d.unit.includes('/kg'))return`${name}: $${v}/kg`;if(d.unit.includes('/lb'))return`${name}: $${v}/lb`;if(d.unit.includes('/mtu'))return`${name}: $${v}/mtu`;if(d.unit.includes('/oz'))return`${name}: $${v}/oz`;return`${name}: $${v.toLocaleString()}`}}
        }},
        scales:{
          x:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},maxRotation:0,maxTicksLimit:7}},
          y:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},callback:v=>{if(d.unit.includes('/kg'))return'$'+v;if(d.unit.includes('/lb'))return'$'+v;if(d.unit.includes('/mtu'))return'$'+v;if(d.unit.includes('/oz'))return'$'+v;return'$'+v.toLocaleString()}},beginAtZero:false}
        },
        interaction:{intersect:false,mode:'index'}
      }
    });
  });
}

// ══════════════════════════════════════════════════════════════
// COMPANY EXPLORER
// ══════════════════════════════════════════════════════════════
let ceRoleFilter = 'All';

function setCERole(role, el){
  ceRoleFilter = role;
  document.querySelectorAll('#ce-role-filters .ce-filter').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderCompanyExplorer();
}

function parseMcap(s){
  if(!s || s==='Private' || s==='State-owned') return 0;
  const num = parseFloat(s.replace(/[^0-9.]/g,''));
  return num || 0;
}

function renderCompanyExplorer(){
  const query = document.getElementById('ce-search').value.toLowerCase();
  const mineralFilter = document.getElementById('ce-mineral-filter').value;
  const sortBy = document.getElementById('ce-sort').value;
  const grid = document.getElementById('ce-grid');

  let entries = Object.entries(COMPANY_DB);

  // Filter
  entries = entries.filter(([name,co])=>{
    if(query && !name.toLowerCase().includes(query)) return false;
    if(ceRoleFilter !== 'All' && co.role !== ceRoleFilter) return false;
    if(mineralFilter !== 'All' && !co.minerals.includes(mineralFilter)) return false;
    return true;
  });

  // Sort
  if(sortBy==='mcap') entries.sort((a,b)=>(b[1].mcapNum||0)-(a[1].mcapNum||0));
  else if(sortBy==='name') entries.sort((a,b)=>a[0].localeCompare(b[0]));
  else if(sortBy==='country') entries.sort((a,b)=>a[1].country.localeCompare(b[1].country));

  if(!entries.length){
    grid.innerHTML='<div class="ce-no-results">No companies match your filters</div>';
    return;
  }

  grid.innerHTML = entries.map(([name,co])=>`
    <div class="ce-card" onclick="openCompanyPanel('${name.replace(/'/g,"\\'")}')">
      <div class="ce-card-top">
        <div>
          <div class="ce-card-name">${name}</div>
          <div class="ce-card-ticker">${co.flag} ${co.ticker}</div>
        </div>
        <span class="ce-card-flag" style="font-size:1.5rem">${co.flag}</span>
      </div>
      <div class="ce-card-meta">
        <span class="ce-card-mcap">${co.mcap}</span>
        <span class="ce-card-role">${co.role}</span>
      </div>
      <div class="ce-card-minerals">${co.minerals.map(m=>`<span class="ce-mineral-pill" style="background:${MINERAL_COLORS[m]||'#3b82f6'}">${m}</span>`).join('')}</div>
    </div>
  `).join('');
}

// ══════════════════════════════════════════════════════════════
// MINE MAP
// ══════════════════════════════════════════════════════════════
let mmMineralFilter = 'All';
let mmTypeFilter = 'All';

// Build mineral filters for mine map
(function(){
  const wrap = document.getElementById('mm-mineral-filters');
  const allBtn = document.createElement('button');
  allBtn.className='ce-filter active';allBtn.textContent='All Minerals';allBtn.dataset.mmMineral='All';
  allBtn.onclick=()=>{mmMineralFilter='All';updateMMFilters();renderMineMap()};
  wrap.appendChild(allBtn);
  Object.keys(MINERAL_COLORS).forEach(m=>{
    const b=document.createElement('button');b.className='ce-filter';b.textContent=m;b.dataset.mmMineral=m;
    b.onclick=()=>{mmMineralFilter=m;updateMMFilters();renderMineMap()};
    wrap.appendChild(b);
  });
})();

function updateMMFilters(){
  document.querySelectorAll('#mm-mineral-filters .ce-filter').forEach(b=>{
    b.classList.toggle('active',(mmMineralFilter==='All'&&b.dataset.mmMineral==='All')||b.dataset.mmMineral===mmMineralFilter);
  });
}

function setMMType(type,el){
  mmTypeFilter=type;
  el.parentElement.querySelectorAll('.ce-filter').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  renderMineMap();
}

let mapboxMap = null;
let mapboxPopup = null;
let mapboxHoverPopup = null;

function getMapStyle(){
  return getTheme()==='dark' ? 'mapbox://styles/mapbox/dark-v11' : 'mapbox://styles/mapbox/light-v11';
}

function buildGeoJSON(){
  return {
    type:'FeatureCollection',
    features: FACILITIES_DB.map((f,i)=>({
      type:'Feature',
      id:i,
      geometry:{type:'Point',coordinates:[f.lng,f.lat]},
      properties:{name:f.name,company:f.company,mineral:f.mineral,type:f.type,country:f.country,capacity:f.capacity,color:MINERAL_COLORS[f.mineral]||'#3b82f6'}
    }))
  };
}

function getMapFilters(){
  const filters = ['all'];
  if(mmMineralFilter!=='All') filters.push(['==',['get','mineral'],mmMineralFilter]);
  if(mmTypeFilter==='Mine') filters.push(['==',['get','type'],'Mine']);
  if(mmTypeFilter==='Refinery') filters.push(['==',['get','type'],'Refinery']);
  return filters.length===1 ? null : filters;
}

function applyMapFilters(){
  if(!mapboxMap || !mapboxMap.getLayer('facilities-mines')) return;
  const f = getMapFilters();
  const mineFilter = f ? ['all',...f.slice(1),['==',['get','type'],'Mine']] : ['==',['get','type'],'Mine'];
  const refFilter = f ? ['all',...f.slice(1),['==',['get','type'],'Refinery']] : ['==',['get','type'],'Refinery'];
  mapboxMap.setFilter('facilities-mines', mineFilter);
  mapboxMap.setFilter('facilities-refineries', refFilter);
  mapboxMap.setFilter('facilities-refinery-border', refFilter);
}

function setupMapLayers(){
  const geojson = buildGeoJSON();
  if(mapboxMap.getSource('facilities')) mapboxMap.removeSource('facilities');

  // Remove old layers if exist
  ['facilities-mines','facilities-refineries','facilities-refinery-border'].forEach(id=>{
    if(mapboxMap.getLayer(id)) mapboxMap.removeLayer(id);
  });
  if(mapboxMap.getSource('facilities')) mapboxMap.removeSource('facilities');

  mapboxMap.addSource('facilities',{type:'geojson',data:geojson});

  // Mines - circles
  mapboxMap.addLayer({
    id:'facilities-mines',type:'circle',source:'facilities',
    filter:['==',['get','type'],'Mine'],
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],1,4,5,7,10,10],
      'circle-color':['get','color'],
      'circle-opacity':0.85,
      'circle-stroke-width':1,
      'circle-stroke-color':getTheme()==='dark'?'#09090b':'#ffffff'
    }
  });

  // Refineries - larger circles with thicker border
  mapboxMap.addLayer({
    id:'facilities-refinery-border',type:'circle',source:'facilities',
    filter:['==',['get','type'],'Refinery'],
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],1,6,5,9,10,13],
      'circle-color':getTheme()==='dark'?'#09090b':'#ffffff',
      'circle-opacity':1,
      'circle-stroke-width':0
    }
  });
  mapboxMap.addLayer({
    id:'facilities-refineries',type:'circle',source:'facilities',
    filter:['==',['get','type'],'Refinery'],
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],1,5,5,8,10,12],
      'circle-color':['get','color'],
      'circle-opacity':0.85,
      'circle-stroke-width':2,
      'circle-stroke-color':getTheme()==='dark'?'#09090b':'#ffffff'
    }
  });

  applyMapFilters();

  // Hover popup
  mapboxHoverPopup = new mapboxgl.Popup({closeButton:false,closeOnClick:false,offset:12,className:'mm-hover-popup'});

  const interactiveLayers = ['facilities-mines','facilities-refineries'];

  interactiveLayers.forEach(layerId=>{
    mapboxMap.on('mouseenter',layerId,e=>{
      mapboxMap.getCanvas().style.cursor='pointer';
      const f=e.features[0].properties;
      const icon = f.type==='Mine'?'⛏':'⚙';
      mapboxHoverPopup.setLngLat(e.features[0].geometry.coordinates)
        .setHTML(`<div class="mm-popup-name">${icon} ${f.name}</div><div class="mm-popup-company">${f.company} · ${f.country}</div><div class="mm-popup-detail">${f.mineral} · ${f.capacity}</div><div class="mm-popup-type">${f.type}</div>`)
        .addTo(mapboxMap);
    });
    mapboxMap.on('mouseleave',layerId,()=>{
      mapboxMap.getCanvas().style.cursor='';
      mapboxHoverPopup.remove();
    });
    mapboxMap.on('click',layerId,e=>{
      const f=e.features[0].properties;
      const coName = Object.keys(COMPANY_DB).find(name=>f.company.includes(name));
      if(coName) openCompanyPanel(coName);
    });
  });
}

function renderMineMap(){
  const container = document.getElementById('mm-map-container');

  if(!mapboxMap){
    mapboxgl.accessToken=['pk.eyJ1Ijoib3dlbi1jb29uYWhhbiIsImEiOiJjbWow','dmR2a20wZDVtM2Vwem5idGFpYm5vIn0.','cgIL7QDk0gaaueSLBi8cjQ'].join('');
    container.innerHTML='';
    mapboxMap = new mapboxgl.Map({
      container:container,
      style:getMapStyle(),
      center:[20,20],
      zoom:1.5,
      scrollZoom:true,
      dragPan:true,
      attributionControl:true,
    });
    mapboxMap.addControl(new mapboxgl.NavigationControl(),'top-right');
    mapboxMap.on('style.load',()=>{setupMapLayers()});
  } else {
    applyMapFilters();
  }

  // Legend
  const legendEl = document.getElementById('mm-legend');
  const shownMinerals = mmMineralFilter==='All' ? Object.keys(MINERAL_COLORS) : [mmMineralFilter];
  legendEl.innerHTML = shownMinerals.map(m=>`<span><div class="mm-legend-dot" style="background:${MINERAL_COLORS[m]}"></div>${m}</span>`).join('') +
    '<span><div class="mm-legend-dot" style="background:transparent;border:2px solid var(--text-muted)"></div>Mine</span>' +
    '<span><div class="mm-legend-sq" style="background:transparent;border:2px solid var(--text-muted)"></div>Refinery</span>';
}

function switchMapboxStyle(){
  if(mapboxMap){
    mapboxMap.setStyle(getMapStyle());
  }
}

// ── SANKEY DIAGRAM ──
let sankeyActiveFilter='All';

function mapToSector(use){
  const u=use.toLowerCase();
  if(u.includes('ev batter')||u.includes('battery anode'))return 'EVs / Batteries';
  if(u.includes('grid')||u.includes('flow batter')||u.includes('nuclear')||u.includes('solar')||u.includes('hydrogen')||u.includes('fuel cell'))return 'Grid / Energy';
  if(u.includes('defense')||u.includes('naval')||u.includes('night vision')||u.includes('ir optic')||u.includes('aerospace')||u.includes('cutting tool')||u.includes('carbide')||u.includes('mill product')||u.includes('steels/alloy'))return 'Defense / Industrial';
  if(u.includes('semiconductor')||u.includes('gaas')||u.includes('led')||u.includes('optoelectronic')||u.includes('fiber optic')||u.includes('electronic'))return 'Semiconductors / Electronics';
  if(u.includes('portable')||u.includes('consumer')||u.includes('jewelry')||u.includes('plating'))return 'Consumer Products';
  if(u.includes('steel')||u.includes('aluminum')||u.includes('alloy')||u.includes('construction')||u.includes('foundri')||u.includes('industrial')||u.includes('transport'))return 'Heavy Industry';
  return 'Other Industrial';
}

function buildSankeyData(filterMineral){
  const minerals=filterMineral==='All'?SANKEY_MINERALS:[filterMineral];
  const nodeMap={};const links=[];let nodeId=0;
  function getNode(name){if(!(name in nodeMap)){nodeMap[name]=nodeId++}return nodeMap[name]}

  minerals.forEach(mName=>{
    const d=MINERALS[mName];const color=MINERAL_COLORS[mName];
    const topMining=d.mining.filter(x=>x[0]!=='Other').slice(0,4);
    const topRefining=d.refining.filter(x=>x[0]!=='Other').slice(0,3);
    const sectors={};
    d.uses.forEach(([use,pct])=>{const s=mapToSector(use);sectors[s]=(sectors[s]||0)+pct});

    topMining.forEach(([country,pct])=>{
      const src='⛏ '+country;
      topRefining.forEach(([rCountry,rPct])=>{
        const tgt='⚙ '+rCountry;const val=Math.round(pct*rPct/100*10)/10;
        if(val>0.5) links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
      });
    });

    topRefining.forEach(([rCountry,rPct])=>{
      const src='⚙ '+rCountry;
      Object.entries(sectors).forEach(([sector,sPct])=>{
        const tgt='📦 '+sector;const val=Math.round(rPct*sPct/100*10)/10;
        if(val>0.5) links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
      });
    });
  });

  const nodes=Object.entries(nodeMap).map(([name,id])=>({name,id})).sort((a,b)=>a.id-b.id);
  return{nodes,links};
}

function renderSankey(){
  const container=document.getElementById('sankey-container');
  container.innerHTML='';
  const dark=getTheme()==='dark';
  const w=container.clientWidth-20;
  const h=Math.max(500,Math.min(700,w*0.55));

  const data=buildSankeyData(sankeyActiveFilter);
  if(!data.links.length){container.innerHTML='<p style="color:var(--text-muted);padding:2rem;text-align:center">No flow data for this selection.</p>';return}

  const svg=d3.select(container).append('svg').attr('width',w).attr('height',h);

  const sankey=d3.sankey().nodeId(d=>d.id).nodeWidth(14).nodePadding(10).nodeAlign(d3.sankeyLeft).extent([[1,1],[w-1,h-6]]);

  const graph=sankey({nodes:data.nodes.map(d=>({...d})),links:data.links.map(d=>({...d}))});

  const tooltip=document.getElementById('sankey-tooltip');
  function showTip(evt,html){
    tooltip.querySelector('.tt-title').innerHTML=html.title||'';
    tooltip.querySelector('.tt-val').innerHTML=html.val||'';
    tooltip.querySelector('.tt-sub').innerHTML=html.sub||'';
    tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px';
    tooltip.classList.add('visible');
  }
  function hideTip(){tooltip.classList.remove('visible')}

  const link=svg.append('g').attr('fill','none').selectAll('g').data(graph.links).join('g').attr('class','sankey-link');

  link.append('path')
    .attr('d',d3.sankeyLinkHorizontal())
    .attr('stroke',d=>d.color||'#3b82f6').attr('stroke-opacity',.35)
    .attr('stroke-width',d=>Math.max(1,d.width))
    .on('mouseover',function(evt,d){d3.select(this).attr('stroke-opacity',.7);showTip(evt,{title:d.mineral,val:`${d.source.name} → ${d.target.name}`,sub:`Flow weight: ${d.value}`})})
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px'})
    .on('mouseout',function(){d3.select(this).attr('stroke-opacity',.35);hideTip()});

  let selectedNode=null;
  const node=svg.append('g').selectAll('g').data(graph.nodes).join('g');

  node.append('rect')
    .attr('x',d=>d.x0).attr('y',d=>d.y0)
    .attr('height',d=>Math.max(1,d.y1-d.y0)).attr('width',sankey.nodeWidth())
    .attr('fill',d=>{if(d.name.startsWith('⛏'))return dark?'#a1a1aa':'#52525b';if(d.name.startsWith('⚙'))return dark?'#ef4444':'#dc2626';return dark?'#3b82f6':'#2563eb'})
    .attr('rx',3).attr('cursor','pointer')
    .on('mouseover',function(evt,d){showTip(evt,{title:d.name,val:`Total flow: ${Math.round(d.value)}`,sub:`${d.sourceLinks.length} outgoing · ${d.targetLinks.length} incoming`})})
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px'})
    .on('mouseout',function(){hideTip()})
    .on('click',function(evt,d){
      if(selectedNode===d){selectedNode=null;svg.selectAll('path').attr('stroke-opacity',.35);return}
      selectedNode=d;const connectedLinks=new Set();
      d.sourceLinks.forEach(l=>connectedLinks.add(l.index));d.targetLinks.forEach(l=>connectedLinks.add(l.index));
      svg.selectAll('.sankey-link path').attr('stroke-opacity',(l,i)=>connectedLinks.has(i)?.7:.08);
    });

  node.append('text')
    .attr('x',d=>d.x0<w/2?d.x1+6:d.x0-6).attr('y',d=>(d.y1+d.y0)/2).attr('dy','0.35em')
    .attr('text-anchor',d=>d.x0<w/2?'start':'end').text(d=>d.name)
    .attr('fill',dark?'#fafafa':'#09090b').attr('font-size','11px').attr('font-family','Geist, sans-serif');

  const legendEl=document.getElementById('sankey-legend');legendEl.innerHTML='';
  const shownMinerals=sankeyActiveFilter==='All'?SANKEY_MINERALS:[sankeyActiveFilter];
  shownMinerals.forEach(m=>{const s=document.createElement('span');s.innerHTML=`<div class="sankey-legend-dot" style="background:${MINERAL_COLORS[m]}"></div>${m}`;legendEl.appendChild(s)});
}

// Sankey filter pills
(function(){
  const wrap=document.getElementById('sankey-filters');
  const all=document.createElement('button');all.className='sankey-filter active';all.textContent='All Minerals';
  all.onclick=()=>{sankeyActiveFilter='All';updateSankeyFilters();renderSankey()};wrap.appendChild(all);
  SANKEY_MINERALS.forEach(m=>{
    const b=document.createElement('button');b.className='sankey-filter';b.textContent=m;
    b.onclick=()=>{sankeyActiveFilter=m;updateSankeyFilters();renderSankey()};wrap.appendChild(b);
  });
})();
function updateSankeyFilters(){
  document.querySelectorAll('.sankey-filter').forEach(b=>{
    b.classList.toggle('active',(sankeyActiveFilter==='All'&&b.textContent==='All Minerals')||b.textContent===sankeyActiveFilter);
  });
}

// ══════════════════════════════════════════════════════════════
// V4: DATA SERVICE (Live Pricing)
// ══════════════════════════════════════════════════════════════
const DataService = {
  _cache: {},
  _lastFetch: null,
  _status: 'cached', // 'live' | 'cached' | 'loading'

  async fetchLivePricing() {
    this._status = 'loading';
    this._updateBadges();
    try {
      // Try World Bank API (CORS-friendly for some endpoints)
      const indicators = {
        'Copper': 'PCOPPUSDM',
        'Nickel': 'PNICKUSDM',
        'Uranium (U₃O₈)': 'PURAN',
        'Platinum': 'PPLAT',
      };
      const fetches = Object.entries(indicators).map(async ([name, code]) => {
        try {
          const url = `https://api.worldbank.org/v2/country/all/indicator/${code}?date=2024:2026&format=json&per_page=24`;
          const resp = await fetch(url, { signal: AbortSignal.timeout(8000) });
          if (!resp.ok) throw new Error('Not OK');
          const data = await resp.json();
          if (data[1] && data[1].length > 0) {
            const latest = data[1].find(d => d.value !== null);
            if (latest) {
              this._cache[name] = { value: Math.round(latest.value * 100) / 100, date: latest.date, source: 'World Bank' };
            }
          }
        } catch (e) { /* individual fetch failed, use fallback */ }
      });
      await Promise.allSettled(fetches);
      this._lastFetch = new Date();
      this._status = Object.keys(this._cache).length > 0 ? 'live' : 'cached';
    } catch (e) {
      this._status = 'cached';
    }
    this._updateBadges();
    return this._cache;
  },

  getPrice(name) {
    if (this._cache[name]) return this._cache[name];
    return null;
  },

  _updateBadges() {
    document.querySelectorAll('.pricing-data-badge').forEach(el => {
      el.className = 'data-badge pricing-data-badge ' + this._status;
      el.textContent = this._status === 'loading' ? '⟳ Loading' : this._status === 'live' ? '● Live' : '○ Cached';
    });
    const ts = document.getElementById('pricing-last-fetched');
    if (ts && this._lastFetch) {
      ts.textContent = 'Last fetched: ' + this._lastFetch.toLocaleTimeString();
    }
  }
};

// ══════════════════════════════════════════════════════════════
// V4: WATCHLIST / ALERTS SYSTEM
// ══════════════════════════════════════════════════════════════
function getWatchlist() {
  try { return JSON.parse(localStorage.getItem('cmt_watchlist') || '[]'); } catch(e) { return []; }
}
function saveWatchlist(wl) { localStorage.setItem('cmt_watchlist', JSON.stringify(wl)); }
function isWatched(type, name) { return getWatchlist().some(w => w.type === type && w.name === name); }

function toggleWatch(type, name, btn) {
  let wl = getWatchlist();
  const idx = wl.findIndex(w => w.type === type && w.name === name);
  if (idx >= 0) {
    wl.splice(idx, 1);
    if(btn){btn.classList.remove('watched');btn.title='Add to watchlist'}
  } else {
    wl.push({ type, name, threshold: 5, addedAt: Date.now() });
    if(btn){btn.classList.add('watched');btn.title='Remove from watchlist'}
  }
  saveWatchlist(wl);
}

const NEWS_ITEMS = [
  {headline:'China Tightens Rare Earth Export Controls Amid Trade Tensions',date:'Feb 14, 2026',source:'Reuters',summary:'Beijing imposes new licensing requirements on rare earth exports, affecting neodymium and dysprosium shipments to Western nations.',mineral:'Rare Earths'},
  {headline:'U.S. Approves $2.1B Loan for Arizona Lithium Processing Facility',date:'Feb 10, 2026',source:'DOE',summary:'Department of Energy backs domestic lithium hydroxide plant to reduce Chinese refining dependency.',mineral:'Lithium'},
  {headline:'DRC Cobalt Royalty Dispute Resolved After 6-Month Standoff',date:'Feb 7, 2026',source:'Mining Weekly',summary:'CMOC and DRC government reach agreement on revised royalty structure for Tenke Fungurume operations.',mineral:'Cobalt'},
  {headline:'Indonesia Nickel Export Ban Extended Through 2030',date:'Feb 3, 2026',source:'Bloomberg',summary:'Jakarta confirms raw nickel ore export prohibition will continue, pushing more domestic smelter investment.',mineral:'Nickel'},
  {headline:'Germanium Prices Surge 80% as China Export Restrictions Hold',date:'Jan 28, 2026',source:'Fastmarkets',summary:'Spot germanium prices hit decade highs as Western buyers scramble for non-Chinese supply from Belgium and Canada.',mineral:'Germanium'},
  {headline:'EU Critical Raw Materials Act: First Strategic Projects Designated',date:'Jan 22, 2026',source:'European Commission',summary:'12 mining and processing projects across Europe receive fast-track permitting under new CRMA framework.',mineral:'Rare Earths'},
  {headline:'Copper Hits $9,500/t on AI Data Center Demand Surge',date:'Jan 15, 2026',source:'Financial Times',summary:'Massive copper wiring needs for AI infrastructure push prices higher despite slowing Chinese construction.',mineral:'Copper'},
  {headline:'Trump Administration Imposes 25% Tariff on Chinese Graphite',date:'Jan 8, 2026',source:'WSJ',summary:'New tariffs target synthetic and natural graphite imports from China, accelerating domestic anode supply chain buildout.',mineral:'Graphite'},
  {headline:'Uranium Spot Price Breaks $80/lb on Nuclear Renaissance',date:'Jan 2, 2026',source:'UxC',summary:'Growing nuclear power commitments from 22 countries at COP30 drive uranium prices to 15-year highs.',mineral:'Uranium'},
  {headline:'Tungsten Added to China Export Control List',date:'Feb 12, 2026',source:'SCMP',summary:'China restricts tungsten exports citing national security, impacting global cutting tool and defense supply chains.',mineral:'Tungsten'},
];

function renderAlerts() {
  const wl = getWatchlist();
  const section = document.getElementById('watchlist-section');

  if (wl.length === 0) {
    section.innerHTML = '<div class="empty-watchlist">No items in your watchlist yet.<br><span style="font-size:.75rem;margin-top:.5rem;display:block">Star minerals, companies, or countries from anywhere in the app to track them here.</span></div>';
  } else {
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:.75rem">';
    wl.forEach((item, i) => {
      let icon = '⭐', meta = '', click = '';
      if (item.type === 'mineral') {
        const m = MINERALS[item.name];
        icon = '⚛️';
        meta = m ? `Import reliance: ${m.importLabel} · China refining: ${m.chinaRefining}%` : '';
        click = `showMineral('${item.name.replace(/'/g,"\\'")}')`;
      } else if (item.type === 'company') {
        const co = COMPANY_DB[item.name];
        icon = co ? co.flag : '🏢';
        meta = co ? `${co.mcap} · ${co.role}` : '';
        click = `openCompanyPanel('${item.name.replace(/'/g,"\\'")}')`;
      } else if (item.type === 'country') {
        icon = COUNTRY_FLAGS[item.name] || '🌐';
        meta = 'Country profile';
        click = `openCountryModal('${item.name.replace(/'/g,"\\'")}','Lithium')`;
      }
      html += `
        <div class="watchlist-card" onclick="${click}">
          <div class="wl-left">
            <span class="wl-icon">${icon}</span>
            <div><div class="wl-name">${item.name}</div><div class="wl-meta">${meta}</div></div>
          </div>
          <div class="wl-right">
            ${item.type === 'mineral' ? `<input type="number" class="threshold-input" value="${item.threshold||5}" min="1" max="50" title="Alert threshold %" onclick="event.stopPropagation()" onchange="updateThreshold(${i},this.value)">` : ''}
            <button class="wl-remove" onclick="event.stopPropagation();removeWatchItem(${i})" title="Remove">✕</button>
          </div>
        </div>`;
    });
    html += '</div>';
    section.innerHTML = html;
  }

  // Render news feed
  const feed = document.getElementById('news-feed');
  feed.innerHTML = NEWS_ITEMS.map(n => `
    <div class="news-card">
      <div class="news-headline">${n.headline}</div>
      <div class="news-meta"><span class="news-source">${n.source}</span><span>${n.date}</span></div>
      <div class="news-summary">${n.summary}</div>
      <span class="news-tag" style="background:${MINERAL_COLORS[n.mineral]||'#3b82f6'}">${n.mineral}</span>
    </div>
  `).join('');
}

function removeWatchItem(idx) {
  let wl = getWatchlist();
  wl.splice(idx, 1);
  saveWatchlist(wl);
  renderAlerts();
}

function updateThreshold(idx, val) {
  let wl = getWatchlist();
  if (wl[idx]) wl[idx].threshold = parseInt(val) || 5;
  saveWatchlist(wl);
}

// Check for alert conditions on load
function checkAlertBanner() {
  const wl = getWatchlist();
  const alerts = [];
  wl.forEach(item => {
    if (item.type === 'mineral') {
      // Check if any pricing data has significant YoY change
      const pricingKeys = Object.keys(PRICING_DATA);
      const match = pricingKeys.find(k => k.toLowerCase().includes(item.name.toLowerCase()));
      if (match) {
        const p = PRICING_DATA[match];
        if (Math.abs(p.yoyChange) >= (item.threshold || 5)) {
          alerts.push(`${item.name}: ${p.yoyChange > 0 ? '▲' : '▼'} ${Math.abs(p.yoyChange)}% YoY`);
        }
      }
    }
  });
  if (alerts.length > 0) {
    document.getElementById('alert-banner-text').textContent = 'Price alerts: ' + alerts.join(' · ');
    document.getElementById('alert-banner').style.display = 'flex';
  }
}

// ══════════════════════════════════════════════════════════════
// V4: GLOBAL SEARCH (Cmd+K)
// ══════════════════════════════════════════════════════════════
let searchActiveIdx = -1;

function openSearch() {
  document.getElementById('search-overlay').classList.add('open');
  const input = document.getElementById('search-input');
  input.value = '';
  input.focus();
  searchActiveIdx = -1;
  updateSearchResults();
}

function closeSearch() {
  document.getElementById('search-overlay').classList.remove('open');
}

function buildSearchIndex() {
  const items = [];
  Object.keys(MINERALS).forEach(m => items.push({ type: 'Mineral', name: m, icon: '⚛️', action: () => showMineral(m) }));
  Object.keys(COMPANY_DB).forEach(c => {
    const co = COMPANY_DB[c];
    items.push({ type: 'Company', name: c, sub: `${co.flag} ${co.ticker} · ${co.role}`, icon: '🏢', action: () => openCompanyPanel(c) });
  });
  Object.keys(COUNTRY_PROFILES).forEach(c => {
    items.push({ type: 'Country', name: c, icon: COUNTRY_FLAGS[c] || '🌐', action: () => openCountryModal(c, 'Lithium') });
  });
  FACILITIES_DB.forEach(f => {
    items.push({ type: 'Mine/Facility', name: f.name, sub: `${f.company} · ${f.mineral} · ${f.type}`, icon: f.type === 'Mine' ? '⛏' : '⚙', action: () => { showMineMap(); } });
  });
  return items;
}

function updateSearchResults() {
  const q = document.getElementById('search-input').value.toLowerCase().trim();
  const results = document.getElementById('search-results');
  searchActiveIdx = -1;

  if (!q) {
    results.innerHTML = '<div class="search-empty">Type to search across the entire dashboard</div>';
    return;
  }

  const index = buildSearchIndex();
  const matches = index.filter(item => {
    return item.name.toLowerCase().includes(q) || (item.sub && item.sub.toLowerCase().includes(q));
  }).slice(0, 20);

  if (!matches.length) {
    results.innerHTML = `<div class="search-empty">No results for "${q}"</div>`;
    return;
  }

  // Group by type
  const groups = {};
  matches.forEach(m => { (groups[m.type] = groups[m.type] || []).push(m); });

  let html = '';
  Object.entries(groups).forEach(([type, items]) => {
    html += `<div class="search-group-title">${type}s</div>`;
    items.forEach((item, i) => {
      html += `<div class="search-result" data-idx="${i}" onclick="executeSearchResult(this)" data-type="${item.type}" data-name="${item.name.replace(/"/g,'&quot;')}">
        <span class="search-result-icon">${item.icon}</span>
        <span class="search-result-name">${item.name}</span>
        ${item.sub ? `<span class="search-result-sub">${item.sub}</span>` : ''}
      </div>`;
    });
  });
  results.innerHTML = html;

  // Store actions
  results._matches = matches;
}

function executeSearchResult(el) {
  const name = el.dataset.name;
  const type = el.dataset.type;
  closeSearch();
  const index = buildSearchIndex();
  const match = index.find(i => i.name === name && i.type === type);
  if (match) match.action();
}

// Keyboard navigation for search
document.getElementById('search-input').addEventListener('keydown', function(e) {
  const results = document.getElementById('search-results');
  const items = results.querySelectorAll('.search-result');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    searchActiveIdx = Math.min(searchActiveIdx + 1, items.length - 1);
    items.forEach((el, i) => el.classList.toggle('active', i === searchActiveIdx));
    if (items[searchActiveIdx]) items[searchActiveIdx].scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    searchActiveIdx = Math.max(searchActiveIdx - 1, 0);
    items.forEach((el, i) => el.classList.toggle('active', i === searchActiveIdx));
    if (items[searchActiveIdx]) items[searchActiveIdx].scrollIntoView({ block: 'nearest' });
  } else if (e.key === 'Enter' && searchActiveIdx >= 0 && items[searchActiveIdx]) {
    e.preventDefault();
    items[searchActiveIdx].click();
  }
});

// ══════════════════════════════════════════════════════════════
// V4: REPORT / EXPORT
// ══════════════════════════════════════════════════════════════
function openReportModal() {
  // Populate mineral checkboxes
  const list = document.getElementById('rpt-minerals-list');
  list.innerHTML = '<div style="font-size:.75rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:.375rem">Mineral Deep-Dives</div>' +
    Object.keys(MINERALS).map(m => `<div class="report-option" style="padding:.25rem 0"><input type="checkbox" id="rpt-m-${m.replace(/\s/g,'_')}" value="${m}"><label for="rpt-m-${m.replace(/\s/g,'_')}">${m}</label></div>`).join('');
  document.getElementById('report-backdrop').classList.add('open');
}

function closeReportModal() {
  document.getElementById('report-backdrop').classList.remove('open');
}

function generateReport() {
  closeReportModal();
  // Show relevant sections for printing
  const inclOverview = document.getElementById('rpt-overview').checked;
  const inclPricing = document.getElementById('rpt-pricing').checked;
  const inclTrade = document.getElementById('rpt-trade').checked;
  const inclCompanies = document.getElementById('rpt-companies').checked;

  // Temporarily show all selected sections
  const overview = document.getElementById('overview');
  const pricingView = document.getElementById('pricing-view');
  const tradeView = document.getElementById('trade-view');
  const companiesView = document.getElementById('companies-view');

  if (inclOverview) overview.style.display = '';
  if (inclPricing) { pricingView.classList.add('active'); renderPricing(); }
  if (inclTrade) { tradeView.classList.add('active'); renderTradeView(); }
  if (inclCompanies) { companiesView.classList.add('active'); renderCompanyExplorer(); }

  setTimeout(() => { window.print(); }, 300);
}

// Copy table data to clipboard
function copyTableData(tableEl, btn) {
  const rows = tableEl.querySelectorAll('tr');
  let tsv = '';
  rows.forEach(row => {
    const cells = row.querySelectorAll('th, td');
    const vals = Array.from(cells).map(c => c.textContent.trim());
    tsv += vals.join('\t') + '\n';
  });
  navigator.clipboard.writeText(tsv).then(() => {
    if (btn) { btn.textContent = '✓ Copied'; btn.classList.add('copied'); setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000); }
  });
}

// ══════════════════════════════════════════════════════════════
// V4: LIVE PRICING INTEGRATION IN RENDER
// ══════════════════════════════════════════════════════════════
const _origRenderPricing = renderPricing;
// We override renderPricing to add badges and live data
const _renderPricingOrig = function() {
  // Call original minus charts (we rebuild)
  destroyCharts();
  const grid = document.getElementById('pricing-grid');
  grid.innerHTML = '';
  const cc = chartColors();
  const dark = getTheme() === 'dark';

  Object.entries(PRICING_DATA).forEach(([name, d], idx) => {
    const liveData = DataService.getPrice(name);
    const currentPrice = liveData ? liveData.value : d.current;
    const card = document.createElement('div');
    card.className = 'pricing-card';
    const dir = d.yoyChange >= 0 ? 'up' : 'down';
    const arrow = d.yoyChange >= 0 ? '▲' : '▼';
    const fmtPrice = currentPrice >= 1000 ? '$' + currentPrice.toLocaleString() : '$' + currentPrice;
    const badgeClass = liveData ? 'live' : 'cached';
    const badgeText = liveData ? '● Live' : '○ Cached';

    card.innerHTML = `
      <div class="pricing-card-header">
        <div class="pricing-card-left">
          <h3>${name} <span class="data-badge pricing-data-badge ${badgeClass}">${badgeText}</span></h3>
          <span class="pricing-unit">${d.unit}</span>
        </div>
        <div class="pricing-current">
          <div class="price-big">${fmtPrice}</div>
          <div class="price-change ${dir}">${arrow} ${Math.abs(d.yoyChange)}% YoY</div>
        </div>
      </div>
      <div class="pricing-chart-wrap"><canvas id="priceChart${idx}"></canvas></div>
    `;
    grid.appendChild(card);

    const ctx = document.getElementById('priceChart' + idx).getContext('2d');
    charts['price' + idx] = new Chart(ctx, {
      type: 'line',
      data: { labels: d.labels, datasets: [{ data: d.prices, borderColor: d.color, backgroundColor: d.color + '18', fill: true, tension: .3, pointRadius: 0, pointHitRadius: 8, borderWidth: 2 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: {
          backgroundColor: dark ? '#131316' : '#ffffff', titleColor: dark ? '#fafafa' : '#09090b', bodyColor: dark ? '#a1a1aa' : '#52525b',
          borderColor: dark ? '#27272a' : '#e4e4e7', borderWidth: 1, titleFont: { family: 'Geist', weight: '600' }, bodyFont: { family: 'Geist Mono' }, padding: 10, cornerRadius: 8,
          callbacks: { title: c => c[0].label, label: c => { const v = c.raw; if (d.unit.includes('/kg')) return `${name}: $${v}/kg`; if (d.unit.includes('/lb')) return `${name}: $${v}/lb`; if (d.unit.includes('/mtu')) return `${name}: $${v}/mtu`; if (d.unit.includes('/oz')) return `${name}: $${v}/oz`; return `${name}: $${v.toLocaleString()}`; } }
        } },
        scales: {
          x: { grid: { color: cc.grid }, ticks: { color: cc.tick, font: { size: 10, family: 'Geist Mono' }, maxRotation: 0, maxTicksLimit: 7 } },
          y: { grid: { color: cc.grid }, ticks: { color: cc.tick, font: { size: 10, family: 'Geist Mono' }, callback: v => { if (d.unit.includes('/kg')) return '$' + v; if (d.unit.includes('/lb')) return '$' + v; if (d.unit.includes('/mtu')) return '$' + v; if (d.unit.includes('/oz')) return '$' + v; return '$' + v.toLocaleString(); } }, beginAtZero: false }
        },
        interaction: { intersect: false, mode: 'index' }
      }
    });
  });
};
// Replace the original renderPricing
renderPricing = _renderPricingOrig;

// Update pricing section header with refresh button and last-fetched
const pricingSectionHeader = document.querySelector('#pricing-view .section-header');
if (pricingSectionHeader) {
  const rightEl = document.createElement('div');
  rightEl.style.cssText = 'display:flex;align-items:center;gap:.5rem';
  rightEl.innerHTML = `
    <span class="last-fetched" id="pricing-last-fetched"></span>
    <button class="refresh-btn" id="pricing-refresh" onclick="refreshPricing()" title="Refresh pricing data">
      <svg width="14" height="14" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182"/></svg>
    </button>
  `;
  const existingAttr = pricingSectionHeader.querySelector('.section-attribution');
  if (existingAttr) pricingSectionHeader.insertBefore(rightEl, existingAttr.nextSibling);
  else pricingSectionHeader.appendChild(rightEl);
}

async function refreshPricing() {
  const btn = document.getElementById('pricing-refresh');
  btn.classList.add('spinning');
  await DataService.fetchLivePricing();
  btn.classList.remove('spinning');
  if (document.getElementById('pricing-view').classList.contains('active')) renderPricing();
}

// Close panels on Escape & Cmd+K
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeCompanyPanel(); closeCountryModal(); closeSearch(); closeReportModal(); }
  if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
});

// Init: check alerts & try live pricing
checkAlertBanner();
DataService.fetchLivePricing();

showOverview();
</script>
</body>
</html>