<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Critical Minerals Tracker | U.S. Dependency & Global Supply Chain Analysis</title>
<meta name="description" content="Interactive dashboard tracking U.S. critical mineral dependencies, global supply chains, and geopolitical risk factors.">
<meta property="og:title" content="Critical Minerals Tracker">
<meta property="og:description" content="U.S. Dependency & Global Supply Chain Analysis â€” 14 critical minerals, real data from USGS 2024/2025">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --font-sans: 'Geist', -apple-system, sans-serif;
  --font-mono: 'Geist Mono', ui-monospace, monospace;
  --radius: 10px;
  --radius-lg: 14px;
}

[data-theme="dark"]{
  --bg: #09090b;
  --bg-elevated: #0f0f12;
  --surface: #131316;
  --surface-hover: #1a1a1f;
  --border: #27272a;
  --border-hover: #3f3f46;
  --text: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --accent: #3b82f6;
  --red: #ef4444;
  --red-muted: rgba(239,68,68,.12);
  --orange: #f59e0b;
  --orange-muted: rgba(245,158,11,.12);
  --green: #22c55e;
  --green-muted: rgba(34,197,94,.12);
  --chart-grid: #1e1e22;
  --backdrop: rgba(0,0,0,.5);
}

[data-theme="light"]{
  --bg: #ffffff;
  --bg-elevated: #fafafa;
  --surface: #ffffff;
  --surface-hover: #f4f4f5;
  --border: #e4e4e7;
  --border-hover: #d4d4d8;
  --text: #09090b;
  --text-secondary: #52525b;
  --text-muted: #a1a1aa;
  --accent: #2563eb;
  --red: #dc2626;
  --red-muted: rgba(220,38,38,.08);
  --orange: #d97706;
  --orange-muted: rgba(217,119,6,.08);
  --green: #16a34a;
  --green-muted: rgba(22,163,74,.08);
  --chart-grid: #f0f0f2;
  --backdrop: rgba(0,0,0,.3);
}

body{
  font-family:var(--font-sans);
  background:var(--bg);
  color:var(--text);
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background .2s, color .2s;
}

/* Header */
.header{
  border-bottom:1px solid var(--border);
  padding:1.5rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1400px;
  margin:0 auto;
}
.header-left h1{
  font-size:1.25rem;
  font-weight:600;
  letter-spacing:-.02em;
  color:var(--text);
}
.header-left p{
  color:var(--text-muted);
  font-size:.8125rem;
  margin-top:.125rem;
  font-weight:400;
}
.header-right{display:flex;align-items:center;gap:.75rem}
.last-updated{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
  padding:.25rem .625rem;
  border:1px solid var(--border);
  border-radius:var(--radius);
  white-space:nowrap;
}
.theme-toggle{
  width:36px;height:36px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
  flex-shrink:0;
}
.theme-toggle:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.theme-toggle svg{width:16px;height:16px}

/* Pills */
.pills-wrap{
  padding:.75rem 2rem;
  display:flex;
  flex-wrap:wrap;
  gap:.375rem;
  border-bottom:1px solid var(--border);
  max-width:1400px;
  margin:0 auto;
  align-items:center;
}
.pill{
  padding:.375rem .75rem;
  border-radius:999px;
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid transparent;
  background:transparent;
  color:var(--text-muted);
  transition:all .15s;
  white-space:nowrap;
}
.pill:hover{color:var(--text);background:var(--surface-hover)}
.pill.active{
  background:var(--text);
  color:var(--bg);
  border-color:var(--text);
}
.pill.section-pill{
  font-weight:600;
}
.pill-separator{
  width:1px;height:20px;background:var(--border);margin:0 .25rem;align-self:center;
}

/* Container */
.container{max-width:1400px;margin:0 auto;padding:2rem}

/* Overview */
.overview-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.overview-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.legend{display:flex;gap:1rem;font-size:.75rem;color:var(--text-muted)}
.legend span{display:flex;align-items:center;gap:.375rem}
.legend-dot{width:8px;height:8px;border-radius:50%}
.legend-dot.red{background:var(--red)}
.legend-dot.yellow{background:var(--orange)}
.legend-dot.green{background:var(--green)}

/* Overview Grid */
.overview-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:.75rem;
}
.mineral-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  cursor:pointer;
  transition:all .15s;
  position:relative;
}
.mineral-card:hover{
  border-color:var(--border-hover);
  background:var(--surface-hover);
}
.mc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
.mc-name{font-size:.875rem;font-weight:600;letter-spacing:-.01em}
.mc-badge{
  font-family:var(--font-mono);
  font-size:.6875rem;
  font-weight:500;
  padding:.2rem .5rem;
  border-radius:999px;
  letter-spacing:.01em;
}
.mc-badge.high{background:var(--red-muted);color:var(--red)}
.mc-badge.med{background:var(--orange-muted);color:var(--orange)}
.mc-badge.low{background:var(--green-muted);color:var(--green)}

.mc-import{
  font-family:var(--font-mono);
  font-size:2rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
  margin-bottom:.25rem;
}
.mc-import.high{color:var(--red)}
.mc-import.med{color:var(--orange)}
.mc-import.low{color:var(--green)}

.mc-sublabel{font-size:.75rem;color:var(--text-muted);margin-bottom:1rem}

.mc-row{display:flex;justify-content:space-between;font-size:.8125rem;padding:.25rem 0}
.mc-row+.mc-row{border-top:1px solid var(--border)}
.mc-label{color:var(--text-muted)}
.mc-val{font-family:var(--font-mono);font-weight:500;font-size:.8125rem}

/* Detail View */
.detail{display:none}
.detail.active{display:block}
.detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2rem;
}
.detail-header h2{font-size:1.25rem;font-weight:600;letter-spacing:-.02em}
.back-btn{
  padding:.5rem .875rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  font-family:var(--font-sans);
  transition:all .15s;
}
.back-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}

/* Stat Cards */
.stats-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:.75rem;
  margin-bottom:2rem;
}
.stat-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.stat-label{
  font-size:.75rem;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:.05em;
  font-weight:500;
  margin-bottom:.75rem;
}
.stat-value{
  font-family:var(--font-mono);
  font-size:1.75rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
}
.stat-sub{font-size:.75rem;color:var(--text-muted);margin-top:.375rem}

/* Gauge */
.gauge-wrap{display:flex;align-items:center;gap:1rem}
.gauge-bar-track{
  flex:1;height:8px;border-radius:99px;
  background:var(--border);
  overflow:hidden;
}
.gauge-bar-fill{height:100%;border-radius:99px;transition:width .4s ease}

/* Charts */
.charts-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:.75rem;
  margin-bottom:.75rem;
}
.chart-box{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.chart-box h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}
.chart-box canvas{max-height:280px}

/* Companies */
.company-list{display:flex;flex-wrap:wrap;gap:.375rem}
.company-tag{
  padding:.375rem .625rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  background:var(--surface-hover);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:400;
  cursor:pointer;
  transition:all .15s;
}
.company-tag:hover{border-color:var(--accent);background:var(--surface);color:var(--accent)}
.company-tag .co-country{color:var(--text-muted);margin-left:.25rem;font-size:.75rem}

/* â”€â”€ Side Panel (Company) â”€â”€ */
.side-panel-backdrop{
  position:fixed;inset:0;
  background:var(--backdrop);
  z-index:999;
  opacity:0;
  pointer-events:none;
  transition:opacity .2s;
}
.side-panel-backdrop.open{opacity:1;pointer-events:auto}
.side-panel{
  position:fixed;top:0;right:0;bottom:0;
  width:420px;max-width:92vw;
  background:var(--surface);
  border-left:1px solid var(--border);
  z-index:1000;
  transform:translateX(100%);
  transition:transform .25s cubic-bezier(.4,0,.2,1);
  overflow-y:auto;
  display:flex;flex-direction:column;
}
.side-panel.open{transform:translateX(0)}
.sp-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:1.25rem 1.5rem;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.sp-header h3{font-size:1rem;font-weight:600;letter-spacing:-.01em}
.sp-close{
  width:32px;height:32px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;
  color:var(--text-secondary);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .15s;font-family:var(--font-sans);
}
.sp-close:hover{background:var(--surface-hover);color:var(--text);border-color:var(--border-hover)}
.sp-body{padding:1.5rem;flex:1}
.sp-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:.625rem 0;font-size:.8125rem;
}
.sp-row+.sp-row{border-top:1px solid var(--border)}
.sp-row-label{color:var(--text-muted);font-weight:500}
.sp-row-val{font-family:var(--font-mono);font-weight:500;text-align:right;max-width:60%}
.sp-desc{
  font-size:.8125rem;color:var(--text-secondary);line-height:1.6;
  margin:1rem 0;padding:1rem;
  background:var(--bg-elevated);border-radius:var(--radius);
  border:1px solid var(--border);
}
.sp-minerals{display:flex;flex-wrap:wrap;gap:.375rem;margin-top:.75rem}
.sp-mineral-tag{
  padding:.25rem .5rem;border-radius:999px;font-size:.75rem;
  background:var(--accent);color:#fff;font-weight:500;
  opacity:.85;
}

/* â”€â”€ Country Modal â”€â”€ */
.country-modal-backdrop{
  position:fixed;inset:0;
  background:var(--backdrop);
  z-index:999;
  opacity:0;pointer-events:none;
  transition:opacity .2s;
  display:flex;align-items:center;justify-content:center;
}
.country-modal-backdrop.open{opacity:1;pointer-events:auto}
.country-modal{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  width:680px;max-width:94vw;max-height:85vh;
  overflow-y:auto;
  transform:scale(.95);opacity:0;
  transition:all .2s cubic-bezier(.4,0,.2,1);
  box-shadow:0 8px 32px rgba(0,0,0,.2);
}
.country-modal-backdrop.open .country-modal{transform:scale(1);opacity:1}
.cm-header{
  display:flex;justify-content:space-between;align-items:center;
  padding:1.25rem 1.5rem;
  border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--surface);z-index:1;
}
.cm-header h3{font-size:1rem;font-weight:600}
.cm-close{
  width:32px;height:32px;border-radius:var(--radius);
  border:1px solid var(--border);background:transparent;
  color:var(--text-secondary);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;transition:all .15s;font-family:var(--font-sans);
}
.cm-close:hover{background:var(--surface-hover);color:var(--text);border-color:var(--border-hover)}
.cm-body{padding:1.5rem}
.cm-overview{
  font-size:.8125rem;color:var(--text-secondary);line-height:1.6;
  margin-bottom:1.25rem;padding:1rem;
  background:var(--bg-elevated);border-radius:var(--radius);
  border:1px solid var(--border);
}
.cm-section-title{
  font-size:.75rem;font-weight:600;color:var(--text-muted);
  text-transform:uppercase;letter-spacing:.04em;
  margin:1.25rem 0 .75rem;
}
.cm-companies{display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:.5rem}
.cm-company-tag{
  padding:.25rem .625rem;border-radius:var(--radius);font-size:.8125rem;
  background:var(--surface-hover);border:1px solid var(--border);
  color:var(--text);cursor:pointer;transition:all .15s;
}
.cm-company-tag:hover{border-color:var(--accent);color:var(--accent)}
.cm-chart-wrap{height:220px;margin:1rem 0;position:relative}
.cm-chart-wrap canvas{width:100%!important;height:100%!important}
.cm-partners{display:flex;flex-wrap:wrap;gap:.375rem}
.cm-partner-tag{
  padding:.25rem .5rem;border-radius:999px;font-size:.75rem;
  background:var(--surface-hover);border:1px solid var(--border);color:var(--text-secondary);
}

/* Sankey Section */
#sankey-view{display:none}
#sankey-view.active{display:block}
.sankey-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.sankey-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.sankey-legend{display:flex;flex-wrap:wrap;gap:.625rem;font-size:.75rem;color:var(--text-muted)}
.sankey-legend span{display:flex;align-items:center;gap:.375rem}
.sankey-legend-dot{width:10px;height:10px;border-radius:3px}
.sankey-container{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  overflow-x:auto;
}
.sankey-container svg text{
  font-family:var(--font-sans);
  font-size:11px;
  fill:var(--text);
}
.sankey-tooltip{
  position:fixed;
  pointer-events:none;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:.625rem .875rem;
  font-family:var(--font-sans);
  font-size:.8125rem;
  color:var(--text);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  z-index:1000;
  max-width:260px;
  opacity:0;
  transition:opacity .12s;
}
.sankey-tooltip.visible{opacity:1}
.sankey-tooltip .tt-title{font-weight:600;margin-bottom:.25rem}
.sankey-tooltip .tt-val{font-family:var(--font-mono);font-weight:500;color:var(--accent)}
.sankey-tooltip .tt-sub{color:var(--text-muted);font-size:.75rem;margin-top:.125rem}
.sankey-filter-wrap{
  display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:1rem;
}
.sankey-filter{
  padding:.25rem .625rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-muted);
  transition:all .15s;
  font-family:var(--font-sans);
}
.sankey-filter:hover{color:var(--text);background:var(--surface-hover)}
.sankey-filter.active{background:var(--text);color:var(--bg);border-color:var(--text)}

/* â”€â”€ Trade Flows Section â”€â”€ */
#trade-view{display:none}
#trade-view.active{display:block}

.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.section-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.section-attribution{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
}

.trade-controls{
  display:flex;gap:.5rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;
}
.trade-select{
  padding:.5rem .875rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  font-weight:500;
  border:1px solid var(--border);
  background:var(--surface);
  color:var(--text);
  font-family:var(--font-sans);
  cursor:pointer;
  transition:all .15s;
  appearance:none;
  -webkit-appearance:none;
  padding-right:2rem;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' viewBox='0 0 24 24' stroke='%2371717a' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right .625rem center;
}
.trade-select:hover{border-color:var(--border-hover)}
.trade-select:focus{outline:none;border-color:var(--accent)}

/* Data tables */
.data-table-wrap{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  overflow:hidden;
}
.data-table{
  width:100%;
  border-collapse:collapse;
  font-size:.8125rem;
}
.data-table thead{
  background:var(--bg-elevated);
}
.data-table th{
  padding:.75rem 1rem;
  text-align:left;
  font-weight:600;
  font-size:.75rem;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:.04em;
  border-bottom:1px solid var(--border);
}
.data-table th.num{text-align:right}
.data-table th.sortable{cursor:pointer;user-select:none}
.data-table th.sortable:hover{color:var(--text)}
.data-table td{
  padding:.625rem 1rem;
  border-bottom:1px solid var(--border);
  color:var(--text);
}
.data-table td.num{
  text-align:right;
  font-family:var(--font-mono);
  font-weight:500;
  font-size:.8125rem;
}
.data-table tbody tr:last-child td{border-bottom:none}
.data-table tbody tr:nth-child(even){background:var(--bg-elevated)}
.data-table tbody tr:hover{background:var(--surface-hover)}
.clickable-country{
  cursor:pointer;color:var(--accent);font-weight:500;
  transition:color .15s;
}
.clickable-country:hover{text-decoration:underline}

.change-pos{color:var(--green);font-family:var(--font-mono);font-size:.75rem}
.change-neg{color:var(--red);font-family:var(--font-mono);font-size:.75rem}

.trade-tables-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:.75rem;
  margin-bottom:.75rem;
}

.us-import-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  margin-bottom:.75rem;
}
.us-import-card h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}
.us-bar{
  display:flex;align-items:center;gap:.75rem;
  padding:.375rem 0;
  font-size:.8125rem;
  cursor:pointer;
  transition:background .1s;
  border-radius:4px;
  margin:0 -.25rem;
  padding-left:.25rem;
  padding-right:.25rem;
}
.us-bar:hover{background:var(--surface-hover)}
.us-bar+.us-bar{border-top:1px solid var(--border)}
.us-bar-country{width:100px;color:var(--text);font-weight:500;flex-shrink:0}
.us-bar-track{flex:1;height:20px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
.us-bar-fill{height:100%;border-radius:4px;background:var(--accent);transition:width .4s ease}
.us-bar-pct{width:48px;text-align:right;font-family:var(--font-mono);font-weight:600;font-size:.8125rem;color:var(--text-secondary);flex-shrink:0}

/* Ranked flow table */
.flow-table-wrap{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  overflow:hidden;
  margin-bottom:.75rem;
}
.flow-table-wrap h3{
  font-size:.8125rem;font-weight:500;color:var(--text-secondary);
  padding:1rem 1rem .5rem;
}

/* â”€â”€ Pricing Section â”€â”€ */
#pricing-view{display:none}
#pricing-view.active{display:block}

.pricing-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(420px,1fr));
  gap:.75rem;
}
.pricing-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.pricing-card-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:1rem;
}
.pricing-card-left h3{
  font-size:.875rem;
  font-weight:600;
  letter-spacing:-.01em;
  margin-bottom:.25rem;
}
.pricing-card-left .pricing-unit{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
}
.pricing-current{
  text-align:right;
}
.pricing-current .price-big{
  font-family:var(--font-mono);
  font-size:1.75rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
}
.pricing-current .price-change{
  font-family:var(--font-mono);
  font-size:.75rem;
  font-weight:600;
  margin-top:.25rem;
}
.pricing-current .price-change.up{color:var(--green)}
.pricing-current .price-change.down{color:var(--red)}
.pricing-chart-wrap{height:200px;position:relative}
.pricing-chart-wrap canvas{width:100%!important;height:100%!important}

/* Footer */
.footer{
  text-align:center;
  padding:2.5rem 2rem;
  font-size:.75rem;
  color:var(--text-muted);
  border-top:1px solid var(--border);
  max-width:1400px;
  margin:2rem auto 0;
  line-height:1.8;
}
.footer-brand{font-weight:500;color:var(--text-secondary)}

/* Responsive */
@media(max-width:768px){
  .header{padding:1rem}
  .header-left h1{font-size:1.125rem}
  .pills-wrap{padding:.625rem 1rem}
  .container{padding:1rem}
  .charts-grid,.trade-tables-grid{grid-template-columns:1fr}
  .overview-grid{grid-template-columns:1fr 1fr}
  .stats-row{grid-template-columns:1fr 1fr}
  .pricing-grid{grid-template-columns:1fr}
  .side-panel{width:100%}
  .country-modal{width:100%;max-width:100%;max-height:100%;border-radius:0}
}
@media(max-width:480px){
  .overview-grid{grid-template-columns:1fr}
  .stats-row{grid-template-columns:1fr}
  .pricing-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>Critical Minerals Tracker</h1>
    <p>U.S. Dependency & Global Supply Chain Analysis</p>
  </div>
  <div class="header-right">
    <span class="last-updated">Updated Feb 2026</span>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" id="themeBtn">
      <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display:none"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
      <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/></svg>
    </button>
  </div>
</div>

<div class="pills-wrap" id="pills"></div>

<div class="container">
  <div id="overview">
    <div class="overview-header">
      <h2>Supply Chain Risk Overview</h2>
      <div class="legend">
        <span><div class="legend-dot red"></div>High Risk (â‰¥75%)</span>
        <span><div class="legend-dot yellow"></div>Moderate (40â€“74%)</span>
        <span><div class="legend-dot green"></div>Lower (&lt;40%)</span>
      </div>
    </div>
    <div class="overview-grid" id="overview-grid"></div>
  </div>

  <div id="sankey-view">
    <div class="sankey-header">
      <h2>Supply Chain Flow â€” Mining â†’ Processing â†’ End Use</h2>
    </div>
    <div class="sankey-filter-wrap" id="sankey-filters"></div>
    <div class="sankey-legend" id="sankey-legend"></div>
    <div class="sankey-container" id="sankey-container"></div>
  </div>

  <div id="trade-view">
    <div class="section-header">
      <h2>Global Trade Flows</h2>
      <span class="section-attribution">Data: USGS, UN Comtrade Â· Last updated: February 2026</span>
    </div>
    <div class="trade-controls">
      <select class="trade-select" id="trade-mineral-select" onchange="renderTradeView()"></select>
    </div>
    <div id="trade-content"></div>
  </div>

  <div id="pricing-view">
    <div class="section-header">
      <h2>Commodity Pricing â€” 5-Year History</h2>
      <span class="section-attribution">Data: World Bank Commodity Price Data (Pink Sheet) Â· Last updated: February 2026</span>
    </div>
    <div class="pricing-grid" id="pricing-grid"></div>
  </div>

  <div class="detail" id="detail">
    <div class="detail-header">
      <h2 id="detail-title"></h2>
      <button class="back-btn" onclick="showOverview()">â† Back</button>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Mining Production â€” Top Countries</h3><canvas id="miningChart"></canvas></div>
      <div class="chart-box"><h3>Refining / Processing</h3><canvas id="refiningChart"></canvas></div>
    </div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Primary End Uses</h3><canvas id="usesChart"></canvas></div>
      <div class="chart-box" id="companies-section">
        <h3>Key Companies</h3>
        <div class="company-list" id="company-list"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Sources: USGS Mineral Commodity Summaries 2024/2025 Â· UN Comtrade Â· World Bank Commodity Markets Â· IEA Critical Minerals Market Review Â· DOE Critical Materials Assessment<br>
  <span class="footer-brand">Prospector Labs Â· Built by Owen Coonahan</span>
</div>

<div class="sankey-tooltip" id="sankey-tooltip">
  <div class="tt-title"></div>
  <div class="tt-val"></div>
  <div class="tt-sub"></div>
</div>

<!-- Company Side Panel -->
<div class="side-panel-backdrop" id="sp-backdrop" onclick="closeCompanyPanel()"></div>
<div class="side-panel" id="side-panel">
  <div class="sp-header">
    <h3 id="sp-title"></h3>
    <button class="sp-close" onclick="closeCompanyPanel()">âœ•</button>
  </div>
  <div class="sp-body" id="sp-body"></div>
</div>

<!-- Country Modal -->
<div class="country-modal-backdrop" id="cm-backdrop" onclick="closeCountryModal()">
  <div class="country-modal" id="country-modal" onclick="event.stopPropagation()">
    <div class="cm-header">
      <h3 id="cm-title"></h3>
      <button class="cm-close" onclick="closeCountryModal()">âœ•</button>
    </div>
    <div class="cm-body" id="cm-body"></div>
  </div>
</div>

<script>
// Theme
function getTheme(){return document.documentElement.getAttribute('data-theme')}
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('sunIcon').style.display=t==='dark'?'none':'block';
  document.getElementById('moonIcon').style.display=t==='dark'?'block':'none';
  localStorage.setItem('theme',t);
  if(document.getElementById('detail').classList.contains('active')){
    const name=document.getElementById('detail-title').textContent;
    if(name&&MINERALS[name])showMineral(name);
  }
  if(document.getElementById('sankey-view').classList.contains('active')) renderSankey();
  if(document.getElementById('pricing-view').classList.contains('active')) renderPricing();
  if(document.getElementById('trade-view').classList.contains('active')) renderTradeView();
}
function toggleTheme(){setTheme(getTheme()==='dark'?'light':'dark')}
if(localStorage.getItem('theme'))setTheme(localStorage.getItem('theme'));else setTheme('dark');

const COLORS=['#3b82f6','#06b6d4','#8b5cf6','#f59e0b','#ec4899','#22c55e','#6366f1','#14b8a6','#f97316','#d946ef','#84cc16','#ef4444'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPANY DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COMPANY_DB = {
  'Albemarle':{ticker:'ALB',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$12B',hq:'Charlotte, NC, USA',desc:'World\'s largest lithium producer. Operates brine and hard-rock lithium assets in Chile, Australia, and the US.',minerals:['Lithium'],role:'Mining / Refining'},
  'SQM':{ticker:'SQM',country:'Chile',flag:'ğŸ‡¨ğŸ‡±',mcap:'$15B',hq:'Santiago, Chile',desc:'Major lithium and specialty chemicals producer. Operates in Chile\'s Atacama salt flat, one of the world\'s richest lithium brine deposits.',minerals:['Lithium'],role:'Mining / Refining'},
  'Pilbara Minerals':{ticker:'PLS',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$8B',hq:'Perth, Australia',desc:'Australian hard-rock lithium (spodumene) miner. Operates the Pilgangoora mine, one of the world\'s largest lithium operations.',minerals:['Lithium'],role:'Mining'},
  'Ganfeng Lithium':{ticker:'1772.HK',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$8B',hq:'Xinyu, China',desc:'China\'s largest lithium company with integrated mining and processing. Global operations spanning Australia, Argentina, Mexico, and Africa.',minerals:['Lithium'],role:'Mining / Refining'},
  'Tianqi Lithium':{ticker:'9696.HK',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$6B',hq:'Chengdu, China',desc:'Major Chinese lithium producer with stakes in Australian mines and Chilean operations. Key supplier to EV battery makers.',minerals:['Lithium'],role:'Mining / Refining'},
  'Arcadium':{ticker:'ALTM',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$5B',hq:'Philadelphia, PA, USA',desc:'Formed from Livent-Allkem merger. Vertically integrated lithium producer with operations in Argentina, Australia, Canada, and the US.',minerals:['Lithium'],role:'Mining / Refining'},
  'Mineral Resources':{ticker:'MIN',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$7B',hq:'Perth, Australia',desc:'Diversified Australian mining services and lithium producer. Operates multiple hard-rock lithium mines in Western Australia.',minerals:['Lithium'],role:'Mining'},
  'Glencore':{ticker:'GLEN',country:'CH',flag:'ğŸ‡¨ğŸ‡­',mcap:'$60B',hq:'Baar, Switzerland',desc:'Global commodity trading and mining giant. One of the world\'s largest producers of cobalt, copper, nickel, and zinc with operations across 35+ countries.',minerals:['Cobalt','Copper','Nickel'],role:'Mining / Refining'},
  'CMOC':{ticker:'3993.HK',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$15B',hq:'Luoyang, China',desc:'Major Chinese mining company and world\'s second-largest cobalt producer through its Tenke Fungurume mine in the DRC.',minerals:['Cobalt','Copper'],role:'Mining'},
  'Barrick Gold':{ticker:'GOLD',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$30B',hq:'Toronto, Canada',desc:'One of the world\'s largest gold miners with significant copper production. Cobalt produced as a byproduct from multiple operations.',minerals:['Cobalt','Copper'],role:'Mining'},
  'Huayou Cobalt':{ticker:'603799.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$10B',hq:'Tongxiang, China',desc:'Leading Chinese cobalt refiner and battery materials producer. Major processor of DRC-sourced cobalt for EV supply chains.',minerals:['Cobalt'],role:'Refining'},
  'Umicore':{ticker:'UMI',country:'BE',flag:'ğŸ‡§ğŸ‡ª',mcap:'$6B',hq:'Brussels, Belgium',desc:'Belgian materials technology and recycling company. Major cobalt refiner and cathode materials producer for EV batteries.',minerals:['Cobalt','Germanium'],role:'Refining'},
  'Vale':{ticker:'VALE',country:'BR',flag:'ğŸ‡§ğŸ‡·',mcap:'$45B',hq:'Rio de Janeiro, Brazil',desc:'World\'s largest nickel producer and major iron ore miner. Significant nickel operations in Canada, Indonesia, and New Caledonia.',minerals:['Nickel','Copper'],role:'Mining'},
  'Norilsk Nickel':{ticker:'GMKN',country:'RU',flag:'ğŸ‡·ğŸ‡º',mcap:'$25B',hq:'Moscow, Russia',desc:'World\'s largest producer of palladium and high-grade nickel. Major PGM and copper producer from Arctic operations.',minerals:['Nickel','Platinum Group','Copper'],role:'Mining / Refining'},
  'BHP':{ticker:'BHP',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$150B',hq:'Melbourne, Australia',desc:'World\'s largest mining company by market cap. Major producer of copper, nickel, iron ore, and potash with global operations.',minerals:['Nickel','Copper'],role:'Mining'},
  'Tsingshan':{ticker:'Private',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'Private',hq:'Wenzhou, China',desc:'World\'s largest stainless steel producer. Revolutionized nickel processing with NPI-to-matte conversion technology in Indonesia.',minerals:['Nickel'],role:'Mining / Refining'},
  'Northern Rare Earths':{ticker:'600111.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$8B',hq:'Baotou, China',desc:'China\'s largest rare earth producer, subsidiary of China North Industries (state-owned). Operates the massive Bayan Obo mine.',minerals:['Rare Earths'],role:'Mining / Refining'},
  'China Southern RE':{ticker:'600259.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$4B',hq:'Ganzhou, China',desc:'Major state-backed Chinese rare earth company focused on heavy rare earths (dysprosium, terbium) from southern China ionic clay deposits.',minerals:['Rare Earths'],role:'Mining / Refining'},
  'MP Materials':{ticker:'MP',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$3B',hq:'Las Vegas, NV, USA',desc:'Operates Mountain Pass, the only active rare earth mine in the Western Hemisphere. Building downstream separation and magnet manufacturing capacity.',minerals:['Rare Earths'],role:'Mining'},
  'Lynas Rare Earths':{ticker:'LYC',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$5B',hq:'Perth, Australia',desc:'Largest rare earth producer outside China. Mines at Mt Weld (Australia), processes in Malaysia, and building US facility with DOD funding.',minerals:['Rare Earths'],role:'Mining / Refining'},
  'Iluka Resources':{ticker:'ILU',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$3B',hq:'Perth, Australia',desc:'Australian mineral sands producer developing the Eneabba rare earth refinery, a critical non-Chinese rare earth processing facility.',minerals:['Rare Earths'],role:'Mining / Refining'},
  'Codelco':{ticker:'State-owned',country:'Chile',flag:'ğŸ‡¨ğŸ‡±',mcap:'State-owned',hq:'Santiago, Chile',desc:'World\'s largest copper producer, owned by the Chilean state. Produces ~8% of global copper from massive Chilean mines including Chuquicamata and El Teniente.',minerals:['Copper'],role:'Mining / Refining'},
  'Freeport-McMoRan':{ticker:'FCX',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$60B',hq:'Phoenix, AZ, USA',desc:'World\'s largest publicly traded copper producer. Operates the massive Grasberg mine in Indonesia and significant US copper assets.',minerals:['Copper'],role:'Mining'},
  'Southern Copper':{ticker:'SCCO',country:'MX',flag:'ğŸ‡²ğŸ‡½',mcap:'$45B',hq:'Mexico City, Mexico',desc:'One of the world\'s largest integrated copper producers with operations in Peru and Mexico. Subsidiary of Grupo MÃ©xico.',minerals:['Copper'],role:'Mining / Refining'},
  'Ivanhoe Mines':{ticker:'IVN',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$12B',hq:'Vancouver, Canada',desc:'Developing world-class copper mine at Kamoa-Kakula in the DRC, rapidly becoming one of the world\'s top copper operations.',minerals:['Copper'],role:'Mining'},
  'BTR New Material':{ticker:'835185.BJ',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$5B',hq:'Shenzhen, China',desc:'World\'s largest producer of lithium-ion battery anode materials (graphite). Dominant supplier to CATL, BYD, and global battery makers.',minerals:['Graphite'],role:'Refining'},
  'Showa Denko':{ticker:'4004.T',country:'JP',flag:'ğŸ‡¯ğŸ‡µ',mcap:'$8B',hq:'Tokyo, Japan',desc:'Major Japanese chemical company and leading synthetic graphite producer for EV battery anodes and industrial applications.',minerals:['Graphite'],role:'Refining'},
  'Syrah Resources':{ticker:'SYR',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$0.3B',hq:'Melbourne, Australia',desc:'Operates the Balama graphite mine in Mozambique, one of the world\'s largest. Building a US-based anode processing facility in Louisiana.',minerals:['Graphite'],role:'Mining'},
  'Northern Graphite':{ticker:'NGC',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$0.1B',hq:'Ottawa, Canada',desc:'Canadian graphite mining company developing domestic supply for North American battery supply chains.',minerals:['Graphite'],role:'Mining'},
  'Nouveau Monde':{ticker:'NOU',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$0.2B',hq:'Montreal, Canada',desc:'Canadian company developing an integrated natural graphite mining and battery anode material operation in Quebec.',minerals:['Graphite'],role:'Mining / Refining'},
  'South32':{ticker:'S32',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$10B',hq:'Perth, Australia',desc:'Diversified mining company spun off from BHP. Major producer of manganese, alumina, and other base metals.',minerals:['Manganese'],role:'Mining'},
  'Eramet':{ticker:'ERA',country:'FR',flag:'ğŸ‡«ğŸ‡·',mcap:'$3B',hq:'Paris, France',desc:'French mining and metallurgy group. Major manganese producer with operations in Gabon and New Caledonia nickel assets.',minerals:['Manganese','Nickel'],role:'Mining / Refining'},
  'MOIL':{ticker:'MOIL',country:'India',flag:'ğŸ‡®ğŸ‡³',mcap:'$1B',hq:'Nagpur, India',desc:'India\'s largest manganese ore producer, state-owned. Operates multiple mines across central India.',minerals:['Manganese'],role:'Mining'},
  'Assmang':{ticker:'Private',country:'SA',flag:'ğŸ‡¿ğŸ‡¦',mcap:'Private',hq:'Johannesburg, South Africa',desc:'Major South African manganese and iron ore producer. Joint venture between Assore and African Rainbow Minerals.',minerals:['Manganese'],role:'Mining'},
  'Jupiter Mines':{ticker:'JMS',country:'AU',flag:'ğŸ‡¦ğŸ‡º',mcap:'$0.4B',hq:'Perth, Australia',desc:'Australian mining company operating the Tshipi manganese mine in South Africa, one of the largest manganese operations globally.',minerals:['Manganese'],role:'Mining'},
  'Chinalco':{ticker:'601600.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$12B',hq:'Beijing, China',desc:'China\'s largest aluminum producer and a major gallium producer. Gallium is extracted as a byproduct of alumina refining.',minerals:['Gallium'],role:'Refining'},
  'CMC':{ticker:'Private',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'Private',hq:'Beijing, China',desc:'Chinese metals and chemicals company involved in gallium and germanium production for semiconductor applications.',minerals:['Gallium','Germanium'],role:'Refining'},
  'AXT Inc':{ticker:'AXTI',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$0.2B',hq:'Fremont, CA, USA',desc:'US manufacturer of compound semiconductor substrates (GaAs, InP, GaSb) used in fiber optics, wireless, and defense electronics.',minerals:['Gallium'],role:'Refining'},
  'Freiberger':{ticker:'Private',country:'DE',flag:'ğŸ‡©ğŸ‡ª',mcap:'Private',hq:'Freiberg, Germany',desc:'German manufacturer of gallium arsenide and germanium wafers for semiconductor, solar, and defense applications.',minerals:['Gallium','Germanium'],role:'Refining'},
  'Coherent':{ticker:'COHR',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$8B',hq:'Saxonburg, PA, USA',desc:'Major photonics and semiconductor materials company (formerly II-VI). Producer of compound semiconductor materials including GaAs and SiC.',minerals:['Gallium'],role:'Refining'},
  'Yunnan Germanium':{ticker:'002428.SZ',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$1.5B',hq:'Kunming, China',desc:'World\'s largest germanium producer. Key supplier of germanium for fiber optics, IR optics, and solar applications.',minerals:['Germanium'],role:'Mining / Refining'},
  'Teck Resources':{ticker:'TECK',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$20B',hq:'Vancouver, Canada',desc:'Major Canadian mining company producing copper, zinc, and germanium. Trail smelter is a significant Western germanium source.',minerals:['Germanium','Copper'],role:'Mining / Refining'},
  'China Minmetals':{ticker:'State-owned',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'State-owned',hq:'Beijing, China',desc:'State-owned Chinese metals and mining conglomerate. World\'s largest tungsten producer and major diversified mineral trader.',minerals:['Tungsten','Rare Earths'],role:'Mining / Refining'},
  'Xiamen Tungsten':{ticker:'600549.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$5B',hq:'Xiamen, China',desc:'Major Chinese tungsten producer and processor. Also produces rare earth materials and cemented carbide products.',minerals:['Tungsten','Rare Earths'],role:'Mining / Refining'},
  'Wolfram Bergbau':{ticker:'Private',country:'AT',flag:'ğŸ‡¦ğŸ‡¹',mcap:'Private',hq:'St. Martin, Austria',desc:'Austrian tungsten mining and processing company. One of the few significant non-Chinese tungsten producers in the Western world.',minerals:['Tungsten'],role:'Mining / Refining'},
  'Kennametal':{ticker:'KMT',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$3B',hq:'Pittsburgh, PA, USA',desc:'US industrial technology company specializing in tungsten carbide cutting tools, tooling systems, and wear-resistant solutions.',minerals:['Tungsten'],role:'Refining'},
  'Sandvik':{ticker:'SAND',country:'SE',flag:'ğŸ‡¸ğŸ‡ª',mcap:'$25B',hq:'Stockholm, Sweden',desc:'Swedish engineering group and major producer of cemented carbide tools, mining equipment, and advanced materials.',minerals:['Tungsten'],role:'Refining'},
  'Pangang Group':{ticker:'000629.SZ',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$4B',hq:'Panzhihua, China',desc:'China\'s largest vanadium producer. Extracts vanadium from titanium-magnetite ore as a byproduct of steelmaking.',minerals:['Vanadium'],role:'Mining / Refining'},
  'Evraz':{ticker:'Private',country:'RU',flag:'ğŸ‡·ğŸ‡º',mcap:'Private',hq:'Moscow, Russia',desc:'Major Russian steel and vanadium producer. One of the world\'s top vanadium producers from its Highveld and Russian operations.',minerals:['Vanadium'],role:'Mining / Refining'},
  'Bushveld Minerals':{ticker:'BMN',country:'SA',flag:'ğŸ‡¿ğŸ‡¦',mcap:'$0.1B',hq:'Johannesburg, South Africa',desc:'South African primary vanadium producer also developing vanadium redox flow battery (VRFB) energy storage systems.',minerals:['Vanadium'],role:'Mining'},
  'Largo Inc':{ticker:'LGO',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$0.3B',hq:'Toronto, Canada',desc:'Pure-play vanadium producer operating the MaracÃ¡s Menchen mine in Brazil. Also developing VRFB energy storage technology.',minerals:['Vanadium'],role:'Mining'},
  'Anglo American Platinum':{ticker:'AMS',country:'SA',flag:'ğŸ‡¿ğŸ‡¦',mcap:'$12B',hq:'Johannesburg, South Africa',desc:'World\'s largest primary platinum producer, subsidiary of Anglo American. Operates major PGM mines on South Africa\'s Bushveld Complex.',minerals:['Platinum Group'],role:'Mining / Refining'},
  'Impala Platinum':{ticker:'IMP',country:'SA',flag:'ğŸ‡¿ğŸ‡¦',mcap:'$5B',hq:'Johannesburg, South Africa',desc:'Second-largest platinum producer globally. Operations across South Africa\'s Bushveld Complex and in Zimbabwe and Canada.',minerals:['Platinum Group'],role:'Mining / Refining'},
  'Sibanye-Stillwater':{ticker:'SBSW',country:'SA',flag:'ğŸ‡¿ğŸ‡¦',mcap:'$4B',hq:'Johannesburg, South Africa',desc:'Major PGM and gold producer with the only US PGM mine (Stillwater, Montana). Diversifying into battery metals.',minerals:['Platinum Group'],role:'Mining'},
  'Kazatomprom':{ticker:'KAP',country:'KZ',flag:'ğŸ‡°ğŸ‡¿',mcap:'$8B',hq:'Astana, Kazakhstan',desc:'World\'s largest uranium producer, state-owned. Produces ~43% of global uranium primarily through in-situ leaching.',minerals:['Uranium'],role:'Mining'},
  'Cameco':{ticker:'CCJ',country:'CA',flag:'ğŸ‡¨ğŸ‡¦',mcap:'$22B',hq:'Saskatoon, Canada',desc:'World\'s second-largest uranium producer. Operates high-grade mines in Saskatchewan\'s Athabasca Basin including McArthur River.',minerals:['Uranium'],role:'Mining'},
  'Orano':{ticker:'Private',country:'FR',flag:'ğŸ‡«ğŸ‡·',mcap:'Private',hq:'Paris, France',desc:'French state-owned nuclear fuel cycle company. Major uranium miner, converter, and enricher with global operations.',minerals:['Uranium'],role:'Mining / Refining'},
  'Energy Fuels':{ticker:'UUUU',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$1.5B',hq:'Lakewood, CO, USA',desc:'Leading US uranium producer and emerging rare earth processor. Operates the White Mesa Mill, the only conventional uranium mill in the US.',minerals:['Uranium','Rare Earths'],role:'Mining / Refining'},
  'Centrus Energy':{ticker:'LEU',country:'US',flag:'ğŸ‡ºğŸ‡¸',mcap:'$2B',hq:'Bethesda, MD, USA',desc:'US nuclear fuel company and sole domestic HALEU producer. Received DOE funding to build US uranium enrichment capability.',minerals:['Uranium'],role:'Refining'},
  'Tongwei':{ticker:'600438.SS',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$15B',hq:'Chengdu, China',desc:'World\'s largest polysilicon and solar cell producer. Dominant player in solar-grade silicon manufacturing.',minerals:['Silicon'],role:'Refining'},
  'GCL-Poly':{ticker:'3800.HK',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$4B',hq:'Hong Kong/Suzhou, China',desc:'Major Chinese polysilicon and silicon wafer producer. Pioneer of granular polysilicon technology for solar applications.',minerals:['Silicon'],role:'Refining'},
  'Daqo New Energy':{ticker:'DQ',country:'CN',flag:'ğŸ‡¨ğŸ‡³',mcap:'$2B',hq:'Shanghai, China',desc:'Chinese manufacturer of high-purity polysilicon for solar PV. One of the lowest-cost producers globally.',minerals:['Silicon'],role:'Refining'},
  'Wacker Chemie':{ticker:'WCH',country:'DE',flag:'ğŸ‡©ğŸ‡ª',mcap:'$8B',hq:'Munich, Germany',desc:'German chemical company and major Western polysilicon producer. Key non-Chinese source of semiconductor and solar-grade silicon.',minerals:['Silicon'],role:'Refining'},
  'REC Silicon':{ticker:'RECSI',country:'NO',flag:'ğŸ‡³ğŸ‡´',mcap:'$0.5B',hq:'Lysaker, Norway',desc:'Norwegian silicon materials producer with US manufacturing facility in Moses Lake, WA. Resuming US polysilicon production.',minerals:['Silicon'],role:'Refining'},
};

// Country flag lookup
const COUNTRY_FLAGS = {
  'China':'ğŸ‡¨ğŸ‡³','USA':'ğŸ‡ºğŸ‡¸','US':'ğŸ‡ºğŸ‡¸','Chile':'ğŸ‡¨ğŸ‡±','Australia':'ğŸ‡¦ğŸ‡º','Argentina':'ğŸ‡¦ğŸ‡·',
  'Brazil':'ğŸ‡§ğŸ‡·','DRC':'ğŸ‡¨ğŸ‡©','Indonesia':'ğŸ‡®ğŸ‡©','Russia':'ğŸ‡·ğŸ‡º','Philippines':'ğŸ‡µğŸ‡­',
  'Canada':'ğŸ‡¨ğŸ‡¦','South Africa':'ğŸ‡¿ğŸ‡¦','Japan':'ğŸ‡¯ğŸ‡µ','South Korea':'ğŸ‡°ğŸ‡·','EU':'ğŸ‡ªğŸ‡º',
  'India':'ğŸ‡®ğŸ‡³','Germany':'ğŸ‡©ğŸ‡ª','Finland':'ğŸ‡«ğŸ‡®','Belgium':'ğŸ‡§ğŸ‡ª','Norway':'ğŸ‡³ğŸ‡´',
  'UK':'ğŸ‡¬ğŸ‡§','Myanmar':'ğŸ‡²ğŸ‡²','Malaysia':'ğŸ‡²ğŸ‡¾','Taiwan':'ğŸ‡¹ğŸ‡¼','Peru':'ğŸ‡µğŸ‡ª',
  'Mexico':'ğŸ‡²ğŸ‡½','Gabon':'ğŸ‡¬ğŸ‡¦','Ghana':'ğŸ‡¬ğŸ‡­','Madagascar':'ğŸ‡²ğŸ‡¬','Mozambique':'ğŸ‡²ğŸ‡¿',
  'Kazakhstan':'ğŸ‡°ğŸ‡¿','Namibia':'ğŸ‡³ğŸ‡¦','Uzbekistan':'ğŸ‡ºğŸ‡¿','Niger':'ğŸ‡³ğŸ‡ª',
  'Bolivia':'ğŸ‡§ğŸ‡´','Rwanda':'ğŸ‡·ğŸ‡¼','Vietnam':'ğŸ‡»ğŸ‡³','Zimbabwe':'ğŸ‡¿ğŸ‡¼',
  'New Caledonia':'ğŸ‡³ğŸ‡¨','Thailand':'ğŸ‡¹ğŸ‡­','Sweden':'ğŸ‡¸ğŸ‡ª','Austria':'ğŸ‡¦ğŸ‡¹',
  'France':'ğŸ‡«ğŸ‡·','Estonia':'ğŸ‡ªğŸ‡ª','Other':'ğŸŒ',
  'Estonia/Japan':'ğŸ‡ªğŸ‡ª','Switzerland':'ğŸ‡¨ğŸ‡­',
};

// Country overview data for modal (per mineral context)
const COUNTRY_PROFILES = {
  'China': {overview:'Dominant force in global critical mineral processing. Refines 60-90%+ of most critical minerals despite mining only a fraction. Invested $130B+ in mineral supply chains 2018-2023. Has imposed export controls on gallium, germanium, graphite, and rare earths.',tradePartners:['Japan','South Korea','EU','USA','India']},
  'Chile': {overview:'World\'s largest copper producer and second-largest lithium producer. State-owned Codelco leads copper production. Atacama salt flat contains some of the world\'s richest lithium brine deposits.',tradePartners:['China','Japan','South Korea','USA','EU']},
  'Australia': {overview:'Major mining economy and top producer of lithium, iron ore, and critical minerals. Key Western ally for supply chain diversification away from China. Hosts significant rare earth, nickel, and copper deposits.',tradePartners:['China','Japan','South Korea','India','EU']},
  'DRC': {overview:'Produces 73% of global cobalt and is a rapidly growing copper producer. Artisanal mining raises ESG concerns. Chinese companies control significant mining assets through CMOC and others.',tradePartners:['China','Belgium','Finland','South Korea','India']},
  'Indonesia': {overview:'World\'s largest nickel producer (55% of global supply) driven by Chinese-financed smelters. Growing cobalt production as a nickel byproduct. Implemented export bans on raw nickel ore to force domestic processing.',tradePartners:['China','Japan','South Korea','EU','India']},
  'Russia': {overview:'Major producer of palladium (40%), nickel, uranium enrichment (38%), and various metals. Western sanctions since 2022 have disrupted some supply chains but Russia continues exporting through alternative channels.',tradePartners:['China','India','EU','Japan','Turkey']},
  'South Africa': {overview:'Dominates platinum group metals (72% of platinum mining) and significant manganese producer (37%). Home to the Bushveld Complex, the world\'s largest PGM deposit.',tradePartners:['China','USA','Germany','Japan','UK']},
  'Japan': {overview:'Major importer and processor of critical minerals. Key refining capacity for nickel, copper, rare earths, and PGMs. Strategic mineral stockpiling program. Limited domestic mining resources.',tradePartners:['Australia','Chile','Indonesia','China','Canada']},
  'USA': {overview:'Highly import-dependent for most critical minerals. Domestic production limited to some copper, lithium (Nevada), rare earths (Mountain Pass), and uranium. IRA and DPA investments aim to rebuild supply chains.',tradePartners:['Canada','Chile','Australia','China','Mexico']},
  'Canada': {overview:'Important US trading partner and source of nickel, copper, uranium, cobalt, and PGMs. Cameco is the world\'s second-largest uranium producer. Strong mining regulatory framework.',tradePartners:['USA','EU','Japan','China','South Korea']},
  'South Korea': {overview:'Major importer of critical minerals for its electronics and EV battery industries. Home to Samsung SDI, LG Energy Solution, and SK Innovation â€” key battery manufacturers.',tradePartners:['Australia','Chile','China','Indonesia','Argentina']},
  'EU': {overview:'Highly import-dependent on critical minerals. European Critical Raw Materials Act aims to diversify supply. Some processing capacity in Finland (cobalt, nickel), Belgium (cobalt), and Estonia (rare earths).',tradePartners:['Chile','Australia','DRC','Indonesia','South Africa']},
  'Argentina': {overview:'Growing lithium producer from brine operations in the "Lithium Triangle." Rapidly expanding production capacity with multiple new projects under development.',tradePartners:['China','USA','Japan','South Korea','EU']},
  'Peru': {overview:'World\'s third-largest copper producer. Significant mining sector but facing social license challenges and community opposition to new projects.',tradePartners:['China','Japan','South Korea','USA','EU']},
  'Mexico': {overview:'Growing copper producer and significant trading partner with the US. Hosts graphite deposits and is a transit point for mineral trade.',tradePartners:['USA','China','Japan','South Korea','Canada']},
  'Finland': {overview:'Key European cobalt and nickel refiner. Hosts Terrafame nickel-cobalt mine and Umicore\'s cobalt refining facilities. Important for EU supply chain diversification.',tradePartners:['DRC','Russia','EU','USA','Japan']},
  'Belgium': {overview:'Major cobalt refining hub through Umicore. Historical connection to DRC mineral trade. Important European processing center for specialty metals.',tradePartners:['DRC','China','EU','USA','Canada']},
  'Norway': {overview:'Producer of silicon metal, nickel refining (Glencore Nikkelverk), and host of REC Silicon. Important Western source of processed metals.',tradePartners:['EU','USA','Japan','China','South Korea']},
  'Gabon': {overview:'Second-largest manganese producer globally (18%). Eramet\'s COMILOG mine is the primary operation. Important African mineral exporter.',tradePartners:['China','EU','India','USA','Japan']},
  'Kazakhstan': {overview:'World\'s largest uranium producer (43%) through state-owned Kazatomprom. Also produces chromium, manganese, and other minerals. Strategic energy minerals exporter.',tradePartners:['China','EU','USA','Russia','Japan']},
  'Namibia': {overview:'Third-largest uranium producer globally (11%). Hosts major uranium mines including RÃ¶ssing and Husab. Growing critical minerals sector.',tradePartners:['China','EU','USA','Japan','South Korea']},
  'Bolivia': {overview:'Significant tungsten producer and hosts massive lithium resources in Salar de Uyuni salt flat, though lithium development has been slow.',tradePartners:['USA','EU','China','Brazil','Japan']},
  'Vietnam': {overview:'Growing tungsten producer (5% of global supply). Emerging rare earth mining potential. Strategic location in Southeast Asian supply chains.',tradePartners:['China','Japan','South Korea','EU','USA']},
  'Rwanda': {overview:'Emerging tungsten (wolframite) and tin producer in Central Africa. Growing mineral exports despite small scale. 3T minerals (tin, tantalum, tungsten) sector.',tradePartners:['China','EU','USA','UAE','Malaysia']},
  'Madagascar': {overview:'Growing graphite producer with several new mining projects. Hosts high-quality flake graphite deposits. Emerging supplier for battery anode materials.',tradePartners:['China','EU','USA','Japan','India']},
  'Mozambique': {overview:'Rapidly growing graphite producer (11% of global supply). Syrah Resources\' Balama mine is one of the world\'s largest. Also has significant natural gas reserves.',tradePartners:['China','EU','India','Japan','USA']},
  'Myanmar': {overview:'Second-largest rare earth mining country (10%). Heavy rare earth production from ionic clay deposits near Chinese border. Environmental and human rights concerns.',tradePartners:['China']},
  'Malaysia': {overview:'Hosts Lynas rare earth processing facility â€” the largest non-Chinese rare earth separation plant. Important downstream processing hub.',tradePartners:['Australia','China','Japan','South Korea','USA']},
  'Zimbabwe': {overview:'Growing PGM producer (8% of global platinum). Great Dyke geological formation hosts significant platinum and chrome deposits.',tradePartners:['South Africa','China','EU','Japan','USA']},
  'Taiwan': {overview:'Major semiconductor manufacturer importing gallium and germanium for chip production. TSMC drives significant demand for compound semiconductor materials.',tradePartners:['China','Japan','USA','South Korea','EU']},
  'UK': {overview:'Home to Johnson Matthey, major PGM refiner and catalyst manufacturer. London is a key trading hub for precious and base metals through the LME.',tradePartners:['South Africa','Russia','USA','EU','Japan']},
  'New Caledonia': {overview:'French overseas territory with ~5% of global nickel production. Hosts some of the world\'s largest nickel laterite deposits. Political instability has affected production.',tradePartners:['EU','Japan','China','South Korea','Australia']},
  'India': {overview:'Growing critical minerals consumer and modest producer of manganese, rare earths, and other minerals. Announced critical minerals strategy to reduce Chinese dependence.',tradePartners:['China','Indonesia','Australia','South Africa','Russia']},
  'Niger': {overview:'Uranium producer (4% of global supply) with Orano-operated mines. Political instability (2023 coup) has disrupted some operations and raised supply concerns.',tradePartners:['France','EU','China','USA','Japan']},
  'Uzbekistan': {overview:'Significant uranium producer (7% of global supply) with state-owned Navoi Mining. Growing strategic importance as Western countries seek uranium supply diversification.',tradePartners:['China','Russia','USA','EU','Japan']},
};

const MINERALS = {
  Lithium:{importReliance:25,importLabel:'>25%',chinaRefining:65,topProcessor:'China (65%)',mining:[['Australia',47],['Chile',25],['China',15],['Argentina',6],['Brazil',3],['Other',4]],refining:[['China',65],['Chile',20],['Argentina',5],['Other',10]],uses:[['EV Batteries',74],['Portable Electronics',9],['Grid Storage',7],['Ceramics/Glass',4],['Lubricants',3],['Other',3]],companies:[['Albemarle','US'],['SQM','Chile'],['Pilbara Minerals','AU'],['Ganfeng Lithium','CN'],['Tianqi Lithium','CN'],['Arcadium','US'],['Mineral Resources','AU']]},
  Cobalt:{importReliance:76,importLabel:'76%',chinaRefining:74,topProcessor:'China (74%)',mining:[['DRC',73],['Indonesia',5],['Russia',4],['Australia',3],['Philippines',3],['Canada',2],['Other',10]],refining:[['China',74],['Finland',10],['Belgium',5],['Canada',3],['Other',8]],uses:[['EV Batteries',40],['Portable Electronics',30],['Aerospace Superalloys',15],['Catalysts',5],['Cutting Tools',5],['Other',5]],companies:[['Glencore','CH'],['CMOC','CN'],['Barrick Gold','CA'],['Huayou Cobalt','CN'],['Umicore','BE']]},
  Nickel:{importReliance:56,importLabel:'56%',chinaRefining:35,topProcessor:'China (35%)',mining:[['Indonesia',55],['Philippines',10],['Russia',6],['New Caledonia',5],['Australia',4],['Canada',4],['China',3],['Other',13]],refining:[['China',35],['Indonesia',25],['Japan',8],['Russia',5],['Finland',4],['Australia',3],['Other',20]],uses:[['Stainless Steel',65],['EV Batteries',15],['Alloys/Superalloys',8],['Plating',6],['Other',6]],companies:[['Vale','BR'],['Norilsk Nickel','RU'],['BHP','AU'],['Glencore','CH'],['Tsingshan','CN']]},
  'Rare Earths':{importReliance:95,importLabel:'>95%',chinaRefining:90,topProcessor:'China (90%)',mining:[['China',70],['Myanmar',10],['Australia',6],['USA',4],['India',2],['Thailand',2],['Other',6]],refining:[['China',90],['Malaysia',5],['Estonia/Japan',3],['Other',2]],uses:[['Permanent Magnets',38],['Catalysts',23],['Polishing',12],['Glass',8],['Metallurgy',8],['Ceramics',5],['Other',6]],companies:[['Northern Rare Earths','CN'],['China Southern RE','CN'],['MP Materials','US'],['Lynas Rare Earths','AU'],['Iluka Resources','AU']]},
  Copper:{importReliance:45,importLabel:'45%',chinaRefining:42,topProcessor:'China (42%)',mining:[['Chile',24],['DRC',12],['Peru',10],['China',8],['USA',5],['Indonesia',5],['Australia',4],['Russia',4],['Other',28]],refining:[['China',42],['Chile',9],['Japan',7],['DRC',5],['India',4],['Russia',3],['USA',3],['Other',27]],uses:[['Electrical/Power',65],['Construction',15],['Transportation',7],['Industrial',7],['Consumer',6]],companies:[['Codelco','Chile'],['Freeport-McMoRan','US'],['BHP','AU'],['Southern Copper','MX'],['Glencore','CH'],['Ivanhoe Mines','CA']]},
  Graphite:{importReliance:100,importLabel:'100%',chinaRefining:90,topProcessor:'China (90%+)',mining:[['China',65],['Mozambique',11],['Brazil',7],['Madagascar',5],['India',3],['Other',9]],refining:[['China',90],['Japan',4],['Other',6]],uses:[['EV Battery Anodes',55],['Steelmaking',20],['Foundries',8],['Lubricants',5],['Brake Linings',5],['Other',7]],companies:[['BTR New Material','CN'],['Showa Denko','JP'],['Syrah Resources','AU'],['Northern Graphite','CA'],['Nouveau Monde','CA']]},
  Manganese:{importReliance:100,importLabel:'100%',chinaRefining:93,topProcessor:'China (93%)',mining:[['South Africa',37],['Gabon',18],['Australia',15],['China',6],['Ghana',5],['Brazil',4],['India',4],['Other',11]],refining:[['China',93],['Other',7]],uses:[['Steelmaking',90],['EV Batteries',5],['Aluminum Alloys',3],['Other',2]],companies:[['South32','AU'],['Eramet','FR'],['MOIL','India'],['Assmang','SA'],['Jupiter Mines','AU']]},
  Gallium:{importReliance:100,importLabel:'100%',chinaRefining:98,topProcessor:'China (98%)',mining:[['China',98],['Japan',1],['Russia',0.5],['Other',0.5]],refining:[['China',98],['Japan',1],['Other',1]],uses:[['Semiconductors (GaAs)',70],['LEDs/Optoelectronics',20],['Solar (Space/Military)',5],['Research',5]],companies:[['Chinalco','CN'],['CMC','CN'],['AXT Inc','US'],['Freiberger','DE'],['Coherent','US']]},
  Germanium:{importReliance:50,importLabel:'>50%',chinaRefining:60,topProcessor:'China (60%)',mining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],refining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],uses:[['Fiber Optics',35],['IR Optics/Night Vision',25],['Solar Cells',15],['Catalysts',10],['Other',15]],companies:[['Yunnan Germanium','CN'],['Umicore','BE'],['Teck Resources','CA']]},
  Tungsten:{importReliance:50,importLabel:'50%',chinaRefining:82,topProcessor:'China (82%)',mining:[['China',82],['Vietnam',5],['Russia',3],['Bolivia',2],['Rwanda',2],['Other',6]],refining:[['China',82],['Austria',4],['Other',14]],uses:[['Cutting Tools/Carbide',55],['Mill Products',20],['Steels/Alloys',15],['Chemicals',10]],companies:[['China Minmetals','CN'],['Xiamen Tungsten','CN'],['Wolfram Bergbau','AT'],['Kennametal','US'],['Sandvik','SE']]},
  Vanadium:{importReliance:72,importLabel:'72%',chinaRefining:66,topProcessor:'China (66%)',mining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],refining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],uses:[['Steel Alloys',90],['Flow Batteries (VRFB)',5],['Titanium Alloys',3],['Chemicals',2]],companies:[['Pangang Group','CN'],['Evraz','RU'],['Bushveld Minerals','SA'],['Largo Inc','BR/CA']]},
  'Platinum Group':{importReliance:77,importLabel:'77%',chinaRefining:8,topProcessor:'South Africa (45%)',mining:[['South Africa',72],['Russia',10],['Zimbabwe',8],['Canada',5],['USA',2],['Other',3]],refining:[['South Africa',45],['Russia',25],['UK',10],['Japan',8],['USA',5],['Other',7]],uses:[['Autocatalysts',40],['Jewelry',25],['Hydrogen/Fuel Cells',15],['Chemical Catalysts',10],['Electronics',5],['Other',5]],companies:[['Anglo American Platinum','SA'],['Impala Platinum','SA'],['Sibanye-Stillwater','SA/US'],['Norilsk Nickel','RU']]},
  Uranium:{importReliance:90,importLabel:'>90%',chinaRefining:12,topProcessor:'Russia (38%)',mining:[['Kazakhstan',43],['Canada',15],['Namibia',11],['Australia',8],['Uzbekistan',7],['Russia',5],['Niger',4],['Other',7]],refining:[['Russia',38],['Urenco (EU)',30],['Orano (France)',15],['China',12],['USA',5]],uses:[['Nuclear Power',93],['Medical Isotopes',3],['Defense/Naval',3],['Research',1]],companies:[['Kazatomprom','KZ'],['Cameco','CA'],['Orano','FR'],['Energy Fuels','US'],['Centrus Energy','US']]},
  Silicon:{importReliance:33,importLabel:'33%',chinaRefining:80,topProcessor:'China (80%)',mining:[['China',71],['Russia',6],['Brazil',5],['Norway',5],['USA',3],['France',2],['Other',8]],refining:[['China',80],['Germany',5],['South Korea',5],['Norway',3],['Other',7]],uses:[['Aluminum Alloys',45],['Silicones/Chemicals',30],['Solar Polysilicon',15],['Semiconductors',5],['Other',5]],companies:[['Tongwei','CN'],['GCL-Poly','CN'],['Daqo New Energy','CN'],['Wacker Chemie','DE'],['REC Silicon','NO/US']]}
};

// Mineral color map for Sankey
const MINERAL_COLORS = {
  Lithium:'#3b82f6',Cobalt:'#8b5cf6',Nickel:'#06b6d4','Rare Earths':'#ec4899',
  Copper:'#f59e0b',Graphite:'#22c55e',Gallium:'#6366f1',Germanium:'#14b8a6',
  Tungsten:'#f97316'
};
const SANKEY_MINERALS = ['Lithium','Cobalt','Nickel','Rare Earths','Copper','Graphite','Gallium','Germanium','Tungsten'];

function riskLevel(r){return r>=75?'high':r>=40?'med':'low'}

let charts={};
function destroyCharts(){Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});charts={}}

function chartColors(){
  const dark=getTheme()==='dark';
  return{
    grid:dark?'#1e1e22':'#f0f0f2',
    tick:dark?'#71717a':'#a1a1aa',
    label:dark?'#fafafa':'#09090b',
    legendText:dark?'#a1a1aa':'#52525b'
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPANY SIDE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCompanyPanel(companyName){
  const co = COMPANY_DB[companyName];
  if(!co) return;
  const panel = document.getElementById('side-panel');
  const backdrop = document.getElementById('sp-backdrop');
  document.getElementById('sp-title').textContent = co.flag+' '+companyName;

  let html = `
    <div class="sp-row"><span class="sp-row-label">Ticker</span><span class="sp-row-val">${co.ticker}</span></div>
    <div class="sp-row"><span class="sp-row-label">Market Cap</span><span class="sp-row-val">${co.mcap}</span></div>
    <div class="sp-row"><span class="sp-row-label">HQ</span><span class="sp-row-val">${co.hq}</span></div>
    <div class="sp-row"><span class="sp-row-label">Role</span><span class="sp-row-val">${co.role}</span></div>
    <div class="sp-desc">${co.desc}</div>
    <div class="sp-row-label" style="font-size:.75rem;text-transform:uppercase;letter-spacing:.04em;font-weight:600;color:var(--text-muted);margin-bottom:.5rem">Minerals</div>
    <div class="sp-minerals">${co.minerals.map(m=>`<span class="sp-mineral-tag">${m}</span>`).join('')}</div>
  `;
  document.getElementById('sp-body').innerHTML = html;
  backdrop.classList.add('open');
  panel.classList.add('open');
  document.body.style.overflow='hidden';
}

function closeCompanyPanel(){
  document.getElementById('side-panel').classList.remove('open');
  document.getElementById('sp-backdrop').classList.remove('open');
  document.body.style.overflow='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTRY MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let countryModalChart = null;

function openCountryModal(country, mineral){
  const backdrop = document.getElementById('cm-backdrop');
  const flag = COUNTRY_FLAGS[country]||'ğŸŒ';
  document.getElementById('cm-title').textContent = flag+' '+country+' â€” '+mineral;

  const profile = COUNTRY_PROFILES[country] || {overview:'Key participant in the global '+mineral+' supply chain.',tradePartners:['China','USA','EU','Japan']};

  // Find companies from this country in this mineral
  const mineralData = MINERALS[mineral];
  const companiesInCountry = [];
  if(mineralData){
    // Map country codes to full names for matching
    const countryCodeMap = {'US':'USA','CN':'China','AU':'Australia','BR':'Brazil','CA':'Canada','CH':'Switzerland','RU':'Russia',
      'DE':'Germany','JP':'Japan','SE':'Sweden','AT':'Austria','FR':'France','BE':'Belgium','SA':'South Africa','NO':'Norway',
      'KZ':'Kazakhstan','MX':'Mexico','India':'India','Chile':'Chile'};
    mineralData.companies.forEach(([name, code])=>{
      const fullName = countryCodeMap[code]||code;
      if(fullName===country || code===country){
        companiesInCountry.push(name);
      }
    });
  }

  // Generate realistic 5-year trade volume data for chart
  const baseVolumes = generateTradeHistory(country, mineral);

  let html = `
    <div class="cm-overview">${profile.overview}</div>
  `;

  if(companiesInCountry.length>0){
    html += `<div class="cm-section-title">Key Companies in ${mineral}</div>
    <div class="cm-companies">${companiesInCountry.map(c=>`<span class="cm-company-tag" onclick="event.stopPropagation();closeCountryModal();openCompanyPanel('${c.replace(/'/g,"\\'")}')">${c}</span>`).join('')}</div>`;
  }

  html += `
    <div class="cm-section-title">Historical Trade Volume (5 Years)</div>
    <div class="cm-chart-wrap"><canvas id="countryTradeChart"></canvas></div>
    <div class="cm-section-title">Key Trade Partners</div>
    <div class="cm-partners">${profile.tradePartners.map(p=>`<span class="cm-partner-tag">${COUNTRY_FLAGS[p]||'ğŸŒ'} ${p}</span>`).join('')}</div>
  `;

  document.getElementById('cm-body').innerHTML = html;
  backdrop.classList.add('open');
  document.body.style.overflow='hidden';

  // Render chart after DOM update
  setTimeout(()=>{
    if(countryModalChart){try{countryModalChart.destroy()}catch(e){}}
    const ctx = document.getElementById('countryTradeChart');
    if(!ctx) return;
    const dark = getTheme()==='dark';
    const cc = chartColors();
    countryModalChart = new Chart(ctx.getContext('2d'),{
      type:'line',
      data:{
        labels:['2021','2022','2023','2024','2025'],
        datasets:[{
          label:'Trade Volume (Index)',
          data:baseVolumes,
          borderColor:'var(--accent)',
          backgroundColor:dark?'rgba(59,130,246,.12)':'rgba(37,99,235,.08)',
          fill:true,tension:.3,pointRadius:4,pointHitRadius:8,borderWidth:2,
          pointBackgroundColor:dark?'#3b82f6':'#2563eb',
        }]
      },
      options:{
        responsive:true,maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{
          backgroundColor:dark?'#131316':'#ffffff',
          titleColor:dark?'#fafafa':'#09090b',
          bodyColor:dark?'#a1a1aa':'#52525b',
          borderColor:dark?'#27272a':'#e4e4e7',
          borderWidth:1,
          titleFont:{family:'Geist',weight:'600'},
          bodyFont:{family:'Geist Mono'},
          padding:10,cornerRadius:8,
        }},
        scales:{
          x:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:11,family:'Geist Mono'}}},
          y:{grid:{color:cc.grid},ticks:{color:cc.tick,font:{size:11,family:'Geist Mono'}},beginAtZero:false}
        }
      }
    });
  },50);
}

function closeCountryModal(){
  document.getElementById('cm-backdrop').classList.remove('open');
  document.body.style.overflow='';
  if(countryModalChart){try{countryModalChart.destroy()}catch(e){}}
  countryModalChart=null;
}

function generateTradeHistory(country, mineral){
  // Deterministic pseudo-random based on country+mineral
  let seed = 0;
  for(let i=0;i<country.length;i++) seed+=country.charCodeAt(i);
  for(let i=0;i<mineral.length;i++) seed+=mineral.charCodeAt(i)*3;
  const base = 60 + (seed % 40);
  const growth = ((seed*7)%30)-10;
  return [0,1,2,3,4].map(i=>{
    const noise = ((seed*(i+1)*13)%20)-10;
    return Math.round(base + growth*i/4 + noise);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRADE FLOW DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRADE_DATA = {
  Lithium: {
    hsCode: '2836.91 / 2825.20',
    unit: 'Lithium Carbonate Equivalent (LCE)',
    globalTrade: 245000,
    exporters: [
      {country:'Chile', volume:92000, value:5520, yoy:8.2},
      {country:'Australia', volume:68000, value:4080, yoy:12.5},
      {country:'China', volume:35000, value:2100, yoy:-3.1},
      {country:'Argentina', volume:28000, value:1680, yoy:22.4},
      {country:'USA', volume:5000, value:300, yoy:15.0},
    ],
    importers: [
      {country:'China', volume:115000, value:6900, yoy:6.8},
      {country:'South Korea', volume:38000, value:2280, yoy:11.2},
      {country:'Japan', volume:28000, value:1680, yoy:4.5},
      {country:'USA', volume:18000, value:1080, yoy:9.3},
      {country:'EU', volume:15000, value:900, yoy:18.7},
    ],
    usImports: [
      {country:'Chile', pct:55},
      {country:'Argentina', pct:22},
      {country:'China', pct:12},
      {country:'Australia', pct:8},
      {country:'Other', pct:3},
    ],
    flows: [
      ['Australia','China',3200],['Australia','South Korea',520],['Australia','Japan',360],
      ['Chile','China',1800],['Chile','South Korea',1100],['Chile','Japan',900],['Chile','USA',850],
      ['Argentina','China',600],['Argentina','USA',380],['China','South Korea',450],['China','Japan',320],
    ]
  },
  Cobalt: {
    hsCode: '2605.00 / 8105.20',
    unit: 'Tonnes (metal content)',
    globalTrade: 180000,
    exporters: [
      {country:'DRC', volume:130000, value:5200, yoy:4.2},
      {country:'Indonesia', volume:12000, value:480, yoy:45.0},
      {country:'Russia', volume:6500, value:260, yoy:-8.5},
      {country:'Australia', volume:5800, value:232, yoy:2.1},
      {country:'Philippines', volume:4800, value:192, yoy:6.3},
    ],
    importers: [
      {country:'China', volume:120000, value:4800, yoy:7.5},
      {country:'Finland', volume:15000, value:600, yoy:3.2},
      {country:'Belgium', volume:10000, value:400, yoy:-2.1},
      {country:'Japan', volume:8000, value:320, yoy:1.8},
      {country:'USA', volume:6500, value:260, yoy:5.4},
    ],
    usImports: [
      {country:'Norway', pct:24},
      {country:'Canada', pct:19},
      {country:'Japan', pct:17},
      {country:'Finland', pct:14},
      {country:'China', pct:12},
      {country:'Other', pct:14},
    ],
    flows: [
      ['DRC','China',3800],['DRC','Finland',450],['DRC','Belgium',320],
      ['Indonesia','China',380],['Russia','Finland',120],['Russia','China',100],
      ['Australia','China',180],['Philippines','China',150],['DRC','Japan',200],
    ]
  },
  Nickel: {
    hsCode: '2604.00 / 7502.10',
    unit: 'Tonnes (metal content)',
    globalTrade: 3200000,
    exporters: [
      {country:'Indonesia', volume:1650000, value:28000, yoy:18.5},
      {country:'Philippines', volume:380000, value:4200, yoy:5.2},
      {country:'Russia', volume:195000, value:5100, yoy:-12.3},
      {country:'New Caledonia', volume:160000, value:2800, yoy:-6.1},
      {country:'Australia', volume:145000, value:3200, yoy:3.8},
    ],
    importers: [
      {country:'China', volume:1450000, value:22000, yoy:14.2},
      {country:'Japan', volume:280000, value:5600, yoy:-1.5},
      {country:'EU', volume:320000, value:6400, yoy:4.8},
      {country:'South Korea', volume:185000, value:3700, yoy:7.2},
      {country:'USA', volume:120000, value:2400, yoy:6.1},
    ],
    usImports: [
      {country:'Canada', pct:42},
      {country:'Australia', pct:15},
      {country:'Norway', pct:10},
      {country:'Finland', pct:9},
      {country:'Russia', pct:6},
      {country:'Other', pct:18},
    ],
    flows: [
      ['Indonesia','China',18000],['Indonesia','Japan',3200],['Indonesia','South Korea',2800],
      ['Philippines','China',2800],['Philippines','Japan',1200],['Russia','EU',2400],
      ['Russia','China',1500],['Australia','Japan',800],['New Caledonia','EU',1800],
      ['Canada','USA',1400],['Australia','USA',520],
    ]
  },
  'Rare Earths': {
    hsCode: '2846.10-90 / 2805.30',
    unit: 'Tonnes REO',
    globalTrade: 125000,
    exporters: [
      {country:'China', volume:72000, value:5400, yoy:-4.2},
      {country:'Myanmar', volume:18000, value:900, yoy:15.3},
      {country:'Australia', volume:12000, value:960, yoy:8.7},
      {country:'USA', volume:8000, value:640, yoy:25.0},
      {country:'Malaysia', volume:4500, value:360, yoy:12.1},
    ],
    importers: [
      {country:'Japan', volume:32000, value:2560, yoy:2.1},
      {country:'USA', volume:18000, value:1440, yoy:8.5},
      {country:'EU', volume:15000, value:1200, yoy:14.3},
      {country:'South Korea', volume:12000, value:960, yoy:6.8},
      {country:'India', volume:5000, value:400, yoy:22.0},
    ],
    usImports: [
      {country:'China', pct:72},
      {country:'Estonia', pct:8},
      {country:'Japan', pct:7},
      {country:'Malaysia', pct:6},
      {country:'Australia', pct:4},
      {country:'Other', pct:3},
    ],
    flows: [
      ['China','Japan',2200],['China','USA',1200],['China','EU',800],['China','South Korea',680],
      ['China','India',320],['Myanmar','China',750],['Australia','Japan',280],
      ['Australia','EU',200],['USA','Japan',180],['Malaysia','Japan',150],
    ]
  },
  Copper: {
    hsCode: '2603.00 / 7403.11',
    unit: 'Tonnes',
    globalTrade: 25000000,
    exporters: [
      {country:'Chile', volume:5800000, value:52200, yoy:2.1},
      {country:'Peru', volume:2400000, value:21600, yoy:-3.5},
      {country:'DRC', volume:2800000, value:25200, yoy:22.0},
      {country:'Australia', volume:950000, value:8550, yoy:5.8},
      {country:'Indonesia', volume:1200000, value:10800, yoy:8.3},
    ],
    importers: [
      {country:'China', volume:12500000, value:112500, yoy:6.2},
      {country:'Japan', volume:1400000, value:12600, yoy:-2.1},
      {country:'EU', volume:2800000, value:25200, yoy:3.5},
      {country:'South Korea', volume:950000, value:8550, yoy:4.8},
      {country:'USA', volume:850000, value:7650, yoy:5.1},
    ],
    usImports: [
      {country:'Chile', pct:35},
      {country:'Canada', pct:28},
      {country:'Mexico', pct:15},
      {country:'Peru', pct:10},
      {country:'Other', pct:12},
    ],
    flows: [
      ['Chile','China',28000],['Chile','Japan',5200],['Chile','South Korea',4800],['Chile','USA',3800],
      ['Peru','China',12000],['Peru','USA',2200],['DRC','China',18000],
      ['Australia','China',5500],['Australia','Japan',2200],['Indonesia','China',8500],
      ['Canada','USA',3200],['Mexico','USA',1600],
    ]
  },
  Graphite: {
    hsCode: '2504.10-90',
    unit: 'Tonnes',
    globalTrade: 1600000,
    exporters: [
      {country:'China', volume:680000, value:1360, yoy:-2.5},
      {country:'Mozambique', volume:180000, value:360, yoy:35.0},
      {country:'Brazil', volume:115000, value:230, yoy:4.2},
      {country:'Madagascar', volume:75000, value:150, yoy:8.1},
      {country:'India', volume:50000, value:100, yoy:6.3},
    ],
    importers: [
      {country:'Japan', volume:180000, value:360, yoy:3.5},
      {country:'South Korea', volume:145000, value:290, yoy:12.1},
      {country:'EU', volume:165000, value:330, yoy:8.4},
      {country:'USA', volume:95000, value:190, yoy:15.2},
      {country:'India', volume:85000, value:170, yoy:10.5},
    ],
    usImports: [
      {country:'China', pct:33},
      {country:'Mexico', pct:22},
      {country:'Canada', pct:15},
      {country:'Madagascar', pct:12},
      {country:'Mozambique', pct:8},
      {country:'Other', pct:10},
    ],
    flows: [
      ['China','Japan',250],['China','South Korea',200],['China','EU',180],['China','USA',120],
      ['Mozambique','EU',80],['Mozambique','China',60],['Brazil','EU',45],['Brazil','USA',35],
      ['Madagascar','USA',28],['Madagascar','EU',22],
    ]
  },
  Gallium: {
    hsCode: '8112.92',
    unit: 'Tonnes',
    globalTrade: 600,
    exporters: [
      {country:'China', volume:480, value:288, yoy:-15.0},
      {country:'Japan', volume:30, value:18, yoy:5.2},
      {country:'South Korea', volume:22, value:13.2, yoy:8.0},
      {country:'Russia', volume:12, value:7.2, yoy:-22.0},
      {country:'Germany', volume:8, value:4.8, yoy:12.0},
    ],
    importers: [
      {country:'Japan', volume:120, value:72, yoy:-8.5},
      {country:'USA', volume:65, value:39, yoy:-12.0},
      {country:'EU', volume:85, value:51, yoy:-5.2},
      {country:'South Korea', volume:55, value:33, yoy:2.1},
      {country:'Taiwan', volume:45, value:27, yoy:-3.8},
    ],
    usImports: [
      {country:'China', pct:53},
      {country:'UK', pct:14},
      {country:'Germany', pct:12},
      {country:'Japan', pct:11},
      {country:'Other', pct:10},
    ],
    flows: [
      ['China','Japan',52],['China','USA',28],['China','EU',32],['China','South Korea',25],
      ['China','Taiwan',20],['Japan','USA',8],['Germany','USA',5],
    ]
  },
  Germanium: {
    hsCode: '8112.92',
    unit: 'Tonnes',
    globalTrade: 180,
    exporters: [
      {country:'China', volume:95, value:142, yoy:-18.0},
      {country:'Belgium', volume:25, value:37.5, yoy:4.5},
      {country:'Canada', volume:18, value:27, yoy:6.2},
      {country:'Russia', volume:8, value:12, yoy:-25.0},
      {country:'USA', volume:6, value:9, yoy:10.0},
    ],
    importers: [
      {country:'USA', volume:35, value:52.5, yoy:-8.0},
      {country:'Japan', volume:30, value:45, yoy:2.5},
      {country:'EU', volume:28, value:42, yoy:5.8},
      {country:'South Korea', volume:15, value:22.5, yoy:12.0},
      {country:'Taiwan', volume:12, value:18, yoy:4.3},
    ],
    usImports: [
      {country:'China', pct:42},
      {country:'Belgium', pct:22},
      {country:'Germany', pct:13},
      {country:'Russia', pct:8},
      {country:'Other', pct:15},
    ],
    flows: [
      ['China','Japan',28],['China','USA',22],['China','EU',18],['China','South Korea',12],
      ['Belgium','USA',10],['Belgium','EU',8],['Canada','USA',7],
    ]
  },
  Tungsten: {
    hsCode: '2611.00',
    unit: 'Tonnes (W content)',
    globalTrade: 95000,
    exporters: [
      {country:'China', volume:62000, value:1860, yoy:-3.8},
      {country:'Vietnam', volume:6200, value:186, yoy:12.5},
      {country:'Russia', volume:3200, value:96, yoy:-15.0},
      {country:'Bolivia', volume:2100, value:63, yoy:8.2},
      {country:'Rwanda', volume:1800, value:54, yoy:18.0},
    ],
    importers: [
      {country:'Japan', volume:8500, value:255, yoy:2.8},
      {country:'USA', volume:7200, value:216, yoy:4.5},
      {country:'EU', volume:12000, value:360, yoy:3.2},
      {country:'South Korea', volume:5500, value:165, yoy:6.8},
      {country:'India', volume:3200, value:96, yoy:15.0},
    ],
    usImports: [
      {country:'China', pct:32},
      {country:'Germany', pct:18},
      {country:'Bolivia', pct:15},
      {country:'Canada', pct:12},
      {country:'Other', pct:23},
    ],
    flows: [
      ['China','Japan',180],['China','USA',95],['China','EU',220],['China','South Korea',110],
      ['China','India',65],['Vietnam','Japan',45],['Vietnam','EU',38],
      ['Russia','EU',55],['Bolivia','USA',35],['Rwanda','EU',22],
    ]
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRICING DATA â€” Based on World Bank Commodity Price Data (Pink Sheet)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PRICING_DATA = {
  'Lithium Carbonate': {
    unit: '$/tonne',
    current: 10800,
    yoyChange: -28.5,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [8500,9200,12500,28000,38000,52000,68000,82000,72000,42000,28000,18000,15200,13800,12500,11800,15100,14200,12800,11200,10800],
    color: '#3b82f6'
  },
  'Cobalt': {
    unit: '$/tonne',
    current: 24200,
    yoyChange: -18.2,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [36500,42000,52000,56000,72000,82000,55000,52000,35000,33500,32000,30000,28500,27200,29500,26800,29600,28000,26200,25100,24200],
    color: '#8b5cf6'
  },
  'Nickel': {
    unit: '$/tonne',
    current: 15400,
    yoyChange: -8.3,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [18200,17800,19200,20500,22800,33000,22000,23500,28500,24000,21500,18200,16500,18200,17000,15800,16800,16200,15800,15600,15400],
    color: '#06b6d4'
  },
  'Copper': {
    unit: '$/tonne',
    current: 9250,
    yoyChange: 5.7,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [7950,9200,9400,9600,9800,10200,7600,7700,9100,8800,8500,8000,8400,9800,9500,9600,8750,9100,9400,9100,9250],
    color: '#f59e0b'
  },
  'Rare Earths (NdPr Oxide)': {
    unit: '$/kg',
    current: 52,
    yoyChange: -12.4,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [55,70,85,120,140,120,90,75,72,68,55,50,62,68,58,55,59.4,58,55,53,52],
    color: '#ec4899'
  },
  'Tungsten (APT)': {
    unit: '$/mtu',
    current: 325,
    yoyChange: 8.3,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [275,280,290,295,310,325,300,295,280,285,295,290,285,295,310,320,300,310,320,318,325],
    color: '#f97316'
  },
  'Manganese (Mn 99.7%)': {
    unit: '$/tonne',
    current: 1850,
    yoyChange: -5.2,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [1620,1750,1880,2050,2280,2450,2350,2200,2100,1980,1920,1850,1900,2050,2100,1980,1950,1920,1880,1860,1850],
    color: '#22c55e'
  },
  'Vanadium (Vâ‚‚Oâ‚…)': {
    unit: '$/lb',
    current: 6.20,
    yoyChange: -14.8,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [7.80,8.50,9.20,10.50,12.80,14.20,11.50,9.80,8.50,7.90,7.20,6.80,7.50,8.20,7.80,7.10,7.28,7.00,6.60,6.35,6.20],
    color: '#6366f1'
  },
  'Graphite (Flake, Large)': {
    unit: '$/tonne',
    current: 680,
    yoyChange: -12.0,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [520,560,610,680,750,820,880,920,950,880,820,780,750,780,760,720,773,740,710,690,680],
    color: '#14b8a6'
  },
  'Uranium (Uâ‚ƒOâ‚ˆ)': {
    unit: '$/lb',
    current: 78,
    yoyChange: 22.5,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [29,31,33,42,43,50,48,50,51,53,56,72,95,88,82,78,63.7,68,72,75,78],
    color: '#d946ef'
  },
  'Platinum': {
    unit: '$/oz',
    current: 985,
    yoyChange: 3.8,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [1090,1220,1080,1020,1020,960,880,920,1050,1080,940,880,920,950,980,960,949,960,970,978,985],
    color: '#84cc16'
  }
};

// Pills â€” with section pills
const pillsEl=document.getElementById('pills');
const sections=[
  {id:'overview',label:'Overview',fn:showOverview},
  {id:'sankey',label:'Supply Chain Flow',fn:showSankey},
  {id:'trade',label:'Trade Flows',fn:showTrade},
  {id:'pricing',label:'Pricing',fn:showPricingView},
];
sections.forEach(s=>{
  const p=document.createElement('div');
  p.className='pill section-pill'+(s.id==='overview'?' active':'');
  p.textContent=s.label;
  p.dataset.section=s.id;
  p.onclick=s.fn;
  pillsEl.appendChild(p);
});

const sep=document.createElement('div');
sep.className='pill-separator';
pillsEl.appendChild(sep);

Object.keys(MINERALS).forEach(m=>{
  const p=document.createElement('div');p.className='pill';p.textContent=m;
  p.onclick=()=>showMineral(m);pillsEl.appendChild(p);
});

// Populate trade mineral selector
const tradeSelect=document.getElementById('trade-mineral-select');
Object.keys(TRADE_DATA).forEach(m=>{
  const o=document.createElement('option');o.value=m;o.textContent=m;
  tradeSelect.appendChild(o);
});

// Overview grid
const gridEl=document.getElementById('overview-grid');
Object.entries(MINERALS).forEach(([name,d])=>{
  const risk=riskLevel(d.importReliance);
  const card=document.createElement('div');
  card.className='mineral-card';
  card.onclick=()=>showMineral(name);
  card.innerHTML=`
    <div class="mc-top">
      <div class="mc-name">${name}</div>
      <span class="mc-badge ${risk}">${risk==='high'?'High Risk':risk==='med'?'Moderate':'Lower'}</span>
    </div>
    <div class="mc-import ${risk}">${d.importLabel}</div>
    <div class="mc-sublabel">U.S. Net Import Reliance</div>
    <div class="mc-row"><span class="mc-label">Top Processor</span><span class="mc-val">${d.topProcessor}</span></div>
    <div class="mc-row"><span class="mc-label">China Refining</span><span class="mc-val">${d.chinaRefining}%</span></div>
  `;
  gridEl.appendChild(card);
});

function setActivePill(name){
  document.querySelectorAll('.pill').forEach(p=>{
    const sec=p.dataset.section;
    if(sec){
      const match=sections.find(s=>s.id===sec);
      p.classList.toggle('active',match&&match.label===name);
    } else {
      p.classList.toggle('active',p.textContent===name);
    }
  });
}

function hideAllViews(){
  document.getElementById('overview').style.display='none';
  document.getElementById('detail').classList.remove('active');
  document.getElementById('sankey-view').classList.remove('active');
  document.getElementById('trade-view').classList.remove('active');
  document.getElementById('pricing-view').classList.remove('active');
  destroyCharts();
}

function showOverview(){
  hideAllViews();
  setActivePill('Overview');
  document.getElementById('overview').style.display='';
}

function showSankey(){
  hideAllViews();
  setActivePill('Supply Chain Flow');
  document.getElementById('sankey-view').classList.add('active');
  renderSankey();
}

function showTrade(){
  hideAllViews();
  setActivePill('Trade Flows');
  document.getElementById('trade-view').classList.add('active');
  renderTradeView();
}

function showPricingView(){
  hideAllViews();
  setActivePill('Pricing');
  document.getElementById('pricing-view').classList.add('active');
  renderPricing();
}

function showMineral(name){
  hideAllViews();
  setActivePill(name);
  const d=MINERALS[name];
  document.getElementById('detail').classList.add('active');
  document.getElementById('detail-title').textContent=name;

  const risk=riskLevel(d.importReliance);
  const gaugeColor=risk==='high'?'var(--red)':risk==='med'?'var(--orange)':'var(--green)';
  const pct=d.importReliance;

  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card">
      <div class="stat-label">Import Reliance</div>
      <div class="stat-value" style="color:${gaugeColor}">${d.importLabel}</div>
      <div style="margin-top:.75rem">
        <div class="gauge-bar-track"><div class="gauge-bar-fill" style="width:${pct}%;background:${gaugeColor}"></div></div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-label">China Refining</div>
      <div class="stat-value" style="color:${d.chinaRefining>=70?'var(--red)':d.chinaRefining>=40?'var(--orange)':'var(--green)'}">${d.chinaRefining}%</div>
      <div class="stat-sub">of global processing</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Top Processor</div>
      <div class="stat-value" style="font-size:1.25rem;margin-top:.25rem">${d.topProcessor.split(' (')[0]}</div>
      <div class="stat-sub">${d.topProcessor}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Risk Level</div>
      <div class="stat-value" style="color:${gaugeColor}">${risk==='high'?'HIGH':risk==='med'?'MOD.':'LOW'}</div>
      <div class="stat-sub">supply chain vulnerability</div>
    </div>
  `;

  const cc=chartColors();

  charts.mining=new Chart(document.getElementById('miningChart').getContext('2d'),{type:'bar',data:{
    labels:d.mining.map(x=>x[0]),
    datasets:[{data:d.mining.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.mining.length),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} â€” Mining`,label:c=>`${c.label}: ${c.raw}% of global production`}
  }},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},
    y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.refining=new Chart(document.getElementById('refiningChart').getContext('2d'),{type:'bar',data:{
    labels:d.refining.map(x=>x[0]),
    datasets:[{data:d.refining.map(x=>x[1]),backgroundColor:d.refining.map(x=>x[0]==='China'?'#ef4444':COLORS[1]),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} â€” Refining`,label:c=>`${c.label}: ${c.raw}% of global processing`}
  }},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},
    y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.uses=new Chart(document.getElementById('usesChart').getContext('2d'),{type:'doughnut',data:{
    labels:d.uses.map(x=>x[0]),
    datasets:[{data:d.uses.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.uses.length),borderWidth:0,hoverOffset:6}]
  },options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{color:cc.legendText,font:{size:11,family:'Geist'},padding:8,usePointStyle:true,pointStyleWidth:8}},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} â€” End Uses`,label:c=>`${c.label}: ${c.raw}%`}
  }}}});

  // Clickable company tags
  document.getElementById('company-list').innerHTML=d.companies.map(([n,c])=>{
    const hasData = COMPANY_DB[n];
    if(hasData){
      return `<div class="company-tag" onclick="openCompanyPanel('${n.replace(/'/g,"\\'")}')">${n}<span class="co-country">${c}</span></div>`;
    }
    return `<div class="company-tag">${n}<span class="co-country">${c}</span></div>`;
  }).join('');
}

// â”€â”€ TRADE FLOWS RENDERING â”€â”€
function renderTradeView(){
  destroyCharts();
  const mineral=document.getElementById('trade-mineral-select').value;
  const d=TRADE_DATA[mineral];
  if(!d) return;

  const content=document.getElementById('trade-content');
  const fmtNum=n=>n>=1000?n.toLocaleString():n;
  const fmtVal=v=>v>=1000?'$'+v.toLocaleString()+'M':'$'+v+'M';
  const chgHtml=v=>`<span class="${v>=0?'change-pos':'change-neg'}">${v>=0?'â–²':'â–¼'} ${Math.abs(v)}%</span>`;

  // Sort flows by value descending, take top 10
  const sortedFlows = [...d.flows].sort((a,b)=>b[2]-a[2]).slice(0,10);

  let html=`
    <div style="margin-bottom:.75rem;font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">
      HS Code: ${d.hsCode} Â· Unit: ${d.unit} Â· Global trade volume: ~${fmtNum(d.globalTrade)} tonnes
    </div>

    <div class="trade-tables-grid">
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Exporters</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.exporters.map(e=>`<tr><td><span class="clickable-country" onclick="openCountryModal('${e.country}','${mineral}')">${COUNTRY_FLAGS[e.country]||''} ${e.country}</span></td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
      </div>
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Importers</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.importers.map(e=>`<tr><td><span class="clickable-country" onclick="openCountryModal('${e.country}','${mineral}')">${COUNTRY_FLAGS[e.country]||''} ${e.country}</span></td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>

    <div class="us-import-card">
      <h3>U.S. Import Sources â€” ${mineral}</h3>
      ${d.usImports.map(u=>`
        <div class="us-bar" onclick="openCountryModal('${u.country}','${mineral}')">
          <span class="us-bar-country">${COUNTRY_FLAGS[u.country]||''} ${u.country}</span>
          <div class="us-bar-track"><div class="us-bar-fill" style="width:${u.pct}%;background:${u.country==='China'?'var(--red)':'var(--accent)'}"></div></div>
          <span class="us-bar-pct">${u.pct}%</span>
        </div>
      `).join('')}
    </div>

    <div class="flow-table-wrap">
      <h3>Top Bilateral Trade Routes â€” ${mineral}</h3>
      <table class="data-table" id="flow-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Route</th>
            <th class="num sortable" onclick="sortFlowTable()" style="cursor:pointer">Value ($M) â†“</th>
          </tr>
        </thead>
        <tbody>
          ${sortedFlows.map(([from,to,val],i)=>`
            <tr>
              <td style="color:var(--text-muted);font-family:var(--font-mono);font-size:.75rem">${i+1}</td>
              <td>
                <span class="clickable-country" onclick="openCountryModal('${from}','${mineral}')">${COUNTRY_FLAGS[from]||''} ${from}</span>
                <span style="color:var(--text-muted);margin:0 .5rem">â†’</span>
                <span class="clickable-country" onclick="openCountryModal('${to}','${mineral}')">${COUNTRY_FLAGS[to]||''} ${to}</span>
              </td>
              <td class="num">$${val.toLocaleString()}M</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
  content.innerHTML=html;
}

let flowSortAsc = false;
function sortFlowTable(){
  const mineral=document.getElementById('trade-mineral-select').value;
  const d=TRADE_DATA[mineral];
  if(!d) return;
  flowSortAsc = !flowSortAsc;
  const sorted = [...d.flows].sort((a,b)=>flowSortAsc?a[2]-b[2]:b[2]-a[2]).slice(0,10);
  const tbody = document.querySelector('#flow-table tbody');
  const arrow = flowSortAsc?'â†‘':'â†“';
  document.querySelector('#flow-table th.sortable').textContent = 'Value ($M) '+arrow;
  tbody.innerHTML = sorted.map(([from,to,val],i)=>`
    <tr>
      <td style="color:var(--text-muted);font-family:var(--font-mono);font-size:.75rem">${i+1}</td>
      <td>
        <span class="clickable-country" onclick="openCountryModal('${from}','${mineral}')">${COUNTRY_FLAGS[from]||''} ${from}</span>
        <span style="color:var(--text-muted);margin:0 .5rem">â†’</span>
        <span class="clickable-country" onclick="openCountryModal('${to}','${mineral}')">${COUNTRY_FLAGS[to]||''} ${to}</span>
      </td>
      <td class="num">$${val.toLocaleString()}M</td>
    </tr>
  `).join('');
}

// â”€â”€ PRICING RENDERING â”€â”€
function renderPricing(){
  destroyCharts();
  const grid=document.getElementById('pricing-grid');
  grid.innerHTML='';
  const cc=chartColors();
  const dark=getTheme()==='dark';

  Object.entries(PRICING_DATA).forEach(([name,d],idx)=>{
    const card=document.createElement('div');
    card.className='pricing-card';
    const dir=d.yoyChange>=0?'up':'down';
    const arrow=d.yoyChange>=0?'â–²':'â–¼';
    const fmtPrice=d.current>=1000?'$'+d.current.toLocaleString():'$'+d.current;

    card.innerHTML=`
      <div class="pricing-card-header">
        <div class="pricing-card-left">
          <h3>${name}</h3>
          <span class="pricing-unit">${d.unit}</span>
        </div>
        <div class="pricing-current">
          <div class="price-big">${fmtPrice}</div>
          <div class="price-change ${dir}">${arrow} ${Math.abs(d.yoyChange)}% YoY</div>
        </div>
      </div>
      <div class="pricing-chart-wrap"><canvas id="priceChart${idx}"></canvas></div>
    `;
    grid.appendChild(card);

    const ctx=document.getElementById('priceChart'+idx).getContext('2d');
    charts['price'+idx]=new Chart(ctx,{
      type:'line',
      data:{
        labels:d.labels,
        datasets:[{
          data:d.prices,
          borderColor:d.color,
          backgroundColor:d.color+'18',
          fill:true,
          tension:.3,
          pointRadius:0,
          pointHitRadius:8,
          borderWidth:2,
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:dark?'#131316':'#ffffff',
            titleColor:dark?'#fafafa':'#09090b',
            bodyColor:dark?'#a1a1aa':'#52525b',
            borderColor:dark?'#27272a':'#e4e4e7',
            borderWidth:1,
            titleFont:{family:'Geist',weight:'600'},
            bodyFont:{family:'Geist Mono'},
            padding:10,cornerRadius:8,
            callbacks:{
              title:c=>c[0].label,
              label:c=>{
                const v=c.raw;
                if(d.unit.includes('/kg'))return `${name}: $${v}/kg`;
                if(d.unit.includes('/lb'))return `${name}: $${v}/lb`;
                if(d.unit.includes('/mtu'))return `${name}: $${v}/mtu`;
                if(d.unit.includes('/oz'))return `${name}: $${v}/oz`;
                return `${name}: $${v.toLocaleString()}`;
              }
            }
          }
        },
        scales:{
          x:{
            grid:{color:cc.grid},
            ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},maxRotation:0,maxTicksLimit:7}
          },
          y:{
            grid:{color:cc.grid},
            ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},callback:v=>{
              if(d.unit.includes('/kg'))return '$'+v;
              if(d.unit.includes('/lb'))return '$'+v;
              if(d.unit.includes('/mtu'))return '$'+v;
              if(d.unit.includes('/oz'))return '$'+v;
              return '$'+v.toLocaleString();
            }},
            beginAtZero:false
          }
        },
        interaction:{intersect:false,mode:'index'}
      }
    });
  });
}

// â”€â”€ SANKEY DIAGRAM â”€â”€
let sankeyActiveFilter='All';

function mapToSector(use){
  const u=use.toLowerCase();
  if(u.includes('ev batter')||u.includes('battery anode'))return 'EVs / Batteries';
  if(u.includes('grid')||u.includes('flow batter')||u.includes('nuclear')||u.includes('solar')||u.includes('hydrogen')||u.includes('fuel cell'))return 'Grid / Energy';
  if(u.includes('defense')||u.includes('naval')||u.includes('night vision')||u.includes('ir optic')||u.includes('aerospace')||u.includes('cutting tool')||u.includes('carbide')||u.includes('mill product')||u.includes('steels/alloy'))return 'Defense / Industrial';
  if(u.includes('semiconductor')||u.includes('gaas')||u.includes('led')||u.includes('optoelectronic')||u.includes('fiber optic')||u.includes('electronic'))return 'Semiconductors / Electronics';
  if(u.includes('portable')||u.includes('consumer')||u.includes('jewelry')||u.includes('plating'))return 'Consumer Products';
  if(u.includes('steel')||u.includes('aluminum')||u.includes('alloy')||u.includes('construction')||u.includes('foundri')||u.includes('industrial')||u.includes('transport'))return 'Heavy Industry';
  if(u.includes('catalyst')||u.includes('autocat')||u.includes('chemical')||u.includes('ceramic')||u.includes('glass')||u.includes('polish')||u.includes('lubricant')||u.includes('silicone')||u.includes('brake')||u.includes('magnet')||u.includes('metallurgy')||u.includes('research')||u.includes('medical'))return 'Other Industrial';
  return 'Other Industrial';
}

function buildSankeyData(filterMineral){
  const minerals=filterMineral==='All'?SANKEY_MINERALS:[filterMineral];
  const nodeMap={};
  const links=[];
  let nodeId=0;
  function getNode(name){if(!(name in nodeMap)){nodeMap[name]=nodeId++;}return nodeMap[name];}

  minerals.forEach(mName=>{
    const d=MINERALS[mName];
    const color=MINERAL_COLORS[mName];
    const topMining=d.mining.filter(x=>x[0]!=='Other').slice(0,4);
    const topRefining=d.refining.filter(x=>x[0]!=='Other').slice(0,3);
    const sectors={};
    d.uses.forEach(([use,pct])=>{
      const s=mapToSector(use);
      sectors[s]=(sectors[s]||0)+pct;
    });

    topMining.forEach(([country,pct])=>{
      const src='â› '+country;
      topRefining.forEach(([rCountry,rPct])=>{
        const tgt='âš™ '+rCountry;
        const val=Math.round(pct*rPct/100*10)/10;
        if(val>0.5){
          links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
        }
      });
    });

    topRefining.forEach(([rCountry,rPct])=>{
      const src='âš™ '+rCountry;
      Object.entries(sectors).forEach(([sector,sPct])=>{
        const tgt='ğŸ“¦ '+sector;
        const val=Math.round(rPct*sPct/100*10)/10;
        if(val>0.5){
          links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
        }
      });
    });
  });

  const nodes=Object.entries(nodeMap).map(([name,id])=>({name,id})).sort((a,b)=>a.id-b.id);
  return{nodes,links};
}

function renderSankey(){
  const container=document.getElementById('sankey-container');
  container.innerHTML='';
  const dark=getTheme()==='dark';
  const w=container.clientWidth-20;
  const h=Math.max(500,Math.min(700,w*0.55));

  const data=buildSankeyData(sankeyActiveFilter);
  if(!data.links.length){container.innerHTML='<p style="color:var(--text-muted);padding:2rem;text-align:center">No flow data for this selection.</p>';return;}

  const svg=d3.select(container).append('svg').attr('width',w).attr('height',h);

  const sankey=d3.sankey()
    .nodeId(d=>d.id)
    .nodeWidth(14)
    .nodePadding(10)
    .nodeAlign(d3.sankeyLeft)
    .extent([[1,1],[w-1,h-6]]);

  const graph=sankey({
    nodes:data.nodes.map(d=>({...d})),
    links:data.links.map(d=>({...d}))
  });

  const tooltip=document.getElementById('sankey-tooltip');
  function showTip(evt,html){
    tooltip.querySelector('.tt-title').innerHTML=html.title||'';
    tooltip.querySelector('.tt-val').innerHTML=html.val||'';
    tooltip.querySelector('.tt-sub').innerHTML=html.sub||'';
    tooltip.style.left=evt.clientX+12+'px';
    tooltip.style.top=evt.clientY-10+'px';
    tooltip.classList.add('visible');
  }
  function hideTip(){tooltip.classList.remove('visible');}

  const link=svg.append('g').attr('fill','none').selectAll('g')
    .data(graph.links).join('g')
    .attr('class','sankey-link');

  link.append('path')
    .attr('d',d3.sankeyLinkHorizontal())
    .attr('stroke',d=>d.color||'#3b82f6')
    .attr('stroke-opacity',.35)
    .attr('stroke-width',d=>Math.max(1,d.width))
    .on('mouseover',function(evt,d){
      d3.select(this).attr('stroke-opacity',.7);
      showTip(evt,{title:d.mineral,val:`${d.source.name} â†’ ${d.target.name}`,sub:`Flow weight: ${d.value}`});
    })
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px';})
    .on('mouseout',function(){d3.select(this).attr('stroke-opacity',.35);hideTip();});

  const node=svg.append('g').selectAll('g')
    .data(graph.nodes).join('g');

  let selectedNode=null;
  node.append('rect')
    .attr('x',d=>d.x0).attr('y',d=>d.y0)
    .attr('height',d=>Math.max(1,d.y1-d.y0))
    .attr('width',sankey.nodeWidth())
    .attr('fill',d=>{
      if(d.name.startsWith('â›'))return dark?'#a1a1aa':'#52525b';
      if(d.name.startsWith('âš™'))return dark?'#ef4444':'#dc2626';
      return dark?'#3b82f6':'#2563eb';
    })
    .attr('rx',3)
    .attr('cursor','pointer')
    .on('mouseover',function(evt,d){
      showTip(evt,{title:d.name,val:`Total flow: ${Math.round(d.value)}`,sub:`${d.sourceLinks.length} outgoing Â· ${d.targetLinks.length} incoming`});
    })
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px';})
    .on('mouseout',function(){hideTip();})
    .on('click',function(evt,d){
      if(selectedNode===d){
        selectedNode=null;
        svg.selectAll('path').attr('stroke-opacity',.35);
        return;
      }
      selectedNode=d;
      const connectedLinks=new Set();
      d.sourceLinks.forEach(l=>connectedLinks.add(l.index));
      d.targetLinks.forEach(l=>connectedLinks.add(l.index));
      svg.selectAll('.sankey-link path').attr('stroke-opacity',(l,i)=>connectedLinks.has(i)?.7:.08);
    });

  node.append('text')
    .attr('x',d=>d.x0<w/2?d.x1+6:d.x0-6)
    .attr('y',d=>(d.y1+d.y0)/2)
    .attr('dy','0.35em')
    .attr('text-anchor',d=>d.x0<w/2?'start':'end')
    .text(d=>d.name)
    .attr('fill',dark?'#fafafa':'#09090b')
    .attr('font-size','11px')
    .attr('font-family','Geist, sans-serif');

  const legendEl=document.getElementById('sankey-legend');
  legendEl.innerHTML='';
  const shownMinerals=sankeyActiveFilter==='All'?SANKEY_MINERALS:[sankeyActiveFilter];
  shownMinerals.forEach(m=>{
    const s=document.createElement('span');
    s.innerHTML=`<div class="sankey-legend-dot" style="background:${MINERAL_COLORS[m]}"></div>${m}`;
    legendEl.appendChild(s);
  });
}

// Sankey filter pills
(function(){
  const wrap=document.getElementById('sankey-filters');
  const all=document.createElement('button');
  all.className='sankey-filter active';all.textContent='All Minerals';
  all.onclick=()=>{sankeyActiveFilter='All';updateSankeyFilters();renderSankey();};
  wrap.appendChild(all);
  SANKEY_MINERALS.forEach(m=>{
    const b=document.createElement('button');b.className='sankey-filter';b.textContent=m;
    b.onclick=()=>{sankeyActiveFilter=m;updateSankeyFilters();renderSankey();};
    wrap.appendChild(b);
  });
})();
function updateSankeyFilters(){
  document.querySelectorAll('.sankey-filter').forEach(b=>{
    b.classList.toggle('active',
      (sankeyActiveFilter==='All'&&b.textContent==='All Minerals')||b.textContent===sankeyActiveFilter);
  });
}

// Close panels on Escape
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeCompanyPanel();
    closeCountryModal();
  }
});

showOverview();
</script>
</body>
</html>