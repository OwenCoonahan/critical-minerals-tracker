<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Critical Minerals Tracker | U.S. Dependency & Global Supply Chain Analysis</title>
<meta name="description" content="Interactive dashboard tracking U.S. critical mineral dependencies, global supply chains, and geopolitical risk factors.">
<meta property="og:title" content="Critical Minerals Tracker">
<meta property="og:description" content="U.S. Dependency & Global Supply Chain Analysis — 14 critical minerals, real data from USGS 2024/2025">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geist:wght@300;400;500;600;700&family=Geist+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --font-sans: 'Geist', -apple-system, sans-serif;
  --font-mono: 'Geist Mono', ui-monospace, monospace;
  --radius: 10px;
  --radius-lg: 14px;
}

[data-theme="dark"]{
  --bg: #09090b;
  --bg-elevated: #0f0f12;
  --surface: #131316;
  --surface-hover: #1a1a1f;
  --border: #27272a;
  --border-hover: #3f3f46;
  --text: #fafafa;
  --text-secondary: #a1a1aa;
  --text-muted: #71717a;
  --accent: #3b82f6;
  --red: #ef4444;
  --red-muted: rgba(239,68,68,.12);
  --orange: #f59e0b;
  --orange-muted: rgba(245,158,11,.12);
  --green: #22c55e;
  --green-muted: rgba(34,197,94,.12);
  --chart-grid: #1e1e22;
}

[data-theme="light"]{
  --bg: #ffffff;
  --bg-elevated: #fafafa;
  --surface: #ffffff;
  --surface-hover: #f4f4f5;
  --border: #e4e4e7;
  --border-hover: #d4d4d8;
  --text: #09090b;
  --text-secondary: #52525b;
  --text-muted: #a1a1aa;
  --accent: #2563eb;
  --red: #dc2626;
  --red-muted: rgba(220,38,38,.08);
  --orange: #d97706;
  --orange-muted: rgba(217,119,6,.08);
  --green: #16a34a;
  --green-muted: rgba(22,163,74,.08);
  --chart-grid: #f0f0f2;
}

body{
  font-family:var(--font-sans);
  background:var(--bg);
  color:var(--text);
  line-height:1.6;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition: background .2s, color .2s;
}

/* Header */
.header{
  border-bottom:1px solid var(--border);
  padding:1.5rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
  max-width:1400px;
  margin:0 auto;
}
.header-left h1{
  font-size:1.25rem;
  font-weight:600;
  letter-spacing:-.02em;
  color:var(--text);
}
.header-left p{
  color:var(--text-muted);
  font-size:.8125rem;
  margin-top:.125rem;
  font-weight:400;
}
.header-right{display:flex;align-items:center;gap:.75rem}
.last-updated{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
  padding:.25rem .625rem;
  border:1px solid var(--border);
  border-radius:var(--radius);
  white-space:nowrap;
}
.theme-toggle{
  width:36px;height:36px;
  border-radius:var(--radius);
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .15s;
  flex-shrink:0;
}
.theme-toggle:hover{background:var(--surface-hover);border-color:var(--border-hover);color:var(--text)}
.theme-toggle svg{width:16px;height:16px}

/* Pills */
.pills-wrap{
  padding:.75rem 2rem;
  display:flex;
  flex-wrap:wrap;
  gap:.375rem;
  border-bottom:1px solid var(--border);
  max-width:1400px;
  margin:0 auto;
  align-items:center;
}
.pill{
  padding:.375rem .75rem;
  border-radius:999px;
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid transparent;
  background:transparent;
  color:var(--text-muted);
  transition:all .15s;
  white-space:nowrap;
}
.pill:hover{color:var(--text);background:var(--surface-hover)}
.pill.active{
  background:var(--text);
  color:var(--bg);
  border-color:var(--text);
}
.pill.section-pill{
  font-weight:600;
}
.pill-separator{
  width:1px;height:20px;background:var(--border);margin:0 .25rem;align-self:center;
}

/* Container */
.container{max-width:1400px;margin:0 auto;padding:2rem}

/* Overview */
.overview-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.overview-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.legend{display:flex;gap:1rem;font-size:.75rem;color:var(--text-muted)}
.legend span{display:flex;align-items:center;gap:.375rem}
.legend-dot{width:8px;height:8px;border-radius:50%}
.legend-dot.red{background:var(--red)}
.legend-dot.yellow{background:var(--orange)}
.legend-dot.green{background:var(--green)}

/* Overview Grid */
.overview-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:.75rem;
}
.mineral-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  cursor:pointer;
  transition:all .15s;
  position:relative;
}
.mineral-card:hover{
  border-color:var(--border-hover);
  background:var(--surface-hover);
}
.mc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
.mc-name{font-size:.875rem;font-weight:600;letter-spacing:-.01em}
.mc-badge{
  font-family:var(--font-mono);
  font-size:.6875rem;
  font-weight:500;
  padding:.2rem .5rem;
  border-radius:999px;
  letter-spacing:.01em;
}
.mc-badge.high{background:var(--red-muted);color:var(--red)}
.mc-badge.med{background:var(--orange-muted);color:var(--orange)}
.mc-badge.low{background:var(--green-muted);color:var(--green)}

.mc-import{
  font-family:var(--font-mono);
  font-size:2rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
  margin-bottom:.25rem;
}
.mc-import.high{color:var(--red)}
.mc-import.med{color:var(--orange)}
.mc-import.low{color:var(--green)}

.mc-sublabel{font-size:.75rem;color:var(--text-muted);margin-bottom:1rem}

.mc-row{display:flex;justify-content:space-between;font-size:.8125rem;padding:.25rem 0}
.mc-row+.mc-row{border-top:1px solid var(--border)}
.mc-label{color:var(--text-muted)}
.mc-val{font-family:var(--font-mono);font-weight:500;font-size:.8125rem}

/* Detail View */
.detail{display:none}
.detail.active{display:block}
.detail-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:2rem;
}
.detail-header h2{font-size:1.25rem;font-weight:600;letter-spacing:-.02em}
.back-btn{
  padding:.5rem .875rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-secondary);
  font-family:var(--font-sans);
  transition:all .15s;
}
.back-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}

/* Stat Cards */
.stats-row{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:.75rem;
  margin-bottom:2rem;
}
.stat-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.stat-label{
  font-size:.75rem;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:.05em;
  font-weight:500;
  margin-bottom:.75rem;
}
.stat-value{
  font-family:var(--font-mono);
  font-size:1.75rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
}
.stat-sub{font-size:.75rem;color:var(--text-muted);margin-top:.375rem}

/* Gauge */
.gauge-wrap{display:flex;align-items:center;gap:1rem}
.gauge-bar-track{
  flex:1;height:8px;border-radius:99px;
  background:var(--border);
  overflow:hidden;
}
.gauge-bar-fill{height:100%;border-radius:99px;transition:width .4s ease}

/* Charts */
.charts-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:.75rem;
  margin-bottom:.75rem;
}
.chart-box{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.chart-box h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}
.chart-box canvas{max-height:280px}

/* Companies */
.company-list{display:flex;flex-wrap:wrap;gap:.375rem}
.company-tag{
  padding:.375rem .625rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  background:var(--surface-hover);
  border:1px solid var(--border);
  color:var(--text);
  font-weight:400;
}
.company-tag .co-country{color:var(--text-muted);margin-left:.25rem;font-size:.75rem}

/* Sankey Section */
#sankey-view{display:none}
#sankey-view.active{display:block}
.sankey-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.sankey-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.sankey-legend{display:flex;flex-wrap:wrap;gap:.625rem;font-size:.75rem;color:var(--text-muted)}
.sankey-legend span{display:flex;align-items:center;gap:.375rem}
.sankey-legend-dot{width:10px;height:10px;border-radius:3px}
.sankey-container{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  overflow-x:auto;
}
.sankey-container svg text{
  font-family:var(--font-sans);
  font-size:11px;
  fill:var(--text);
}
.sankey-tooltip{
  position:fixed;
  pointer-events:none;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:.625rem .875rem;
  font-family:var(--font-sans);
  font-size:.8125rem;
  color:var(--text);
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  z-index:1000;
  max-width:260px;
  opacity:0;
  transition:opacity .12s;
}
.sankey-tooltip.visible{opacity:1}
.sankey-tooltip .tt-title{font-weight:600;margin-bottom:.25rem}
.sankey-tooltip .tt-val{font-family:var(--font-mono);font-weight:500;color:var(--accent)}
.sankey-tooltip .tt-sub{color:var(--text-muted);font-size:.75rem;margin-top:.125rem}
.sankey-filter-wrap{
  display:flex;flex-wrap:wrap;gap:.375rem;margin-bottom:1rem;
}
.sankey-filter{
  padding:.25rem .625rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:500;
  cursor:pointer;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text-muted);
  transition:all .15s;
  font-family:var(--font-sans);
}
.sankey-filter:hover{color:var(--text);background:var(--surface-hover)}
.sankey-filter.active{background:var(--text);color:var(--bg);border-color:var(--text)}

/* ── Trade Flows Section ── */
#trade-view{display:none}
#trade-view.active{display:block}

.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:1rem;
  margin-bottom:1.5rem;
}
.section-header h2{font-size:1rem;font-weight:500;color:var(--text-secondary)}
.section-attribution{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
}

.trade-controls{
  display:flex;gap:.5rem;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;
}
.trade-select{
  padding:.5rem .875rem;
  border-radius:var(--radius);
  font-size:.8125rem;
  font-weight:500;
  border:1px solid var(--border);
  background:var(--surface);
  color:var(--text);
  font-family:var(--font-sans);
  cursor:pointer;
  transition:all .15s;
  appearance:none;
  -webkit-appearance:none;
  padding-right:2rem;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' viewBox='0 0 24 24' stroke='%2371717a' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right .625rem center;
}
.trade-select:hover{border-color:var(--border-hover)}
.trade-select:focus{outline:none;border-color:var(--accent)}

/* Data tables */
.data-table-wrap{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  overflow:hidden;
}
.data-table{
  width:100%;
  border-collapse:collapse;
  font-size:.8125rem;
}
.data-table thead{
  background:var(--bg-elevated);
}
.data-table th{
  padding:.75rem 1rem;
  text-align:left;
  font-weight:600;
  font-size:.75rem;
  color:var(--text-muted);
  text-transform:uppercase;
  letter-spacing:.04em;
  border-bottom:1px solid var(--border);
}
.data-table th.num{text-align:right}
.data-table td{
  padding:.625rem 1rem;
  border-bottom:1px solid var(--border);
  color:var(--text);
}
.data-table td.num{
  text-align:right;
  font-family:var(--font-mono);
  font-weight:500;
  font-size:.8125rem;
}
.data-table tbody tr:last-child td{border-bottom:none}
.data-table tbody tr:nth-child(even){background:var(--bg-elevated)}
.data-table tbody tr:hover{background:var(--surface-hover)}

.change-pos{color:var(--green);font-family:var(--font-mono);font-size:.75rem}
.change-neg{color:var(--red);font-family:var(--font-mono);font-size:.75rem}

.trade-tables-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:.75rem;
  margin-bottom:.75rem;
}

.us-import-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  margin-bottom:.75rem;
}
.us-import-card h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}
.us-bar{
  display:flex;align-items:center;gap:.75rem;
  padding:.375rem 0;
  font-size:.8125rem;
}
.us-bar+.us-bar{border-top:1px solid var(--border)}
.us-bar-country{width:100px;color:var(--text);font-weight:500;flex-shrink:0}
.us-bar-track{flex:1;height:20px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
.us-bar-fill{height:100%;border-radius:4px;background:var(--accent);transition:width .4s ease}
.us-bar-pct{width:48px;text-align:right;font-family:var(--font-mono);font-weight:600;font-size:.8125rem;color:var(--text-secondary);flex-shrink:0}

/* Chord diagram */
.chord-container{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
  margin-bottom:.75rem;
}
.chord-container h3{
  font-size:.8125rem;
  font-weight:500;
  color:var(--text-secondary);
  margin-bottom:1rem;
}

/* ── Pricing Section ── */
#pricing-view{display:none}
#pricing-view.active{display:block}

.pricing-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(420px,1fr));
  gap:.75rem;
}
.pricing-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:1.25rem;
}
.pricing-card-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:1rem;
}
.pricing-card-left h3{
  font-size:.875rem;
  font-weight:600;
  letter-spacing:-.01em;
  margin-bottom:.25rem;
}
.pricing-card-left .pricing-unit{
  font-size:.6875rem;
  color:var(--text-muted);
  font-family:var(--font-mono);
}
.pricing-current{
  text-align:right;
}
.pricing-current .price-big{
  font-family:var(--font-mono);
  font-size:1.75rem;
  font-weight:700;
  letter-spacing:-.03em;
  line-height:1;
}
.pricing-current .price-change{
  font-family:var(--font-mono);
  font-size:.75rem;
  font-weight:600;
  margin-top:.25rem;
}
.pricing-current .price-change.up{color:var(--green)}
.pricing-current .price-change.down{color:var(--red)}
.pricing-chart-wrap{height:200px;position:relative}
.pricing-chart-wrap canvas{width:100%!important;height:100%!important}

/* Footer */
.footer{
  text-align:center;
  padding:2.5rem 2rem;
  font-size:.75rem;
  color:var(--text-muted);
  border-top:1px solid var(--border);
  max-width:1400px;
  margin:2rem auto 0;
  line-height:1.8;
}
.footer-brand{font-weight:500;color:var(--text-secondary)}

/* Responsive */
@media(max-width:768px){
  .header{padding:1rem}
  .header-left h1{font-size:1.125rem}
  .pills-wrap{padding:.625rem 1rem}
  .container{padding:1rem}
  .charts-grid,.trade-tables-grid{grid-template-columns:1fr}
  .overview-grid{grid-template-columns:1fr 1fr}
  .stats-row{grid-template-columns:1fr 1fr}
  .pricing-grid{grid-template-columns:1fr}
}
@media(max-width:480px){
  .overview-grid{grid-template-columns:1fr}
  .stats-row{grid-template-columns:1fr}
  .pricing-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>Critical Minerals Tracker</h1>
    <p>U.S. Dependency & Global Supply Chain Analysis</p>
  </div>
  <div class="header-right">
    <span class="last-updated">Updated Feb 2026</span>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme" id="themeBtn">
      <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="display:none"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/></svg>
      <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"/></svg>
    </button>
  </div>
</div>

<div class="pills-wrap" id="pills"></div>

<div class="container">
  <div id="overview">
    <div class="overview-header">
      <h2>Supply Chain Risk Overview</h2>
      <div class="legend">
        <span><div class="legend-dot red"></div>High Risk (≥75%)</span>
        <span><div class="legend-dot yellow"></div>Moderate (40–74%)</span>
        <span><div class="legend-dot green"></div>Lower (&lt;40%)</span>
      </div>
    </div>
    <div class="overview-grid" id="overview-grid"></div>
  </div>

  <div id="sankey-view">
    <div class="sankey-header">
      <h2>Supply Chain Flow — Mining → Processing → End Use</h2>
    </div>
    <div class="sankey-filter-wrap" id="sankey-filters"></div>
    <div class="sankey-legend" id="sankey-legend"></div>
    <div class="sankey-container" id="sankey-container"></div>
  </div>

  <div id="trade-view">
    <div class="section-header">
      <h2>Global Trade Flows</h2>
      <span class="section-attribution">Data: USGS, UN Comtrade · Last updated: February 2026</span>
    </div>
    <div class="trade-controls">
      <select class="trade-select" id="trade-mineral-select" onchange="renderTradeView()"></select>
    </div>
    <div id="trade-content"></div>
  </div>

  <div id="pricing-view">
    <div class="section-header">
      <h2>Commodity Pricing — 5-Year History</h2>
      <span class="section-attribution">Data: World Bank Commodity Price Data (Pink Sheet) · Last updated: February 2026</span>
    </div>
    <div class="pricing-grid" id="pricing-grid"></div>
  </div>

  <div class="detail" id="detail">
    <div class="detail-header">
      <h2 id="detail-title"></h2>
      <button class="back-btn" onclick="showOverview()">← Back</button>
    </div>
    <div class="stats-row" id="stats-row"></div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Mining Production — Top Countries</h3><canvas id="miningChart"></canvas></div>
      <div class="chart-box"><h3>Refining / Processing</h3><canvas id="refiningChart"></canvas></div>
    </div>
    <div class="charts-grid">
      <div class="chart-box"><h3>Primary End Uses</h3><canvas id="usesChart"></canvas></div>
      <div class="chart-box" id="companies-section">
        <h3>Key Companies</h3>
        <div class="company-list" id="company-list"></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Sources: USGS Mineral Commodity Summaries 2024/2025 · UN Comtrade · World Bank Commodity Markets · IEA Critical Minerals Market Review · DOE Critical Materials Assessment<br>
  <span class="footer-brand">Prospector Labs · Built by Owen Coonahan</span>
</div>

<div class="sankey-tooltip" id="sankey-tooltip">
  <div class="tt-title"></div>
  <div class="tt-val"></div>
  <div class="tt-sub"></div>
</div>

<script>
// Theme
function getTheme(){return document.documentElement.getAttribute('data-theme')}
function setTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('sunIcon').style.display=t==='dark'?'none':'block';
  document.getElementById('moonIcon').style.display=t==='dark'?'block':'none';
  localStorage.setItem('theme',t);
  if(document.getElementById('detail').classList.contains('active')){
    const name=document.getElementById('detail-title').textContent;
    if(name&&MINERALS[name])showMineral(name);
  }
  if(document.getElementById('sankey-view').classList.contains('active')) renderSankey();
  if(document.getElementById('pricing-view').classList.contains('active')) renderPricing();
  if(document.getElementById('trade-view').classList.contains('active')) renderTradeView();
}
function toggleTheme(){setTheme(getTheme()==='dark'?'light':'dark')}
if(localStorage.getItem('theme'))setTheme(localStorage.getItem('theme'));else setTheme('dark');

const COLORS=['#3b82f6','#06b6d4','#8b5cf6','#f59e0b','#ec4899','#22c55e','#6366f1','#14b8a6','#f97316','#d946ef','#84cc16','#ef4444'];
const MINERALS = {
  Lithium:{importReliance:25,importLabel:'>25%',chinaRefining:65,topProcessor:'China (65%)',mining:[['Australia',47],['Chile',25],['China',15],['Argentina',6],['Brazil',3],['Other',4]],refining:[['China',65],['Chile',20],['Argentina',5],['Other',10]],uses:[['EV Batteries',74],['Portable Electronics',9],['Grid Storage',7],['Ceramics/Glass',4],['Lubricants',3],['Other',3]],companies:[['Albemarle','US'],['SQM','Chile'],['Pilbara Minerals','AU'],['Ganfeng Lithium','CN'],['Tianqi Lithium','CN'],['Arcadium','US'],['Mineral Resources','AU']]},
  Cobalt:{importReliance:76,importLabel:'76%',chinaRefining:74,topProcessor:'China (74%)',mining:[['DRC',73],['Indonesia',5],['Russia',4],['Australia',3],['Philippines',3],['Canada',2],['Other',10]],refining:[['China',74],['Finland',10],['Belgium',5],['Canada',3],['Other',8]],uses:[['EV Batteries',40],['Portable Electronics',30],['Aerospace Superalloys',15],['Catalysts',5],['Cutting Tools',5],['Other',5]],companies:[['Glencore','CH'],['CMOC','CN'],['Barrick Gold','CA'],['Huayou Cobalt','CN'],['Umicore','BE']]},
  Nickel:{importReliance:56,importLabel:'56%',chinaRefining:35,topProcessor:'China (35%)',mining:[['Indonesia',55],['Philippines',10],['Russia',6],['New Caledonia',5],['Australia',4],['Canada',4],['China',3],['Other',13]],refining:[['China',35],['Indonesia',25],['Japan',8],['Russia',5],['Finland',4],['Australia',3],['Other',20]],uses:[['Stainless Steel',65],['EV Batteries',15],['Alloys/Superalloys',8],['Plating',6],['Other',6]],companies:[['Vale','BR'],['Norilsk Nickel','RU'],['BHP','AU'],['Glencore','CH'],['Tsingshan','CN']]},
  'Rare Earths':{importReliance:95,importLabel:'>95%',chinaRefining:90,topProcessor:'China (90%)',mining:[['China',70],['Myanmar',10],['Australia',6],['USA',4],['India',2],['Thailand',2],['Other',6]],refining:[['China',90],['Malaysia',5],['Estonia/Japan',3],['Other',2]],uses:[['Permanent Magnets',38],['Catalysts',23],['Polishing',12],['Glass',8],['Metallurgy',8],['Ceramics',5],['Other',6]],companies:[['Northern Rare Earths','CN'],['China Southern RE','CN'],['MP Materials','US'],['Lynas Rare Earths','AU'],['Iluka Resources','AU']]},
  Copper:{importReliance:45,importLabel:'45%',chinaRefining:42,topProcessor:'China (42%)',mining:[['Chile',24],['DRC',12],['Peru',10],['China',8],['USA',5],['Indonesia',5],['Australia',4],['Russia',4],['Other',28]],refining:[['China',42],['Chile',9],['Japan',7],['DRC',5],['India',4],['Russia',3],['USA',3],['Other',27]],uses:[['Electrical/Power',65],['Construction',15],['Transportation',7],['Industrial',7],['Consumer',6]],companies:[['Codelco','Chile'],['Freeport-McMoRan','US'],['BHP','AU'],['Southern Copper','MX'],['Glencore','CH'],['Ivanhoe Mines','CA']]},
  Graphite:{importReliance:100,importLabel:'100%',chinaRefining:90,topProcessor:'China (90%+)',mining:[['China',65],['Mozambique',11],['Brazil',7],['Madagascar',5],['India',3],['Other',9]],refining:[['China',90],['Japan',4],['Other',6]],uses:[['EV Battery Anodes',55],['Steelmaking',20],['Foundries',8],['Lubricants',5],['Brake Linings',5],['Other',7]],companies:[['BTR New Material','CN'],['Showa Denko','JP'],['Syrah Resources','AU'],['Northern Graphite','CA'],['Nouveau Monde','CA']]},
  Manganese:{importReliance:100,importLabel:'100%',chinaRefining:93,topProcessor:'China (93%)',mining:[['South Africa',37],['Gabon',18],['Australia',15],['China',6],['Ghana',5],['Brazil',4],['India',4],['Other',11]],refining:[['China',93],['Other',7]],uses:[['Steelmaking',90],['EV Batteries',5],['Aluminum Alloys',3],['Other',2]],companies:[['South32','AU'],['Eramet','FR'],['MOIL','India'],['Assmang','SA'],['Jupiter Mines','AU']]},
  Gallium:{importReliance:100,importLabel:'100%',chinaRefining:98,topProcessor:'China (98%)',mining:[['China',98],['Japan',1],['Russia',0.5],['Other',0.5]],refining:[['China',98],['Japan',1],['Other',1]],uses:[['Semiconductors (GaAs)',70],['LEDs/Optoelectronics',20],['Solar (Space/Military)',5],['Research',5]],companies:[['Chinalco','CN'],['CMC','CN'],['AXT Inc','US'],['Freiberger','DE'],['Coherent','US']]},
  Germanium:{importReliance:50,importLabel:'>50%',chinaRefining:60,topProcessor:'China (60%)',mining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],refining:[['China',60],['Belgium',15],['Canada',10],['Russia',5],['USA',5],['Other',5]],uses:[['Fiber Optics',35],['IR Optics/Night Vision',25],['Solar Cells',15],['Catalysts',10],['Other',15]],companies:[['Yunnan Germanium','CN'],['Umicore','BE'],['Teck Resources','CA']]},
  Tungsten:{importReliance:50,importLabel:'50%',chinaRefining:82,topProcessor:'China (82%)',mining:[['China',82],['Vietnam',5],['Russia',3],['Bolivia',2],['Rwanda',2],['Other',6]],refining:[['China',82],['Austria',4],['Other',14]],uses:[['Cutting Tools/Carbide',55],['Mill Products',20],['Steels/Alloys',15],['Chemicals',10]],companies:[['China Minmetals','CN'],['Xiamen Tungsten','CN'],['Wolfram Bergbau','AT'],['Kennametal','US'],['Sandvik','SE']]},
  Vanadium:{importReliance:72,importLabel:'72%',chinaRefining:66,topProcessor:'China (66%)',mining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],refining:[['China',66],['Russia',18],['South Africa',8],['Brazil',6],['Other',2]],uses:[['Steel Alloys',90],['Flow Batteries (VRFB)',5],['Titanium Alloys',3],['Chemicals',2]],companies:[['Pangang Group','CN'],['Evraz','RU'],['Bushveld Minerals','SA'],['Largo Inc','BR/CA']]},
  'Platinum Group':{importReliance:77,importLabel:'77%',chinaRefining:8,topProcessor:'South Africa (45%)',mining:[['South Africa',72],['Russia',10],['Zimbabwe',8],['Canada',5],['USA',2],['Other',3]],refining:[['South Africa',45],['Russia',25],['UK',10],['Japan',8],['USA',5],['Other',7]],uses:[['Autocatalysts',40],['Jewelry',25],['Hydrogen/Fuel Cells',15],['Chemical Catalysts',10],['Electronics',5],['Other',5]],companies:[['Anglo American Platinum','SA'],['Impala Platinum','SA'],['Sibanye-Stillwater','SA/US'],['Norilsk Nickel','RU']]},
  Uranium:{importReliance:90,importLabel:'>90%',chinaRefining:12,topProcessor:'Russia (38%)',mining:[['Kazakhstan',43],['Canada',15],['Namibia',11],['Australia',8],['Uzbekistan',7],['Russia',5],['Niger',4],['Other',7]],refining:[['Russia',38],['Urenco (EU)',30],['Orano (France)',15],['China',12],['USA',5]],uses:[['Nuclear Power',93],['Medical Isotopes',3],['Defense/Naval',3],['Research',1]],companies:[['Kazatomprom','KZ'],['Cameco','CA'],['Orano','FR'],['Energy Fuels','US'],['Centrus Energy','US']]},
  Silicon:{importReliance:33,importLabel:'33%',chinaRefining:80,topProcessor:'China (80%)',mining:[['China',71],['Russia',6],['Brazil',5],['Norway',5],['USA',3],['France',2],['Other',8]],refining:[['China',80],['Germany',5],['South Korea',5],['Norway',3],['Other',7]],uses:[['Aluminum Alloys',45],['Silicones/Chemicals',30],['Solar Polysilicon',15],['Semiconductors',5],['Other',5]],companies:[['Tongwei','CN'],['GCL-Poly','CN'],['Daqo New Energy','CN'],['Wacker Chemie','DE'],['REC Silicon','NO/US']]}
};

// Mineral color map for Sankey
const MINERAL_COLORS = {
  Lithium:'#3b82f6',Cobalt:'#8b5cf6',Nickel:'#06b6d4','Rare Earths':'#ec4899',
  Copper:'#f59e0b',Graphite:'#22c55e',Gallium:'#6366f1',Germanium:'#14b8a6',
  Tungsten:'#f97316'
};
const SANKEY_MINERALS = ['Lithium','Cobalt','Nickel','Rare Earths','Copper','Graphite','Gallium','Germanium','Tungsten'];

function riskLevel(r){return r>=75?'high':r>=40?'med':'low'}

let charts={};
function destroyCharts(){Object.values(charts).forEach(c=>{try{c.destroy()}catch(e){}});charts={}}

function chartColors(){
  const dark=getTheme()==='dark';
  return{
    grid:dark?'#1e1e22':'#f0f0f2',
    tick:dark?'#71717a':'#a1a1aa',
    label:dark?'#fafafa':'#09090b',
    legendText:dark?'#a1a1aa':'#52525b'
  };
}

// ══════════════════════════════════════════════════════════════
// TRADE FLOW DATA — Embedded realistic data based on USGS/Comtrade
// API INTEGRATION POINT: Replace TRADE_DATA with live UN Comtrade API calls
// Endpoint: https://comtradeapi.un.org/data/v1/get/C/A/HS
// ══════════════════════════════════════════════════════════════
const TRADE_DATA = {
  Lithium: {
    hsCode: '2836.91 / 2825.20',
    unit: 'Lithium Carbonate Equivalent (LCE)',
    globalTrade: 245000, // tonnes LCE
    exporters: [
      {country:'Chile', volume:92000, value:5520, yoy:8.2},
      {country:'Australia', volume:68000, value:4080, yoy:12.5},
      {country:'China', volume:35000, value:2100, yoy:-3.1},
      {country:'Argentina', volume:28000, value:1680, yoy:22.4},
      {country:'USA', volume:5000, value:300, yoy:15.0},
    ],
    importers: [
      {country:'China', volume:115000, value:6900, yoy:6.8},
      {country:'South Korea', volume:38000, value:2280, yoy:11.2},
      {country:'Japan', volume:28000, value:1680, yoy:4.5},
      {country:'USA', volume:18000, value:1080, yoy:9.3},
      {country:'EU', volume:15000, value:900, yoy:18.7},
    ],
    usImports: [
      {country:'Chile', pct:55},
      {country:'Argentina', pct:22},
      {country:'China', pct:12},
      {country:'Australia', pct:8},
      {country:'Other', pct:3},
    ],
    // Bilateral flows for chord: [from, to, value in $M]
    flows: [
      ['Australia','China',3200],['Australia','South Korea',520],['Australia','Japan',360],
      ['Chile','China',1800],['Chile','South Korea',1100],['Chile','Japan',900],['Chile','USA',850],
      ['Argentina','China',600],['Argentina','USA',380],['China','South Korea',450],['China','Japan',320],
    ]
  },
  Cobalt: {
    hsCode: '2605.00 / 8105.20',
    unit: 'Tonnes (metal content)',
    globalTrade: 180000,
    exporters: [
      {country:'DRC', volume:130000, value:5200, yoy:4.2},
      {country:'Indonesia', volume:12000, value:480, yoy:45.0},
      {country:'Russia', volume:6500, value:260, yoy:-8.5},
      {country:'Australia', volume:5800, value:232, yoy:2.1},
      {country:'Philippines', volume:4800, value:192, yoy:6.3},
    ],
    importers: [
      {country:'China', volume:120000, value:4800, yoy:7.5},
      {country:'Finland', volume:15000, value:600, yoy:3.2},
      {country:'Belgium', volume:10000, value:400, yoy:-2.1},
      {country:'Japan', volume:8000, value:320, yoy:1.8},
      {country:'USA', volume:6500, value:260, yoy:5.4},
    ],
    usImports: [
      {country:'Norway', pct:24},
      {country:'Canada', pct:19},
      {country:'Japan', pct:17},
      {country:'Finland', pct:14},
      {country:'China', pct:12},
      {country:'Other', pct:14},
    ],
    flows: [
      ['DRC','China',3800],['DRC','Finland',450],['DRC','Belgium',320],
      ['Indonesia','China',380],['Russia','Finland',120],['Russia','China',100],
      ['Australia','China',180],['Philippines','China',150],['DRC','Japan',200],
    ]
  },
  Nickel: {
    hsCode: '2604.00 / 7502.10',
    unit: 'Tonnes (metal content)',
    globalTrade: 3200000,
    exporters: [
      {country:'Indonesia', volume:1650000, value:28000, yoy:18.5},
      {country:'Philippines', volume:380000, value:4200, yoy:5.2},
      {country:'Russia', volume:195000, value:5100, yoy:-12.3},
      {country:'New Caledonia', volume:160000, value:2800, yoy:-6.1},
      {country:'Australia', volume:145000, value:3200, yoy:3.8},
    ],
    importers: [
      {country:'China', volume:1450000, value:22000, yoy:14.2},
      {country:'Japan', volume:280000, value:5600, yoy:-1.5},
      {country:'EU', volume:320000, value:6400, yoy:4.8},
      {country:'South Korea', volume:185000, value:3700, yoy:7.2},
      {country:'USA', volume:120000, value:2400, yoy:6.1},
    ],
    usImports: [
      {country:'Canada', pct:42},
      {country:'Australia', pct:15},
      {country:'Norway', pct:10},
      {country:'Finland', pct:9},
      {country:'Russia', pct:6},
      {country:'Other', pct:18},
    ],
    flows: [
      ['Indonesia','China',18000],['Indonesia','Japan',3200],['Indonesia','South Korea',2800],
      ['Philippines','China',2800],['Philippines','Japan',1200],['Russia','EU',2400],
      ['Russia','China',1500],['Australia','Japan',800],['New Caledonia','EU',1800],
      ['Canada','USA',1400],['Australia','USA',520],
    ]
  },
  'Rare Earths': {
    hsCode: '2846.10-90 / 2805.30',
    unit: 'Tonnes REO',
    globalTrade: 125000,
    exporters: [
      {country:'China', volume:72000, value:5400, yoy:-4.2},
      {country:'Myanmar', volume:18000, value:900, yoy:15.3},
      {country:'Australia', volume:12000, value:960, yoy:8.7},
      {country:'USA', volume:8000, value:640, yoy:25.0},
      {country:'Malaysia', volume:4500, value:360, yoy:12.1},
    ],
    importers: [
      {country:'Japan', volume:32000, value:2560, yoy:2.1},
      {country:'USA', volume:18000, value:1440, yoy:8.5},
      {country:'EU', volume:15000, value:1200, yoy:14.3},
      {country:'South Korea', volume:12000, value:960, yoy:6.8},
      {country:'India', volume:5000, value:400, yoy:22.0},
    ],
    usImports: [
      {country:'China', pct:72},
      {country:'Estonia', pct:8},
      {country:'Japan', pct:7},
      {country:'Malaysia', pct:6},
      {country:'Australia', pct:4},
      {country:'Other', pct:3},
    ],
    flows: [
      ['China','Japan',2200],['China','USA',1200],['China','EU',800],['China','South Korea',680],
      ['China','India',320],['Myanmar','China',750],['Australia','Japan',280],
      ['Australia','EU',200],['USA','Japan',180],['Malaysia','Japan',150],
    ]
  },
  Copper: {
    hsCode: '2603.00 / 7403.11',
    unit: 'Tonnes',
    globalTrade: 25000000,
    exporters: [
      {country:'Chile', volume:5800000, value:52200, yoy:2.1},
      {country:'Peru', volume:2400000, value:21600, yoy:-3.5},
      {country:'DRC', volume:2800000, value:25200, yoy:22.0},
      {country:'Australia', volume:950000, value:8550, yoy:5.8},
      {country:'Indonesia', volume:1200000, value:10800, yoy:8.3},
    ],
    importers: [
      {country:'China', volume:12500000, value:112500, yoy:6.2},
      {country:'Japan', volume:1400000, value:12600, yoy:-2.1},
      {country:'EU', volume:2800000, value:25200, yoy:3.5},
      {country:'South Korea', volume:950000, value:8550, yoy:4.8},
      {country:'USA', volume:850000, value:7650, yoy:5.1},
    ],
    usImports: [
      {country:'Chile', pct:35},
      {country:'Canada', pct:28},
      {country:'Mexico', pct:15},
      {country:'Peru', pct:10},
      {country:'Other', pct:12},
    ],
    flows: [
      ['Chile','China',28000],['Chile','Japan',5200],['Chile','South Korea',4800],['Chile','USA',3800],
      ['Peru','China',12000],['Peru','USA',2200],['DRC','China',18000],
      ['Australia','China',5500],['Australia','Japan',2200],['Indonesia','China',8500],
      ['Canada','USA',3200],['Mexico','USA',1600],
    ]
  },
  Graphite: {
    hsCode: '2504.10-90',
    unit: 'Tonnes',
    globalTrade: 1600000,
    exporters: [
      {country:'China', volume:680000, value:1360, yoy:-2.5},
      {country:'Mozambique', volume:180000, value:360, yoy:35.0},
      {country:'Brazil', volume:115000, value:230, yoy:4.2},
      {country:'Madagascar', volume:75000, value:150, yoy:8.1},
      {country:'India', volume:50000, value:100, yoy:6.3},
    ],
    importers: [
      {country:'Japan', volume:180000, value:360, yoy:3.5},
      {country:'South Korea', volume:145000, value:290, yoy:12.1},
      {country:'EU', volume:165000, value:330, yoy:8.4},
      {country:'USA', volume:95000, value:190, yoy:15.2},
      {country:'India', volume:85000, value:170, yoy:10.5},
    ],
    usImports: [
      {country:'China', pct:33},
      {country:'Mexico', pct:22},
      {country:'Canada', pct:15},
      {country:'Madagascar', pct:12},
      {country:'Mozambique', pct:8},
      {country:'Other', pct:10},
    ],
    flows: [
      ['China','Japan',250],['China','South Korea',200],['China','EU',180],['China','USA',120],
      ['Mozambique','EU',80],['Mozambique','China',60],['Brazil','EU',45],['Brazil','USA',35],
      ['Madagascar','USA',28],['Madagascar','EU',22],
    ]
  },
  Gallium: {
    hsCode: '8112.92',
    unit: 'Tonnes',
    globalTrade: 600,
    exporters: [
      {country:'China', volume:480, value:288, yoy:-15.0},
      {country:'Japan', volume:30, value:18, yoy:5.2},
      {country:'South Korea', volume:22, value:13.2, yoy:8.0},
      {country:'Russia', volume:12, value:7.2, yoy:-22.0},
      {country:'Germany', volume:8, value:4.8, yoy:12.0},
    ],
    importers: [
      {country:'Japan', volume:120, value:72, yoy:-8.5},
      {country:'USA', volume:65, value:39, yoy:-12.0},
      {country:'EU', volume:85, value:51, yoy:-5.2},
      {country:'South Korea', volume:55, value:33, yoy:2.1},
      {country:'Taiwan', volume:45, value:27, yoy:-3.8},
    ],
    usImports: [
      {country:'China', pct:53},
      {country:'UK', pct:14},
      {country:'Germany', pct:12},
      {country:'Japan', pct:11},
      {country:'Other', pct:10},
    ],
    flows: [
      ['China','Japan',52],['China','USA',28],['China','EU',32],['China','South Korea',25],
      ['China','Taiwan',20],['Japan','USA',8],['Germany','USA',5],
    ]
  },
  Germanium: {
    hsCode: '8112.92',
    unit: 'Tonnes',
    globalTrade: 180,
    exporters: [
      {country:'China', volume:95, value:142, yoy:-18.0},
      {country:'Belgium', volume:25, value:37.5, yoy:4.5},
      {country:'Canada', volume:18, value:27, yoy:6.2},
      {country:'Russia', volume:8, value:12, yoy:-25.0},
      {country:'USA', volume:6, value:9, yoy:10.0},
    ],
    importers: [
      {country:'USA', volume:35, value:52.5, yoy:-8.0},
      {country:'Japan', volume:30, value:45, yoy:2.5},
      {country:'EU', volume:28, value:42, yoy:5.8},
      {country:'South Korea', volume:15, value:22.5, yoy:12.0},
      {country:'Taiwan', volume:12, value:18, yoy:4.3},
    ],
    usImports: [
      {country:'China', pct:42},
      {country:'Belgium', pct:22},
      {country:'Germany', pct:13},
      {country:'Russia', pct:8},
      {country:'Other', pct:15},
    ],
    flows: [
      ['China','Japan',28],['China','USA',22],['China','EU',18],['China','South Korea',12],
      ['Belgium','USA',10],['Belgium','EU',8],['Canada','USA',7],
    ]
  },
  Tungsten: {
    hsCode: '2611.00',
    unit: 'Tonnes (W content)',
    globalTrade: 95000,
    exporters: [
      {country:'China', volume:62000, value:1860, yoy:-3.8},
      {country:'Vietnam', volume:6200, value:186, yoy:12.5},
      {country:'Russia', volume:3200, value:96, yoy:-15.0},
      {country:'Bolivia', volume:2100, value:63, yoy:8.2},
      {country:'Rwanda', volume:1800, value:54, yoy:18.0},
    ],
    importers: [
      {country:'Japan', volume:8500, value:255, yoy:2.8},
      {country:'USA', volume:7200, value:216, yoy:4.5},
      {country:'EU', volume:12000, value:360, yoy:3.2},
      {country:'South Korea', volume:5500, value:165, yoy:6.8},
      {country:'India', volume:3200, value:96, yoy:15.0},
    ],
    usImports: [
      {country:'China', pct:32},
      {country:'Germany', pct:18},
      {country:'Bolivia', pct:15},
      {country:'Canada', pct:12},
      {country:'Other', pct:23},
    ],
    flows: [
      ['China','Japan',180],['China','USA',95],['China','EU',220],['China','South Korea',110],
      ['China','India',65],['Vietnam','Japan',45],['Vietnam','EU',38],
      ['Russia','EU',55],['Bolivia','USA',35],['Rwanda','EU',22],
    ]
  }
};

// ══════════════════════════════════════════════════════════════
// PRICING DATA — Based on World Bank Commodity Price Data (Pink Sheet)
// API INTEGRATION POINT: Replace with World Bank / FRED API calls
// World Bank: https://thedocs.worldbank.org/en/doc/.../CMO-Historical-Data-Monthly.xlsx
// FRED: https://api.stlouisfed.org/fred/series/observations
// ══════════════════════════════════════════════════════════════
const PRICING_DATA = {
  'Lithium Carbonate': {
    unit: '$/tonne',
    current: 10800,
    yoyChange: -28.5,
    // Monthly data Jan 2021 – Jan 2026 (approx. based on real market data)
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [8500,9200,12500,28000,38000,52000,68000,82000,72000,42000,28000,18000,15200,13800,12500,11800,15100,14200,12800,11200,10800],
    color: '#3b82f6'
  },
  'Cobalt': {
    unit: '$/tonne',
    current: 24200,
    yoyChange: -18.2,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [36500,42000,52000,56000,72000,82000,55000,52000,35000,33500,32000,30000,28500,27200,29500,26800,29600,28000,26200,25100,24200],
    color: '#8b5cf6'
  },
  'Nickel': {
    unit: '$/tonne',
    current: 15400,
    yoyChange: -8.3,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [18200,17800,19200,20500,22800,33000,22000,23500,28500,24000,21500,18200,16500,18200,17000,15800,16800,16200,15800,15600,15400],
    color: '#06b6d4'
  },
  'Copper': {
    unit: '$/tonne',
    current: 9250,
    yoyChange: 5.7,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [7950,9200,9400,9600,9800,10200,7600,7700,9100,8800,8500,8000,8400,9800,9500,9600,8750,9100,9400,9100,9250],
    color: '#f59e0b'
  },
  'Rare Earths (NdPr Oxide)': {
    unit: '$/kg',
    current: 52,
    yoyChange: -12.4,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [55,70,85,120,140,120,90,75,72,68,55,50,62,68,58,55,59.4,58,55,53,52],
    color: '#ec4899'
  },
  'Tungsten (APT)': {
    unit: '$/mtu',
    current: 325,
    yoyChange: 8.3,
    labels: ['Jan 21','Apr 21','Jul 21','Oct 21','Jan 22','Apr 22','Jul 22','Oct 22','Jan 23','Apr 23','Jul 23','Oct 23','Jan 24','Apr 24','Jul 24','Oct 24','Jan 25','Apr 25','Jul 25','Oct 25','Jan 26'],
    prices: [275,280,290,295,310,325,300,295,280,285,295,290,285,295,310,320,300,310,320,318,325],
    color: '#f97316'
  }
};

// Pills — with section pills
const pillsEl=document.getElementById('pills');
const sections=[
  {id:'overview',label:'Overview',fn:showOverview},
  {id:'sankey',label:'Supply Chain Flow',fn:showSankey},
  {id:'trade',label:'Trade Flows',fn:showTrade},
  {id:'pricing',label:'Pricing',fn:showPricingView},
];
sections.forEach(s=>{
  const p=document.createElement('div');
  p.className='pill section-pill'+(s.id==='overview'?' active':'');
  p.textContent=s.label;
  p.dataset.section=s.id;
  p.onclick=s.fn;
  pillsEl.appendChild(p);
});

const sep=document.createElement('div');
sep.className='pill-separator';
pillsEl.appendChild(sep);

Object.keys(MINERALS).forEach(m=>{
  const p=document.createElement('div');p.className='pill';p.textContent=m;
  p.onclick=()=>showMineral(m);pillsEl.appendChild(p);
});

// Populate trade mineral selector
const tradeSelect=document.getElementById('trade-mineral-select');
Object.keys(TRADE_DATA).forEach(m=>{
  const o=document.createElement('option');o.value=m;o.textContent=m;
  tradeSelect.appendChild(o);
});

// Overview grid
const gridEl=document.getElementById('overview-grid');
Object.entries(MINERALS).forEach(([name,d])=>{
  const risk=riskLevel(d.importReliance);
  const card=document.createElement('div');
  card.className='mineral-card';
  card.onclick=()=>showMineral(name);
  card.innerHTML=`
    <div class="mc-top">
      <div class="mc-name">${name}</div>
      <span class="mc-badge ${risk}">${risk==='high'?'High Risk':risk==='med'?'Moderate':'Lower'}</span>
    </div>
    <div class="mc-import ${risk}">${d.importLabel}</div>
    <div class="mc-sublabel">U.S. Net Import Reliance</div>
    <div class="mc-row"><span class="mc-label">Top Processor</span><span class="mc-val">${d.topProcessor}</span></div>
    <div class="mc-row"><span class="mc-label">China Refining</span><span class="mc-val">${d.chinaRefining}%</span></div>
  `;
  gridEl.appendChild(card);
});

function setActivePill(name){
  document.querySelectorAll('.pill').forEach(p=>{
    const sec=p.dataset.section;
    if(sec){
      const match=sections.find(s=>s.id===sec);
      p.classList.toggle('active',match&&match.label===name);
    } else {
      p.classList.toggle('active',p.textContent===name);
    }
  });
}

function hideAllViews(){
  document.getElementById('overview').style.display='none';
  document.getElementById('detail').classList.remove('active');
  document.getElementById('sankey-view').classList.remove('active');
  document.getElementById('trade-view').classList.remove('active');
  document.getElementById('pricing-view').classList.remove('active');
  destroyCharts();
}

function showOverview(){
  hideAllViews();
  setActivePill('Overview');
  document.getElementById('overview').style.display='';
}

function showSankey(){
  hideAllViews();
  setActivePill('Supply Chain Flow');
  document.getElementById('sankey-view').classList.add('active');
  renderSankey();
}

function showTrade(){
  hideAllViews();
  setActivePill('Trade Flows');
  document.getElementById('trade-view').classList.add('active');
  renderTradeView();
}

function showPricingView(){
  hideAllViews();
  setActivePill('Pricing');
  document.getElementById('pricing-view').classList.add('active');
  renderPricing();
}

function showMineral(name){
  hideAllViews();
  setActivePill(name);
  const d=MINERALS[name];
  document.getElementById('detail').classList.add('active');
  document.getElementById('detail-title').textContent=name;

  const risk=riskLevel(d.importReliance);
  const gaugeColor=risk==='high'?'var(--red)':risk==='med'?'var(--orange)':'var(--green)';
  const pct=d.importReliance;

  document.getElementById('stats-row').innerHTML=`
    <div class="stat-card">
      <div class="stat-label">Import Reliance</div>
      <div class="stat-value" style="color:${gaugeColor}">${d.importLabel}</div>
      <div style="margin-top:.75rem">
        <div class="gauge-bar-track"><div class="gauge-bar-fill" style="width:${pct}%;background:${gaugeColor}"></div></div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-label">China Refining</div>
      <div class="stat-value" style="color:${d.chinaRefining>=70?'var(--red)':d.chinaRefining>=40?'var(--orange)':'var(--green)'}">${d.chinaRefining}%</div>
      <div class="stat-sub">of global processing</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Top Processor</div>
      <div class="stat-value" style="font-size:1.25rem;margin-top:.25rem">${d.topProcessor.split(' (')[0]}</div>
      <div class="stat-sub">${d.topProcessor}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Risk Level</div>
      <div class="stat-value" style="color:${gaugeColor}">${risk==='high'?'HIGH':risk==='med'?'MOD.':'LOW'}</div>
      <div class="stat-sub">supply chain vulnerability</div>
    </div>
  `;

  const cc=chartColors();

  charts.mining=new Chart(document.getElementById('miningChart').getContext('2d'),{type:'bar',data:{
    labels:d.mining.map(x=>x[0]),
    datasets:[{data:d.mining.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.mining.length),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} — Mining`,label:c=>`${c.label}: ${c.raw}% of global production`}
  }},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},
    y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.refining=new Chart(document.getElementById('refiningChart').getContext('2d'),{type:'bar',data:{
    labels:d.refining.map(x=>x[0]),
    datasets:[{data:d.refining.map(x=>x[1]),backgroundColor:d.refining.map(x=>x[0]==='China'?'#ef4444':COLORS[1]),borderRadius:4,barThickness:18}]
  },options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} — Refining`,label:c=>`${c.label}: ${c.raw}% of global processing`}
  }},scales:{
    x:{grid:{color:cc.grid},ticks:{color:cc.tick,callback:v=>v+'%'},max:100},
    y:{grid:{display:false},ticks:{color:cc.label,font:{size:12,family:'Geist'}}}
  }}});

  charts.uses=new Chart(document.getElementById('usesChart').getContext('2d'),{type:'doughnut',data:{
    labels:d.uses.map(x=>x[0]),
    datasets:[{data:d.uses.map(x=>x[1]),backgroundColor:COLORS.slice(0,d.uses.length),borderWidth:0,hoverOffset:6}]
  },options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{position:'right',labels:{color:cc.legendText,font:{size:11,family:'Geist'},padding:8,usePointStyle:true,pointStyleWidth:8}},tooltip:{
    backgroundColor:getTheme()==='dark'?'#131316':'#ffffff',
    titleColor:getTheme()==='dark'?'#fafafa':'#09090b',
    bodyColor:getTheme()==='dark'?'#a1a1aa':'#52525b',
    borderColor:getTheme()==='dark'?'#27272a':'#e4e4e7',
    borderWidth:1,
    titleFont:{family:'Geist',weight:'600'},
    bodyFont:{family:'Geist Mono'},
    padding:10,cornerRadius:8,
    callbacks:{title:c=>`${name} — End Uses`,label:c=>`${c.label}: ${c.raw}%`}
  }}}});

  document.getElementById('company-list').innerHTML=d.companies.map(([n,c])=>`<div class="company-tag">${n}<span class="co-country">${c}</span></div>`).join('');
}

// ── TRADE FLOWS RENDERING ──
function renderTradeView(){
  destroyCharts();
  const mineral=document.getElementById('trade-mineral-select').value;
  const d=TRADE_DATA[mineral];
  if(!d) return;

  const content=document.getElementById('trade-content');
  const fmtNum=n=>n>=1000?n.toLocaleString():n;
  const fmtVal=v=>v>=1000?'$'+v.toLocaleString()+'M':'$'+v+'M';
  const chgHtml=v=>`<span class="${v>=0?'change-pos':'change-neg'}">${v>=0?'▲':'▼'} ${Math.abs(v)}%</span>`;

  let html=`
    <div style="margin-bottom:.75rem;font-size:.75rem;color:var(--text-muted);font-family:var(--font-mono)">
      HS Code: ${d.hsCode} · Unit: ${d.unit} · Global trade volume: ~${fmtNum(d.globalTrade)} tonnes
    </div>

    <div class="trade-tables-grid">
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Exporters</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.exporters.map(e=>`<tr><td>${e.country}</td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
      </div>
      <div class="data-table-wrap">
        <table class="data-table">
          <thead><tr><th colspan="4" style="font-size:.8125rem;font-weight:600;color:var(--text);text-transform:none;letter-spacing:0">Top Importers</th></tr>
          <tr><th>Country</th><th class="num">Volume</th><th class="num">Value</th><th class="num">YoY</th></tr></thead>
          <tbody>${d.importers.map(e=>`<tr><td>${e.country}</td><td class="num">${fmtNum(e.volume)}</td><td class="num">${fmtVal(e.value)}</td><td class="num">${chgHtml(e.yoy)}</td></tr>`).join('')}</tbody>
        </table>
      </div>
    </div>

    <div class="us-import-card">
      <h3>U.S. Import Sources — ${mineral}</h3>
      ${d.usImports.map(u=>`
        <div class="us-bar">
          <span class="us-bar-country">${u.country}</span>
          <div class="us-bar-track"><div class="us-bar-fill" style="width:${u.pct}%;background:${u.country==='China'?'var(--red)':'var(--accent)'}"></div></div>
          <span class="us-bar-pct">${u.pct}%</span>
        </div>
      `).join('')}
    </div>

    <div class="chord-container">
      <h3>Bilateral Trade Flows ($M)</h3>
      <div id="trade-chord"></div>
    </div>
  `;
  content.innerHTML=html;
  renderTradeChord(d.flows, mineral);
}

function renderTradeChord(flows, mineral){
  const container=document.getElementById('trade-chord');
  container.innerHTML='';
  const dark=getTheme()==='dark';
  const w=container.clientWidth||800;
  const h=Math.min(450,w*0.55);

  // Build a simple force-directed flow diagram instead of chord (more readable)
  // Collect unique countries
  const countries=new Set();
  flows.forEach(([f,t])=>{countries.add(f);countries.add(t);});
  const countryList=[...countries];

  const svg=d3.select(container).append('svg').attr('width',w).attr('height',h);

  // Simple node-link diagram
  const nodes=countryList.map((c,i)=>({id:c,name:c}));
  const links=flows.map(([s,t,v])=>({source:s,target:t,value:v}));

  const maxVal=d3.max(links,d=>d.value);

  const sim=d3.forceSimulation(nodes)
    .force('link',d3.forceLink(links).id(d=>d.id).distance(120))
    .force('charge',d3.forceManyBody().strength(-400))
    .force('center',d3.forceCenter(w/2,h/2))
    .force('collision',d3.forceCollide(40));

  const link=svg.append('g').selectAll('line')
    .data(links).join('line')
    .attr('stroke',dark?'rgba(59,130,246,.4)':'rgba(37,99,235,.3)')
    .attr('stroke-width',d=>Math.max(1,Math.sqrt(d.value/maxVal)*12));

  const node=svg.append('g').selectAll('g')
    .data(nodes).join('g')
    .call(d3.drag().on('start',(e,d)=>{if(!e.active)sim.alphaTarget(.3).restart();d.fx=e.x;d.fy=e.y})
      .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y})
      .on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));

  node.append('circle').attr('r',8)
    .attr('fill',d=>d.name==='China'?(dark?'#ef4444':'#dc2626'):(d.name==='USA'?(dark?'#3b82f6':'#2563eb'):(dark?'#a1a1aa':'#52525b')))
    .attr('stroke',dark?'#27272a':'#e4e4e7').attr('stroke-width',1.5);

  node.append('text')
    .text(d=>d.name)
    .attr('x',12).attr('y',4)
    .attr('fill',dark?'#fafafa':'#09090b')
    .attr('font-size','11px').attr('font-family','Geist, sans-serif');

  // Value labels on links
  const linkLabel=svg.append('g').selectAll('text')
    .data(links).join('text')
    .text(d=>'$'+d.value.toLocaleString()+'M')
    .attr('fill',dark?'#71717a':'#a1a1aa')
    .attr('font-size','9px').attr('font-family','Geist Mono, monospace')
    .attr('text-anchor','middle');

  sim.on('tick',()=>{
    link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y)
        .attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
    node.attr('transform',d=>`translate(${d.x},${d.y})`);
    linkLabel.attr('x',d=>(d.source.x+d.target.x)/2).attr('y',d=>(d.source.y+d.target.y)/2-4);
  });
}

// ── PRICING RENDERING ──
function renderPricing(){
  destroyCharts();
  const grid=document.getElementById('pricing-grid');
  grid.innerHTML='';
  const cc=chartColors();
  const dark=getTheme()==='dark';

  Object.entries(PRICING_DATA).forEach(([name,d],idx)=>{
    const card=document.createElement('div');
    card.className='pricing-card';
    const dir=d.yoyChange>=0?'up':'down';
    const arrow=d.yoyChange>=0?'▲':'▼';
    const fmtPrice=d.current>=1000?'$'+d.current.toLocaleString():d.unit.includes('kg')?'$'+d.current:'$'+d.current;

    card.innerHTML=`
      <div class="pricing-card-header">
        <div class="pricing-card-left">
          <h3>${name}</h3>
          <span class="pricing-unit">${d.unit}</span>
        </div>
        <div class="pricing-current">
          <div class="price-big">${fmtPrice}</div>
          <div class="price-change ${dir}">${arrow} ${Math.abs(d.yoyChange)}% YoY</div>
        </div>
      </div>
      <div class="pricing-chart-wrap"><canvas id="priceChart${idx}"></canvas></div>
    `;
    grid.appendChild(card);

    const ctx=document.getElementById('priceChart'+idx).getContext('2d');
    charts['price'+idx]=new Chart(ctx,{
      type:'line',
      data:{
        labels:d.labels,
        datasets:[{
          data:d.prices,
          borderColor:d.color,
          backgroundColor:d.color+'18',
          fill:true,
          tension:.3,
          pointRadius:0,
          pointHitRadius:8,
          borderWidth:2,
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false},
          tooltip:{
            backgroundColor:dark?'#131316':'#ffffff',
            titleColor:dark?'#fafafa':'#09090b',
            bodyColor:dark?'#a1a1aa':'#52525b',
            borderColor:dark?'#27272a':'#e4e4e7',
            borderWidth:1,
            titleFont:{family:'Geist',weight:'600'},
            bodyFont:{family:'Geist Mono'},
            padding:10,cornerRadius:8,
            callbacks:{
              title:c=>c[0].label,
              label:c=>`${name}: ${d.unit.includes('kg')?'$'+c.raw+'/kg':d.unit.includes('mtu')?'$'+c.raw+'/mtu':'$'+c.raw.toLocaleString()}`
            }
          }
        },
        scales:{
          x:{
            grid:{color:cc.grid},
            ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},maxRotation:0,maxTicksLimit:7}
          },
          y:{
            grid:{color:cc.grid},
            ticks:{color:cc.tick,font:{size:10,family:'Geist Mono'},callback:v=>d.unit.includes('kg')?'$'+v:d.unit.includes('mtu')?'$'+v:'$'+v.toLocaleString()},
            beginAtZero:false
          }
        },
        interaction:{intersect:false,mode:'index'}
      }
    });
  });
}

// ── SANKEY DIAGRAM ──
let sankeyActiveFilter='All';

function mapToSector(use){
  const u=use.toLowerCase();
  if(u.includes('ev batter')||u.includes('battery anode'))return 'EVs / Batteries';
  if(u.includes('grid')||u.includes('flow batter')||u.includes('nuclear')||u.includes('solar')||u.includes('hydrogen')||u.includes('fuel cell'))return 'Grid / Energy';
  if(u.includes('defense')||u.includes('naval')||u.includes('night vision')||u.includes('ir optic')||u.includes('aerospace')||u.includes('cutting tool')||u.includes('carbide')||u.includes('mill product')||u.includes('steels/alloy'))return 'Defense / Industrial';
  if(u.includes('semiconductor')||u.includes('gaas')||u.includes('led')||u.includes('optoelectronic')||u.includes('fiber optic')||u.includes('electronic'))return 'Semiconductors / Electronics';
  if(u.includes('portable')||u.includes('consumer')||u.includes('jewelry')||u.includes('plating'))return 'Consumer Products';
  if(u.includes('steel')||u.includes('aluminum')||u.includes('alloy')||u.includes('construction')||u.includes('foundri')||u.includes('industrial')||u.includes('transport'))return 'Heavy Industry';
  if(u.includes('catalyst')||u.includes('autocat')||u.includes('chemical')||u.includes('ceramic')||u.includes('glass')||u.includes('polish')||u.includes('lubricant')||u.includes('silicone')||u.includes('brake')||u.includes('magnet')||u.includes('metallurgy')||u.includes('research')||u.includes('medical'))return 'Other Industrial';
  return 'Other Industrial';
}

function buildSankeyData(filterMineral){
  const minerals=filterMineral==='All'?SANKEY_MINERALS:[filterMineral];
  const nodeMap={};
  const links=[];
  let nodeId=0;
  function getNode(name){if(!(name in nodeMap)){nodeMap[name]=nodeId++;}return nodeMap[name];}

  minerals.forEach(mName=>{
    const d=MINERALS[mName];
    const color=MINERAL_COLORS[mName];
    const topMining=d.mining.filter(x=>x[0]!=='Other').slice(0,4);
    const topRefining=d.refining.filter(x=>x[0]!=='Other').slice(0,3);
    const sectors={};
    d.uses.forEach(([use,pct])=>{
      const s=mapToSector(use);
      sectors[s]=(sectors[s]||0)+pct;
    });

    topMining.forEach(([country,pct])=>{
      const src='⛏ '+country;
      topRefining.forEach(([rCountry,rPct])=>{
        const tgt='⚙ '+rCountry;
        const val=Math.round(pct*rPct/100*10)/10;
        if(val>0.5){
          links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
        }
      });
    });

    topRefining.forEach(([rCountry,rPct])=>{
      const src='⚙ '+rCountry;
      Object.entries(sectors).forEach(([sector,sPct])=>{
        const tgt='📦 '+sector;
        const val=Math.round(rPct*sPct/100*10)/10;
        if(val>0.5){
          links.push({source:getNode(src),target:getNode(tgt),value:val,mineral:mName,color});
        }
      });
    });
  });

  const nodes=Object.entries(nodeMap).map(([name,id])=>({name,id})).sort((a,b)=>a.id-b.id);
  return{nodes,links};
}

function renderSankey(){
  const container=document.getElementById('sankey-container');
  container.innerHTML='';
  const dark=getTheme()==='dark';
  const w=container.clientWidth-20;
  const h=Math.max(500,Math.min(700,w*0.55));

  const data=buildSankeyData(sankeyActiveFilter);
  if(!data.links.length){container.innerHTML='<p style="color:var(--text-muted);padding:2rem;text-align:center">No flow data for this selection.</p>';return;}

  const svg=d3.select(container).append('svg').attr('width',w).attr('height',h);

  const sankey=d3.sankey()
    .nodeId(d=>d.id)
    .nodeWidth(14)
    .nodePadding(10)
    .nodeAlign(d3.sankeyLeft)
    .extent([[1,1],[w-1,h-6]]);

  const graph=sankey({
    nodes:data.nodes.map(d=>({...d})),
    links:data.links.map(d=>({...d}))
  });

  const tooltip=document.getElementById('sankey-tooltip');
  function showTip(evt,html){
    tooltip.querySelector('.tt-title').innerHTML=html.title||'';
    tooltip.querySelector('.tt-val').innerHTML=html.val||'';
    tooltip.querySelector('.tt-sub').innerHTML=html.sub||'';
    tooltip.style.left=evt.clientX+12+'px';
    tooltip.style.top=evt.clientY-10+'px';
    tooltip.classList.add('visible');
  }
  function hideTip(){tooltip.classList.remove('visible');}

  const link=svg.append('g').attr('fill','none').selectAll('g')
    .data(graph.links).join('g')
    .attr('class','sankey-link');

  link.append('path')
    .attr('d',d3.sankeyLinkHorizontal())
    .attr('stroke',d=>d.color||'#3b82f6')
    .attr('stroke-opacity',.35)
    .attr('stroke-width',d=>Math.max(1,d.width))
    .on('mouseover',function(evt,d){
      d3.select(this).attr('stroke-opacity',.7);
      showTip(evt,{title:d.mineral,val:`${d.source.name} → ${d.target.name}`,sub:`Flow weight: ${d.value}`});
    })
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px';})
    .on('mouseout',function(){d3.select(this).attr('stroke-opacity',.35);hideTip();});

  const node=svg.append('g').selectAll('g')
    .data(graph.nodes).join('g');

  let selectedNode=null;
  node.append('rect')
    .attr('x',d=>d.x0).attr('y',d=>d.y0)
    .attr('height',d=>Math.max(1,d.y1-d.y0))
    .attr('width',sankey.nodeWidth())
    .attr('fill',d=>{
      if(d.name.startsWith('⛏'))return dark?'#a1a1aa':'#52525b';
      if(d.name.startsWith('⚙'))return dark?'#ef4444':'#dc2626';
      return dark?'#3b82f6':'#2563eb';
    })
    .attr('rx',3)
    .attr('cursor','pointer')
    .on('mouseover',function(evt,d){
      showTip(evt,{title:d.name,val:`Total flow: ${Math.round(d.value)}`,sub:`${d.sourceLinks.length} outgoing · ${d.targetLinks.length} incoming`});
    })
    .on('mousemove',function(evt){tooltip.style.left=evt.clientX+12+'px';tooltip.style.top=evt.clientY-10+'px';})
    .on('mouseout',function(){hideTip();})
    .on('click',function(evt,d){
      if(selectedNode===d){
        selectedNode=null;
        svg.selectAll('path').attr('stroke-opacity',.35);
        return;
      }
      selectedNode=d;
      const connectedLinks=new Set();
      d.sourceLinks.forEach(l=>connectedLinks.add(l.index));
      d.targetLinks.forEach(l=>connectedLinks.add(l.index));
      svg.selectAll('.sankey-link path').attr('stroke-opacity',(l,i)=>connectedLinks.has(i)?.7:.08);
    });

  node.append('text')
    .attr('x',d=>d.x0<w/2?d.x1+6:d.x0-6)
    .attr('y',d=>(d.y1+d.y0)/2)
    .attr('dy','0.35em')
    .attr('text-anchor',d=>d.x0<w/2?'start':'end')
    .text(d=>d.name)
    .attr('fill',dark?'#fafafa':'#09090b')
    .attr('font-size','11px')
    .attr('font-family','Geist, sans-serif');

  const legendEl=document.getElementById('sankey-legend');
  legendEl.innerHTML='';
  const shownMinerals=sankeyActiveFilter==='All'?SANKEY_MINERALS:[sankeyActiveFilter];
  shownMinerals.forEach(m=>{
    const s=document.createElement('span');
    s.innerHTML=`<div class="sankey-legend-dot" style="background:${MINERAL_COLORS[m]}"></div>${m}`;
    legendEl.appendChild(s);
  });
}

// Sankey filter pills
(function(){
  const wrap=document.getElementById('sankey-filters');
  const all=document.createElement('button');
  all.className='sankey-filter active';all.textContent='All Minerals';
  all.onclick=()=>{sankeyActiveFilter='All';updateSankeyFilters();renderSankey();};
  wrap.appendChild(all);
  SANKEY_MINERALS.forEach(m=>{
    const b=document.createElement('button');b.className='sankey-filter';b.textContent=m;
    b.onclick=()=>{sankeyActiveFilter=m;updateSankeyFilters();renderSankey();};
    wrap.appendChild(b);
  });
})();
function updateSankeyFilters(){
  document.querySelectorAll('.sankey-filter').forEach(b=>{
    b.classList.toggle('active',
      (sankeyActiveFilter==='All'&&b.textContent==='All Minerals')||b.textContent===sankeyActiveFilter);
  });
}

showOverview();
</script>
</body>
</html>
